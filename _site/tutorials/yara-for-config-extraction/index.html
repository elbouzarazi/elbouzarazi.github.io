<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>YARA for config extraction - Zakariae el bouzarazi</title>
<meta name="description" content="YARA is a tool aimed at helping malware researchers to identify and classify malware samples. It’s considered… ">


  <meta name="author" content="Zakariae El bouzarazi">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Zakariae el bouzarazi">
<meta property="og:title" content="YARA for config extraction">
<meta property="og:url" content="http://localhost:4000/tutorials/yara-for-config-extraction/">


  <meta property="og:description" content="YARA is a tool aimed at helping malware researchers to identify and classify malware samples. It’s considered… ">



  <meta property="og:image" content="http://localhost:4000/assets/images/tutorials/yara/logo.png">





  <meta property="article:published_time" content="2022-08-08T00:00:00+01:00">





  

  


<link rel="canonical" href="http://localhost:4000/tutorials/yara-for-config-extraction/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "zakariae Elbouzarazi",
      "url": "http://localhost:4000/"
    
  }
</script>


  <meta name="google-site-verification" content="J3MnMF94zaZhTUoNtUiRt9cKsr7hiMyTxEdAvQ3GfmY" />





<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Zakariae el bouzarazi Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/site_data/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/site_data/favicon-16x16.png">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/site_data/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          Zakariae el bouzarazi
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/#malware-analysis">Malware Analysis</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#binary-exploitation">Binary Exploitation</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#ctf-writeups">CTF Writeups</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#tutorials">Tutorials</a>
            </li><li class="masthead__menu-item">
              <a href="/categories">All Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/site_data/avatar.jpg" alt="Zakariae El bouzarazi" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Zakariae El bouzarazi</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Malware Analysis &amp; Reverse Engineering Adventures.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="zekuelbouzrazi@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://twitter.com/_n1ghtw0lf" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/zakariae-elbouzarazi-34126b293/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/elbouzarazi" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->

    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="YARA for config extraction">
    <meta itemprop="description" content="YARA is a tool aimed at helping malware researchers to identify and classify malware samples. It’s considered to be the pattern matching swiss knife for malware researchers.">
    <meta itemprop="datePublished" content="2022-08-08T00:00:00+01:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">YARA for config extraction
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  8 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#what-is-a-yara-module">What is a YARA module</a></li>
  <li><a href="#redline-stealer-variant1">RedLine Stealer Variant1</a></li>
  <li><a href="#redline-stealer-variant2">RedLine Stealer Variant2</a></li>
  <li><a href="#writing-our-own-yara-module">Writing our own YARA module</a></li>
  <li><a href="#final-touches">Final Touches</a></li>
  <li><a href="#building-our-module">Building our module</a></li>
  <li><a href="#testing-our-module">Testing our module</a></li>
  <li><a href="#samples">Samples</a></li>
  <li><a href="#references">References</a></li>
</ul>

            </nav>
          </aside>
        
        <p>YARA is a tool aimed at helping malware researchers to identify and classify malware samples. It’s considered to be the pattern matching swiss knife for malware researchers.</p>

<p>If you are not familiar with writing YARA rules, the <a href="https://yara.readthedocs.io/en/stable/index.html">official docs</a> would be a great start.</p>

<p>In this blog I will go through how YARA rules can be used for malware config extraction.</p>

<p>YARA has come a long way since its original release and it now has some awesome modules for writing better and more complex rules.</p>

<h2 id="what-is-a-yara-module">What is a YARA module</h2>

<p>A YARA module is like a plugin for extending YARA features, it allows you to define data structures and functions which can be used in your rules.</p>

<p>To use a YARA module you simply import it using <code class="language-plaintext highlighter-rouge">import "module_name"</code>, you can refer to the docs to learn about the available functions of each module.</p>

<p>Example:</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="dl">"</span><span class="s2">pe</span><span class="dl">"</span>

<span class="nx">rule</span> <span class="nx">test</span> <span class="p">{</span>
    <span class="nl">condition</span><span class="p">:</span>
        <span class="nx">pe</span><span class="p">.</span><span class="nx">number_of_sections</span> <span class="o">==</span> <span class="mi">1</span>
<span class="p">}</span>
</code></pre></div></div>

<p>With that said let’s now jump into malware land, I will demonstrate on two variants of <a href="https://malpedia.caad.fkie.fraunhofer.de/details/win.redline_stealer">RedLine Stealer</a> which is a very popular dotnet stealer.</p>

<h2 id="redline-stealer-variant1">RedLine Stealer Variant1</h2>

<p>The first variant stores the config in plaintext, we are only interested in two fields (C2 and BotnetID).</p>

<p><a href="/assets/images/tutorials/yara/1.png"><img src="/assets/images/tutorials/yara/1.png" alt="1" /></a></p>

<p>To read these fields we need to understand how <a href="https://docs.microsoft.com/en-us/dotnet/api/system.reflection.emit.opcodes.ldstr?view=net-6.0">ldstr</a> instruction works. The instruction’s opcode is <code class="language-plaintext highlighter-rouge">0x72</code> followed by 4 bytes which represent the string token.</p>

<blockquote>
  <p>A token is a DWORD value that represents a table and an index into that table. For example, the EntryPointToken 0x0600002C, references table 0x06 (MethodDef) and its row 0x2C. The table index is 1 byte and the row index is 3 bytes.</p>
</blockquote>

<p>In the following instruction for example, the string token is <code class="language-plaintext highlighter-rouge">0x7000067B</code> (little-endian) and the row index is <code class="language-plaintext highlighter-rouge">0x67B</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>727B060070   // ldstr "87.251.71.4:80"
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">dotnet</code> module already has the functionality to retrieve all user strings from a dotnet sample.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="dl">"</span><span class="s2">dotnet</span><span class="dl">"</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">console</span><span class="dl">"</span>

<span class="nx">rule</span> <span class="nx">Test</span> <span class="p">{</span>
    <span class="nl">condition</span><span class="p">:</span>
        <span class="k">for</span> <span class="nx">all</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">..</span><span class="nx">dotnet</span><span class="p">.</span><span class="nx">number_of_user_strings</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> <span class="p">(</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">dotnet</span><span class="p">.</span><span class="nx">user_strings</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
        <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p><a href="/assets/images/tutorials/yara/2.png"><img src="/assets/images/tutorials/yara/2.png" alt="2" /></a></p>

<blockquote>
  <p>Notice that I used <code class="language-plaintext highlighter-rouge">sed</code> to remove null characters because dotnet user strings are stored as an array of unicode strings.</p>

</blockquote>

<p>This is cool but we need to get the user strings using the row index from the string token.</p>

<p>To achieve this we need to make a couple of changes to the <code class="language-plaintext highlighter-rouge">dotnet</code> module source file at <code class="language-plaintext highlighter-rouge">libyara/modules/dotnet/dotnet.c</code>.</p>

<p><a href="/assets/images/tutorials/yara/3.png"><img src="/assets/images/tutorials/yara/3.png" alt="3" /></a></p>

<p><a href="/assets/images/tutorials/yara/4.png"><img src="/assets/images/tutorials/yara/4.png" alt="4" /></a></p>

<p>This will index the user strings array by row index (offset from the start of the strings table).</p>

<p>To compile and install yara you need to run these two scripts for the first time only:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./bootstrap.sh
$ ./configure
</code></pre></div></div>

<p>Then you build YARA with your changes:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ make
$ sudo make install
</code></pre></div></div>

<p>We can now write a simple rule to read the config fields.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="dl">"</span><span class="s2">dotnet</span><span class="dl">"</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">console</span><span class="dl">"</span>

<span class="nx">rule</span> <span class="nx">Redline</span> <span class="p">{</span>
    <span class="nl">strings</span><span class="p">:</span>
        <span class="nx">$get_conf_v1</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">72</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mi">70</span>      <span class="c1">// IL_0000: ldstr     "87.251.71.4:80"</span>
            <span class="mi">80</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mi">04</span>      <span class="c1">// IL_0005: stsfld    &lt;IP&gt;</span>
            <span class="mi">72</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mi">70</span>      <span class="c1">// IL_000A: ldstr     "lyla"</span>
            <span class="mi">80</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mi">04</span>      <span class="c1">// IL_000F: stsfld    &lt;ID&gt;</span>
            <span class="mi">72</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mi">70</span>      <span class="c1">// IL_0014: ldstr     ""</span>
            <span class="mi">28</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span>      <span class="c1">// IL_0019: call      set_Message(string)</span>
            <span class="mi">2</span><span class="nx">A</span>                  <span class="c1">// IL_001E: ret</span>
        <span class="p">}</span>

    <span class="nl">condition</span><span class="p">:</span>
        <span class="nx">$get_conf_v1</span>
        <span class="nx">and</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">[+] C2: </span><span class="dl">"</span><span class="p">,</span>
            <span class="nx">dotnet</span><span class="p">.</span><span class="nx">user_strings</span><span class="p">[</span><span class="nx">int32</span><span class="p">(@</span><span class="nd">get_conf_v1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="nx">and</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">[+] Botnet: </span><span class="dl">"</span><span class="p">,</span>
            <span class="nx">dotnet</span><span class="p">.</span><span class="nx">user_strings</span><span class="p">[</span><span class="nx">int32</span><span class="p">(@</span><span class="nd">get_conf_v1</span><span class="o">+</span><span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">]</span>
        <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <ul>
    <li><code class="language-plaintext highlighter-rouge">@get_conf_v1</code>: address of the first match of <code class="language-plaintext highlighter-rouge">$get_conf_v1</code></li>
    <li><code class="language-plaintext highlighter-rouge">int32</code>: reads 4 bytes (string token) from an offset, I used <code class="language-plaintext highlighter-rouge">0xffffff</code> bit mask to only get the row index.</li>
  </ul>
</blockquote>

<p><a href="/assets/images/tutorials/yara/5.png"><img src="/assets/images/tutorials/yara/5.png" alt="5" /></a></p>

<p>Cool, Let’s move to the second variant.</p>

<h2 id="redline-stealer-variant2">RedLine Stealer Variant2</h2>

<p>This variant stores the config in an encrypted form.</p>

<p><a href="/assets/images/tutorials/yara/6.png"><img src="/assets/images/tutorials/yara/6.png" alt="6" /></a></p>

<p>The decryption algorithm looks as follows:</p>

<p><a href="/assets/images/tutorials/yara/7.png"><img src="/assets/images/tutorials/yara/7.png" alt="7" /></a></p>

<p>Currently YARA doesn’t have a module to do <code class="language-plaintext highlighter-rouge">base64</code> and <code class="language-plaintext highlighter-rouge">xor</code> operations in conditions, so why not write our own module :)</p>

<h2 id="writing-our-own-yara-module">Writing our own YARA module</h2>

<p>Modules are written in C and built into YARA as part of the compiling process.</p>

<p>I will explain briefly how to write a YARA module, for more details refer to the <a href="https://yara.readthedocs.io/en/stable/writingmodules.html">official docs</a>.</p>

<p>YARA modules reside in <code class="language-plaintext highlighter-rouge">libyara/modules</code>, it’s recommended to use the module name as the file name for the source file. Here I created a new module directory named <code class="language-plaintext highlighter-rouge">malutils</code> and inside it is the source file named <code class="language-plaintext highlighter-rouge">malutils.c</code>, now let’s go through the source code.</p>

<p>First we need to include the required headers to be able to use YARA’s module API.</p>

<p><a href="/assets/images/tutorials/yara/8.png"><img src="/assets/images/tutorials/yara/8.png" alt="8" /></a></p>

<p>Next we define the required functions:</p>

<ul>
  <li>Xor decryption function which takes a buffer and a key and returns the decrypted string buffer.</li>
</ul>

<p><a href="/assets/images/tutorials/yara/9.png"><img src="/assets/images/tutorials/yara/9.png" alt="9" /></a></p>

<ul>
  <li>Base64 decoding function which takes a base64 encoded string and returns the decoded value.</li>
</ul>

<p><a href="/assets/images/tutorials/yara/10.png"><img src="/assets/images/tutorials/yara/10.png" alt="10" /></a></p>

<ul>
  <li>Helper function to convert dotnet user strings from wide to ascii.</li>
</ul>

<p><a href="/assets/images/tutorials/yara/11.png"><img src="/assets/images/tutorials/yara/11.png" alt="11" /></a></p>

<p>Then comes the declaration section where we declare the functions and data structures that will be available for our YARA rules.</p>

<p><a href="/assets/images/tutorials/yara/12.png"><img src="/assets/images/tutorials/yara/12.png" alt="12" /></a></p>

<p>After that we have 2 pairs of functions, the first pair is <code class="language-plaintext highlighter-rouge">module_initialize</code> &amp; <code class="language-plaintext highlighter-rouge">module_finalize</code>.</p>

<p>These functions allow you to initialize and finalize any global data structure you may need to use in your module, and both functions are invoked whether or not the module is being imported by some rule.</p>

<p><a href="/assets/images/tutorials/yara/13.png"><img src="/assets/images/tutorials/yara/13.png" alt="13" /></a></p>

<p>The second pair is <code class="language-plaintext highlighter-rouge">module_load</code> &amp; <code class="language-plaintext highlighter-rouge">module_unload</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">module_load</code> function is invoked once for each scanned file (only if the module is imported in your rule). It’s is where your module can inspect the file being scanned, parse or analyze it in the way preferred, and then populate the data structures defined in the declarations section.</p>

<p>For each call to <code class="language-plaintext highlighter-rouge">module_load</code> there is a corresponding call to <code class="language-plaintext highlighter-rouge">module_unload</code>. This function allows your module to free any resource allocated during <code class="language-plaintext highlighter-rouge">module_load</code>.</p>

<p><a href="/assets/images/tutorials/yara/14.png"><img src="/assets/images/tutorials/yara/14.png" alt="14" /></a></p>

<h2 id="final-touches">Final Touches</h2>

<p>Before we test our module there’s a nasty bug we need to take care of.</p>

<p>When writing a YARA module, instead of using the C <em>return</em> statement in your declared functions you must use <code class="language-plaintext highlighter-rouge">return_string(x)</code>, <code class="language-plaintext highlighter-rouge">return_integer(x)</code> or <code class="language-plaintext highlighter-rouge">return_float(x)</code> to return from a function.</p>

<p>The problem occurs when we return from <code class="language-plaintext highlighter-rouge">base64d</code> function, the decoded string might contain null bytes so <code class="language-plaintext highlighter-rouge">return_string</code> won’t return the full buffer.</p>

<p>As you can see below, <code class="language-plaintext highlighter-rouge">return_string</code> uses <code class="language-plaintext highlighter-rouge">strlen</code> to determine the length of the returned string so it will stop at the first null byte.</p>

<p><a href="/assets/images/tutorials/yara/15.png"><img src="/assets/images/tutorials/yara/15.png" alt="15" /></a></p>

<p>As a workaround, I defined a new return macro called <code class="language-plaintext highlighter-rouge">return_sized_string</code> which enables us to set the length of the returned string rather than relying on <code class="language-plaintext highlighter-rouge">strlen</code>.</p>

<p><a href="/assets/images/tutorials/yara/16.png"><img src="/assets/images/tutorials/yara/16.png" alt="16" /></a></p>

<h2 id="building-our-module">Building our module</h2>

<p>To include our module in the compiling process of YARA we must follow two further steps:</p>

<ul>
  <li>Add our module name to the module_list at <code class="language-plaintext highlighter-rouge">libyara/modules/module_list</code></li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MODULE(malutils)
</code></pre></div></div>

<ul>
  <li>Add our module source file to the must compiled modules at <code class="language-plaintext highlighter-rouge">libyara/Makefile.am</code></li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MODULES += modules/malutils/malutils.c
</code></pre></div></div>

<p>Finally we build YARA with our module:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ make
$ sudo make install
</code></pre></div></div>

<p>With everything in place, let’s now test our module.</p>

<h2 id="testing-our-module">Testing our module</h2>

<p>Below is the final YARA rule that handles both RedLine variants.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="dl">"</span><span class="s2">dotnet</span><span class="dl">"</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">console</span><span class="dl">"</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">malutils</span><span class="dl">"</span>

<span class="nx">rule</span> <span class="nx">Redline</span> <span class="p">{</span>
    <span class="nl">meta</span><span class="p">:</span>
        <span class="nx">date</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">2022-08-08</span><span class="dl">"</span>
        <span class="nx">author</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Abdallah 'n1ghtw0lf' Elshinbary</span><span class="dl">"</span>
        <span class="nx">description</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Extracts Redline config (educational)</span><span class="dl">"</span>

    <span class="nx">strings</span><span class="p">:</span>
        <span class="nx">$get_conf_v1</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">72</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mi">70</span>      <span class="c1">// IL_0000: ldstr     "87.251.71.4:80"</span>
            <span class="mi">80</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mi">04</span>      <span class="c1">// IL_0005: stsfld    &lt;IP&gt;</span>
            <span class="mi">72</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mi">70</span>      <span class="c1">// IL_000A: ldstr     "lyla"</span>
            <span class="mi">80</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mi">04</span>      <span class="c1">// IL_000F: stsfld    &lt;ID&gt;</span>
            <span class="mi">72</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mi">70</span>      <span class="c1">// IL_0014: ldstr     ""</span>
            <span class="mi">28</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span>      <span class="c1">// IL_0019: call      set_Message(string)</span>
            <span class="mi">2</span><span class="nx">A</span>                  <span class="c1">// IL_001E: ret</span>
        <span class="p">}</span>
        <span class="nx">$get_conf_v2</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">72</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mi">70</span>      <span class="c1">// IL_0000: ldstr     "CyYOXysPAwUnB1NQCxtdWioxKUInBC5QCDNUUw=="</span>
            <span class="mi">80</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mi">04</span>      <span class="c1">// IL_0005: stsfld    &lt;IP&gt;</span>
            <span class="mi">72</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mi">70</span>      <span class="c1">// IL_000A: ldstr     "FzcNJDEOEDw7O1Y/FEM/IQ=="</span>
            <span class="mi">80</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mi">04</span>      <span class="c1">// IL_000F: stsfld    &lt;ID&gt;</span>
            <span class="mi">72</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mi">70</span>      <span class="c1">// IL_0014: ldstr     ""</span>
            <span class="mi">80</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mi">04</span>      <span class="c1">// IL_0019: stsfld    &lt;Message&gt;</span>
            <span class="mi">72</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mi">70</span>      <span class="c1">// IL_001E: ldstr     "Baying"</span>
            <span class="mi">80</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mi">04</span>      <span class="c1">// IL_0023: stsfld    &lt;Key&gt;</span>
        <span class="p">}</span>

    <span class="nl">condition</span><span class="p">:</span>
        <span class="nx">dotnet</span><span class="p">.</span><span class="nx">is_dotnet</span> <span class="nx">and</span>
        <span class="p">(</span>
          <span class="p">(</span>
            <span class="nx">$get_conf_v1</span>
            <span class="nx">and</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">[+] C2: </span><span class="dl">"</span><span class="p">,</span>
              <span class="nx">malutils</span><span class="p">.</span><span class="nx">wtoa</span><span class="p">(</span><span class="nx">dotnet</span><span class="p">.</span><span class="nx">user_strings</span><span class="p">[</span><span class="nx">int32</span><span class="p">(@</span><span class="nd">get_conf_v1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="nx">and</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">[+] Botnet: </span><span class="dl">"</span><span class="p">,</span>
              <span class="nx">malutils</span><span class="p">.</span><span class="nx">wtoa</span><span class="p">(</span><span class="nx">dotnet</span><span class="p">.</span><span class="nx">user_strings</span><span class="p">[</span><span class="nx">int32</span><span class="p">(@</span><span class="nd">get_conf_v1</span><span class="o">+</span><span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">])</span>
            <span class="p">)</span>
          <span class="p">)</span>
          <span class="nx">or</span>
          <span class="p">(</span>
            <span class="nx">$get_conf_v2</span>
            <span class="nx">and</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">[+] C2: </span><span class="dl">"</span><span class="p">,</span>
              <span class="nx">malutils</span><span class="p">.</span><span class="nx">base64d</span><span class="p">(</span>
                <span class="nx">malutils</span><span class="p">.</span><span class="nx">xord</span><span class="p">(</span>
                  <span class="nx">malutils</span><span class="p">.</span><span class="nx">base64d</span><span class="p">(</span>
                    <span class="nx">malutils</span><span class="p">.</span><span class="nx">wtoa</span><span class="p">(</span><span class="nx">dotnet</span><span class="p">.</span><span class="nx">user_strings</span><span class="p">[</span><span class="nx">int32</span><span class="p">(@</span><span class="nd">get_conf_v2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">])</span>    <span class="c1">// enc c2</span>
                  <span class="p">),</span> <span class="nx">malutils</span><span class="p">.</span><span class="nx">wtoa</span><span class="p">(</span><span class="nx">dotnet</span><span class="p">.</span><span class="nx">user_strings</span><span class="p">[</span><span class="nx">int32</span><span class="p">(@</span><span class="nd">get_conf_v2</span><span class="o">+</span><span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">])</span>  <span class="c1">// xor key</span>
                <span class="p">)</span>
              <span class="p">)</span>
            <span class="p">)</span>
            <span class="nx">and</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">[+] Botnet: </span><span class="dl">"</span><span class="p">,</span>
              <span class="nx">malutils</span><span class="p">.</span><span class="nx">base64d</span><span class="p">(</span>
                <span class="nx">malutils</span><span class="p">.</span><span class="nx">xord</span><span class="p">(</span>
                  <span class="nx">malutils</span><span class="p">.</span><span class="nx">base64d</span><span class="p">(</span>
                    <span class="nx">malutils</span><span class="p">.</span><span class="nx">wtoa</span><span class="p">(</span><span class="nx">dotnet</span><span class="p">.</span><span class="nx">user_strings</span><span class="p">[</span><span class="nx">int32</span><span class="p">(@</span><span class="nd">get_conf_v2</span><span class="o">+</span><span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">])</span>   <span class="c1">// enc botnet</span>
                  <span class="p">),</span> <span class="nx">malutils</span><span class="p">.</span><span class="nx">wtoa</span><span class="p">(</span><span class="nx">dotnet</span><span class="p">.</span><span class="nx">user_strings</span><span class="p">[</span><span class="nx">int32</span><span class="p">(@</span><span class="nd">get_conf_v2</span><span class="o">+</span><span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">])</span>  <span class="c1">// xor key</span>
                <span class="p">)</span>
              <span class="p">)</span>
            <span class="p">)</span>
            <span class="nx">and</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">[+] Key: </span><span class="dl">"</span><span class="p">,</span>
              <span class="nx">malutils</span><span class="p">.</span><span class="nx">wtoa</span><span class="p">(</span><span class="nx">dotnet</span><span class="p">.</span><span class="nx">user_strings</span><span class="p">[</span><span class="nx">int32</span><span class="p">(@</span><span class="nd">get_conf_v2</span><span class="o">+</span><span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">])</span>
            <span class="p">)</span>
          <span class="p">)</span>
        <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Running the rule on a list of samples produces the following output:</p>

<p><a href="/assets/images/tutorials/yara/17.png"><img src="/assets/images/tutorials/yara/17.png" alt="17" /></a></p>

<p>Beautiful right!</p>

<p>You can pull the code and try it yourself at 
<a href="https://github.com/N1ght-W0lf/yara/tree/malutils">https://github.com/N1ght-W0lf/yara/tree/malutils</a>.</p>

<p>It was just for learning purposes so not the best code :)</p>

<h2 id="samples">Samples</h2>

<p>fed976b2d134008fd6daec8edc00099935df756beb721034f71db33e4d675a6e
e4f7246b103d9bda3a7604bea12dc5ac1064764c0f3691617c9829c4e5d469b5
2d3503d8540e319851a67e55f06ed9e5ba060e821eec6dbc83960a5947ad1310
a8c498f5129af0229081edf1e535ac9dab6ad568befcbcecbfc7cc4c61e0a8eb
c19938f0b9648dc1f6b95d0e767164da832b9a92f8128ab47dcb81c5e1ceb31a
e94d48e09cace8937941fbf81d1a466fa2b2b6acfd0d6142fc3443c70e067294
f343005539a589ec5512559e0bdc824c1069196ae39d519e5b1f3257f4a6660b</p>

<h2 id="references">References</h2>

<p><a href="https://yara.readthedocs.io/en/stable/index.html">https://yara.readthedocs.io/en/stable/index.html</a></p>

<p><a href="https://www.ntcore.com/files/dotnetformat.htm">https://www.ntcore.com/files/dotnetformat.htm</a></p>

        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#tutorials" class="page__taxonomy-item" rel="tag">Tutorials</a>
    
    </span>
  </p>




        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2022-08-08T00:00:00+01:00">August 8, 2022</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/tutorials/qiling-for-malware-analysis-part-2/" class="pagination--pager" title="Qiling For Malware Analysis: Part 2
">Previous</a>
    
    
      <a href="/tutorials/writing-x64dbg-scripts/" class="pagination--pager" title="Writing x64dbg scripts
">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->

        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 zakariae Elbouzarazi. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>










  </body>
</html>
