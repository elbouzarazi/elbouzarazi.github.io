<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Deep Analysis of Phobos Ransomware - Zakariae el bouzarazi</title>
<meta name="description" content="First I loaded the binary into pestudio We can see some interesting imports with different functionalities like: file traversal, crypto stuff, file read&amp;write, processes traversal… ">


  <meta name="author" content="Zakariae El bouzarazi">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Zakariae el bouzarazi">
<meta property="og:title" content="Deep Analysis of Phobos Ransomware">
<meta property="og:url" content="https://github.com/elbouzarazi/elbouzarazi.github.io/pages/elbouzarazi/malware%20analysis/phobos-ransomware/">


  <meta property="og:description" content="First I loaded the binary into pestudio We can see some interesting imports with different functionalities like: file traversal, crypto stuff, file read&amp;write, processes traversal… ">



  <meta property="og:image" content="https://github.com/elbouzarazi/elbouzarazi.github.io/pages/elbouzarazi/assets/images/malware-analysis/phobos-ransomware/7.png">





  <meta property="article:published_time" content="2020-03-03T00:00:00+01:00">





  

  


<link rel="canonical" href="https://github.com/elbouzarazi/elbouzarazi.github.io/pages/elbouzarazi/malware%20analysis/phobos-ransomware/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "zakariae Elbouzarazi",
      "url": "https://github.com/elbouzarazi/elbouzarazi.github.io/pages/elbouzarazi/"
    
  }
</script>


  <meta name="google-site-verification" content="J3MnMF94zaZhTUoNtUiRt9cKsr7hiMyTxEdAvQ3GfmY" />





<!-- end _includes/seo.html -->


<link href="/pages/elbouzarazi/feed.xml" type="application/atom+xml" rel="alternate" title="Zakariae el bouzarazi Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/pages/elbouzarazi/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/site_data/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/site_data/favicon-16x16.png">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/pages/elbouzarazi/"><img src="/pages/elbouzarazi/assets/images/site_data/logo.png" alt=""></a>
        
        <a class="site-title" href="/pages/elbouzarazi/">
          Zakariae el bouzarazi
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/pages/elbouzarazi/categories/#malware-analysis">Malware Analysis</a>
            </li><li class="masthead__menu-item">
              <a href="/pages/elbouzarazi/categories/#binary-exploitation">Binary Exploitation</a>
            </li><li class="masthead__menu-item">
              <a href="/pages/elbouzarazi/categories/#ctf-writeups">CTF Writeups</a>
            </li><li class="masthead__menu-item">
              <a href="/pages/elbouzarazi/categories/#tutorials">Tutorials</a>
            </li><li class="masthead__menu-item">
              <a href="/pages/elbouzarazi/categories">All Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/pages/elbouzarazi/assets/images/site_data/avatar.jpg" alt="Zakariae El bouzarazi" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Zakariae El bouzarazi</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Malware Analysis &amp; Reverse Engineering Adventures.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="zekuelbouzrazi@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://twitter.com/_n1ghtw0lf" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/zakariae-elbouzarazi-34126b293/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/elbouzarazi" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Deep Analysis of Phobos Ransomware">
    <meta itemprop="description" content="sample SHA256: a91491f45b851a07f91ba5a200967921bf796d38677786de51a4a8fe5ddeafd2">
    <meta itemprop="datePublished" content="2020-03-03T00:00:00+01:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Deep Analysis of Phobos Ransomware
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  7 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#initial-analysis">Initial Analysis</a></li>
  <li><a href="#behavioral-analysis">Behavioral analysis</a></li>
  <li><a href="#going-deep">Going Deep</a></li>
  <li><a href="#killing-blacklisted-processes">Killing Blacklisted Processes</a></li>
  <li><a href="#decrypting-strings">Decrypting Strings</a></li>
  <li><a href="#what-is-attacked">What is attacked</a></li>
  <li><a href="#executed-commands">Executed Commands</a></li>
  <li><a href="#the-encryption-process">The Encryption Process</a></li>
  <li><a href="#encrypting-small-files">Encrypting Small Files</a></li>
  <li><a href="#encrypting-large-files">Encrypting Large Files</a></li>
  <li><a href="#encrypting-network-shares">Encrypting Network Shares</a></li>
  <li><a href="#iocs">IOCs</a></li>
  <li><a href="#external-references">External References</a></li>
</ul>

            </nav>
          </aside>
        
        <p>sample SHA256: a91491f45b851a07f91ba5a200967921bf796d38677786de51a4a8fe5ddeafd2</p>

<h2 id="initial-analysis">Initial Analysis</h2>

<p>First I loaded the binary into <code class="language-plaintext highlighter-rouge">pestudio</code>.</p>

<p>We can see some interesting imports with different functionalities like: file traversal, crypto stuff, file read&amp;write, processes traversal, …</p>

<p><a href="/assets/images/malware-analysis/phobos-ransomware/1.png"><img src="/assets/images/malware-analysis/phobos-ransomware/1.png" alt="1" /></a> 
<a href="/assets/images/malware-analysis/phobos-ransomware/2.png"><img src="/assets/images/malware-analysis/phobos-ransomware/2.png" alt="2" /></a></p>

<p>There is not much readable strings here which might indicate the strings are somewhat obfuscated.</p>

<p><a href="/assets/images/malware-analysis/phobos-ransomware/3.png"><img src="/assets/images/malware-analysis/phobos-ransomware/3.png" alt="3" /></a></p>

<h2 id="behavioral-analysis">Behavioral analysis</h2>

<p>If we run ransomware we can see that it asks for administrator privileges.</p>

<p><a href="/assets/images/malware-analysis/phobos-ransomware/4.png"><img src="/assets/images/malware-analysis/phobos-ransomware/4.png" alt="4" /></a></p>

<p>If we accept it and use <code class="language-plaintext highlighter-rouge">ProcessHacker</code> we can see that it spawns another copy of itself with the elevated privileges.</p>

<p><a href="/assets/images/malware-analysis/phobos-ransomware/5.png"><img src="/assets/images/malware-analysis/phobos-ransomware/5.png" alt="5" /></a></p>

<p>Using <code class="language-plaintext highlighter-rouge">Autoruns</code> from sysinternals we can see that it adds a value to the registry and copies itself to the startup folder to maintain persistence, which means that it can encrypt new files.</p>

<p><a href="/assets/images/malware-analysis/phobos-ransomware/6.png"><img src="/assets/images/malware-analysis/phobos-ransomware/6.png" alt="6" /></a></p>

<p>If we let the ransomware run for while we can see it drops its note in two formats: .hta &amp; .txt</p>

<p><a href="/assets/images/malware-analysis/phobos-ransomware/7.png"><img src="/assets/images/malware-analysis/phobos-ransomware/7.png" alt="7" /></a></p>

<p><a href="/assets/images/malware-analysis/phobos-ransomware/8.png"><img src="/assets/images/malware-analysis/phobos-ransomware/8.png" alt="8" /></a></p>

<p>The encrypted files are renamed to &lt;Original Name&gt;.id[&lt;Victim ID&gt;].[lockhelp@qq.com].&lt;Ransomware extension&gt;</p>

<h2 id="going-deep">Going Deep</h2>

<p>Now Let’s fire up IDA and see how it goes.</p>

<p>The <code class="language-plaintext highlighter-rouge">winMain</code> function just calls <code class="language-plaintext highlighter-rouge">main_function</code>.</p>

<p><a href="/assets/images/malware-analysis/phobos-ransomware/9.png"><img src="/assets/images/malware-analysis/phobos-ransomware/9.png" alt="9" /></a></p>

<p><code class="language-plaintext highlighter-rouge">main_function</code> creates a bunch of threads for different tasks like traversing and encrypting files, killing blacklisted processes and so on.</p>

<h2 id="killing-blacklisted-processes">Killing Blacklisted Processes</h2>

<p>The <code class="language-plaintext highlighter-rouge">ransomware</code> loops through running processes to search and kill blacklisted ones at <code class="language-plaintext highlighter-rouge">sub_4032FA</code></p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/malware-analysis/phobos-ransomware/10.png"><img src="/assets/images/malware-analysis/phobos-ransomware/10.png" alt="10" /></a></td>
      <td><a href="/assets/images/malware-analysis/phobos-ransomware/11.png"><img src="/assets/images/malware-analysis/phobos-ransomware/11.png" alt="11" /></a></td>
    </tr>
  </tbody>
</table>

<p>The blacklisted processes are passed to this function as an argument, we can go a step back using Xrefs to know what the blacklisted processes are.</p>

<p>The caller function calls <code class="language-plaintext highlighter-rouge">sub_403E72</code> first, using a debugger we can see the list of the processes returned.</p>

<p><a href="/assets/images/malware-analysis/phobos-ransomware/12.png"><img src="/assets/images/malware-analysis/phobos-ransomware/12.png" alt="12" /></a></p>

<p>Here is the complete list:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msftesql.exe sqlagent.exe sqlbrowser.exe sqlservr.exe sqlwriter.exe oracle.exe ocssd.exe dbsnmp.exe
synctime.exe agntsvc.exe mydesktopqos.exe isqlplussvc.exe xfssvccon.exe mydesktopservice.exe
ocautoupds.exe agntsvc.exe agntsvc.exe agntsvc.exe encsvc.exe firefoxconfig.exe tbirdconfig.exe
ocomm.exe mysqld.exe mysqld-nt.exe mysqld-opt.exe dbeng50.exe sqbcoreservice.exe excel.exe
infopath.exe msaccess.exe mspub.exe onenote.exe outlook.exe powerpnt.exe steam.exe thebat.exe
thebat64.exe thunderbird.exe visio.exe winword.exe wordpad.exe
</code></pre></div></div>

<h2 id="decrypting-strings">Decrypting Strings</h2>

<p>Going back to <code class="language-plaintext highlighter-rouge">sub_403E72</code> (which returned the blacklisted processes), we can see that it’s called multiple times across the code.</p>

<p><a href="/assets/images/malware-analysis/phobos-ransomware/13.png"><img src="/assets/images/malware-analysis/phobos-ransomware/13.png" alt="13" /></a></p>

<p>If we look inside it we can see that it loads some data from the  <code class="language-plaintext highlighter-rouge">.data</code> section then gets a cryptographic key and calls  <code class="language-plaintext highlighter-rouge">CryptDecrypt</code>. This indicated that the .data section is encrypted and the code uses this function to decrypt data on demand (not decrypted all at once), this also explains why we didn’t find readable strings in the initial analysis.</p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/malware-analysis/phobos-ransomware/14.png"><img src="/assets/images/malware-analysis/phobos-ransomware/14.png" alt="14" /></a></td>
      <td><a href="/assets/images/malware-analysis/phobos-ransomware/15.png"><img src="/assets/images/malware-analysis/phobos-ransomware/15.png" alt="15" /></a></td>
    </tr>
  </tbody>
</table>

<h2 id="what-is-attacked">What is attacked</h2>

<p>After calling the decryption function multiple times we can see some interesting strings in the .data section:</p>

<ol>
  <li>
    <h4 id="ransomware-possible-extensions">Ransomware possible extensions:</h4>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.acute .actin .acton .actor .acuff .acuna .acute .adage .adair .adame .banhu .banjo
.banks .banta .barak .caleb .cales .caley .calix .calle .calum .calvo .deuce .dever 
.devil .devoe .devon .devos .dewar .eight .eject .eking .elbie .elbow .elder .phobos
.help .blend .bqux .com .mamba .karlos .ddos .phoenix .plut .karma .bbc .capital
</code></pre></div>    </div>
  </li>
  <li>
    <h4 id="attacked-extensions">Attacked extensions:</h4>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.1cd .3ds .3fr .3g2 .3gp .7z .accda .accdb .accdc .accde .accdt .accdw .adb .adp .ai
.ai3 .ai4 .ai5 .ai6 .ai7 .ai8 .anim .arw .as .asa .asc .ascx .asm .asmx .asp .aspx 
.asr .asx .avi .avs .backup .bak .bay .bd .bin .bmp .bz2 .c .cdr .cer .cf .cfc .cfm 
.cfml .cfu .chm .cin .class .clx .config .cpp .cr2 .crt .crw .cs .css .csv .cub .dae 
.dat .db .dbf .dbx .dc3 .dcm .dcr .der .dib .dic .dif .divx .djvu .dng .doc .docm 
.docx .dot .dotm .dotx .dpx .dqy .dsn .dt .dtd .dwg .dwt .dx .dxf .edml .efd .elf 
.emf .emz .epf .eps .epsf .epsp .erf .exr .f4v .fido .flm .flv .frm .fxg .geo .gif 
.grs .gz .h .hdr .hpp .hta .htc .htm .html .icb .ics .iff .inc .indd .ini .iqy .j2c 
.j2k .java .jp2 .jpc .jpe .jpeg .jpf .jpg .jpx .js .jsf .json .jsp .kdc .kmz .kwm 
.lasso .lbi .lgf .lgp .log .m1v .m4a .m4v .max .md .mda .mdb .mde .mdf .mdw .mef .mft
.mfw .mht .mhtml .mka .mkidx .mkv .mos .mov .mp3 .mp4 .mpeg .mpg .mpv .mrw .msg .mxl
.myd .myi .nef .nrw .obj .odb .odc .odm .odp .ods .oft .one .onepkg .onetoc2 .opt 
.oqy .orf .p12 .p7b .p7c .pam .pbm .pct .pcx .pdd .pdf .pdp .pef .pem .pff .pfm 
.pfx .pgm .php .php3 .php4 .php5 .phtml .pict .pl .pls .pm .png .pnm .pot .potm 
.potx .ppa .ppam .ppm .pps .ppsm .ppt .pptm .pptx .prn .ps .psb .psd .pst .ptx .pub
.pwm .pxr .py .qt .r3d .raf .rar .raw .rdf .rgbe .rle .rqy .rss .rtf .rw2 .rwl .safe
.sct .sdpx .shtm .shtml .slk .sln .sql .sr2 .srf .srw .ssi .st .stm .svg .svgz .swf
.tab .tar .tbb .tbi .tbk .tdi .tga .thmx .tif .tiff .tld .torrent .tpl .txt .u3d
.udl .uxdc .vb .vbs .vcs .vda .vdr .vdw .vdx .vrp .vsd .vss .vst .vsw .vsx .vtm
.vtml .vtx .wb2 .wav .wbm .wbmp .wim .wmf .wml .wmv .wpd .wps .x3f .xl .xla .xlam 
.xlk .xlm .xls .xlsb .xlsm .xlsx .xlt .xltm .xltx .xlw .xml .xps .xsd .xsf .xsl 
.xslt .xsn .xtp .xtp2 .xyze .xz .zip
</code></pre></div>    </div>
  </li>
  <li>
    <h4 id="skipped-files-not-encrypted-probably">Skipped files (not encrypted, probably):</h4>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>info.hta
info.txt
boot.ini
bootfont.bin
ntldr
ntdetect.com
io.sys
1saas.exe
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="executed-commands">Executed Commands</h2>

<p>Several commands gets executed in  <code class="language-plaintext highlighter-rouge">sub_4030E4</code> before encrypting the files using  <code class="language-plaintext highlighter-rouge">CreateProcessW</code>:</p>

<ol>
  <li>Delete all Volumes Shadow Copies (volumes backup or snapshot)</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   vssadmin delete shadows /all /quiet
   wmic shadowcopy delete
</code></pre></div></div>

<ol>
  <li>
    <p>Disable windows recovery mode</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bcdedit /set {default} bootstatuspolicy ignoreallfailures
bcdedit /set {default} recoveryenabled no
</code></pre></div>    </div>
  </li>
  <li>
    <p>Delete the backup catalog</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wbadmin delete catalog -quiet
</code></pre></div>    </div>
  </li>
  <li>
    <p>Turn off the firewall and exit</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netsh advfirewall set currentprofile state off
netsh firewall set opmode mode=disable
exit
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="the-encryption-process">The Encryption Process</h2>

<p>First the ransomware gets the logical drives then gets the volume serial number of the drive (32 bit value) and passes that value to the function  <code class="language-plaintext highlighter-rouge">get_random_aes_key</code> which uses that serial number to create a unique AES key for that drive.</p>

<p>After that the key is passed to  <code class="language-plaintext highlighter-rouge">to_encryption_thread</code> function which starts a new thread with the generated key as a ThreadParameter.</p>

<p><a href="/assets/images/malware-analysis/phobos-ransomware/16.png"><img src="/assets/images/malware-analysis/phobos-ransomware/16.png" alt="16" /></a></p>

<p>Although the key is the same for every file, the ransomware generates a random 16-bytes IV (initialization vector) for each file before encrypting it using  <code class="language-plaintext highlighter-rouge">CryptGenRandom</code>.</p>

<p><a href="/assets/images/malware-analysis/phobos-ransomware/17.png"><img src="/assets/images/malware-analysis/phobos-ransomware/17.png" alt="17" /></a></p>

<p>Here is a snapshot of <code class="language-plaintext highlighter-rouge">get_random_value</code> function:</p>

<p><a href="/assets/images/malware-analysis/phobos-ransomware/18.png"><img src="/assets/images/malware-analysis/phobos-ransomware/18.png" alt="18" /></a></p>

<p>Let’s track the encryption process for a file called <strong>“test.txt”</strong> to see how it’s encrypted.</p>

<p>Using the debugger we can get the randomly generated IV for this file <strong>(31 E8 39 C2 79 B8 BB C0 C4 2C 24 84 5D C2 56 40)</strong>.</p>

<p><a href="/assets/images/malware-analysis/phobos-ransomware/19.png"><img src="/assets/images/malware-analysis/phobos-ransomware/19.png" alt="19" /></a></p>

<p>Next, <code class="language-plaintext highlighter-rouge">open_and_encrypt</code> function checks the file size, if it’s smaller than  <code class="language-plaintext highlighter-rouge">0x180000</code> bytes it will go to  <code class="language-plaintext highlighter-rouge">encrypt_small_files</code> else it will go to  <code class="language-plaintext highlighter-rouge">encrypt_large_files</code>.</p>

<p>[<a href="/assets/images/malware-analysis/phobos-ransomware/20.png"><img src="/assets/images/malware-analysis/phobos-ransomware/20.png" alt="20" /></a></p>

<h2 id="encrypting-small-files">Encrypting Small Files</h2>

<p>In the case of small files, The ransomware first creates a file with the new name (with the ransomware extension) then encrypts the file content and writes it to the newly created file.</p>

<p><a href="/assets/images/malware-analysis/phobos-ransomware/21.png"><img src="/assets/images/malware-analysis/phobos-ransomware/21.png" alt="21" /></a></p>

<p>After that, the ransomware writes some metadata after the encrypted file content (possibly checksums + original file name + some padding nulls). Then it writes the random IV (you can see that it’s the same IV from above).</p>

<p><a href="/assets/images/malware-analysis/phobos-ransomware/22.png"><img src="/assets/images/malware-analysis/phobos-ransomware/22.png" alt="22" /></a></p>

<p>Finally it writes the encrypted AES key to end of the file followed by <strong>.LOCK96</strong> and encrypts the metadata block (checksums + original file name).</p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/malware-analysis/phobos-ransomware/23.png"><img src="/assets/images/malware-analysis/phobos-ransomware/23.png" alt="23" /></a></td>
      <td><a href="/assets/images/malware-analysis/phobos-ransomware/24.png"><img src="/assets/images/malware-analysis/phobos-ransomware/24.png" alt="24" /></a></td>
    </tr>
  </tbody>
</table>

<p>After the encryption is done, the ransomware deletes the original file</p>

<p><a href="/assets/images/malware-analysis/phobos-ransomware/25.png"><img src="/assets/images/malware-analysis/phobos-ransomware/25.png" alt="25" /></a></p>

<p>Here we can see two different small files after being encrypted and they have the same block at the end <strong>(encrypted AES key + “.LOCK96”)</strong>:</p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/malware-analysis/phobos-ransomware/26.png"><img src="/assets/images/malware-analysis/phobos-ransomware/26.png" alt="26" /></a></td>
      <td><a href="/assets/images/malware-analysis/phobos-ransomware/27.png"><img src="/assets/images/malware-analysis/phobos-ransomware/27.png" alt="27" /></a></td>
    </tr>
  </tbody>
</table>

<h2 id="encrypting-large-files">Encrypting Large Files</h2>

<p>Large files are encrypted differently, we can confirm that by creating a large file and filling it with <code class="language-plaintext highlighter-rouge">\xFF</code>. after the encryption we can see that some parts of the file are left unencrypted and some other parts are zerod out.</p>

<p><a href="/assets/images/malware-analysis/phobos-ransomware/28.png"><img src="/assets/images/malware-analysis/phobos-ransomware/28.png" alt="28" /></a></p>

<p>At the end of file file we can see the random IV + the same block similar to the small files <strong>(encrypted AES key + “.LOCK96”)</strong>.</p>

<p><a href="/assets/images/malware-analysis/phobos-ransomware/29.png"><img src="/assets/images/malware-analysis/phobos-ransomware/29.png" alt="29" /></a></p>

<h2 id="encrypting-network-shares">Encrypting Network Shares</h2>

<p>The ransomware searches through network shared resources at <code class="language-plaintext highlighter-rouge">sub_401B7D</code> and starts new encryption threads for these resources.</p>

<p><a href="/assets/images/malware-analysis/phobos-ransomware/30.png"><img src="/assets/images/malware-analysis/phobos-ransomware/30.png" alt="30" /></a></p>

<p><a href="/assets/images/malware-analysis/phobos-ransomware/31.png"><img src="/assets/images/malware-analysis/phobos-ransomware/31.png" alt="31" /></a></p>

<p>That wraps up the analysis. This is my first time to fully analysis a ransomware from start to finish and it has been a great learning experience.</p>

<h2 id="iocs">IOCs</h2>

<h3 id="hashes"><u>Hashes</u></h3>

<p>Phobos: a91491f45b851a07f91ba5a200967921bf796d38677786de51a4a8fe5ddeafd2</p>

<h3 id="files"><u>Files</u></h3>

<p>%ProgramData%\Microsoft\Windows\Start Menu\Programs\Startup\1saas.exe</p>

<p>%AppData%\Microsoft\Windows\Start Menu\Programs\Startup\1saas.exe</p>

<h3 id="registry"><u>Registry</u></h3>

<p>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</p>

<p>HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</p>

<h3 id="emails"><u>Emails</u></h3>

<p>lockhelp@qq[.]com</p>

<h2 id="external-references">External References</h2>

<p><a href="https://blog.malwarebytes.com/threat-analysis/2019/07/a-deep-dive-into-phobos-ransomware/">https://blog.malwarebytes.com/threat-analysis/2019/07/a-deep-dive-into-phobos-ransomware/</a></p>

        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/pages/elbouzarazi/categories/#malware-analysis" class="page__taxonomy-item" rel="tag">Malware Analysis</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2020-03-03T00:00:00+01:00">March 3, 2020</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/pages/elbouzarazi/malware%20analysis/ksl0t-keylogger/" class="pagination--pager" title="Deep Analysis of KSLØT Keylogger (Turla APT)
">Previous</a>
    
    
      <a href="/pages/elbouzarazi/ctf%20writeups/utctf2020-ir/" class="pagination--pager" title="UTCTF 2020 - IR
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/pages/elbouzarazi/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 zakariae Elbouzarazi. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/pages/elbouzarazi/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/pages/elbouzarazi/assets/js/lunr/lunr.min.js"></script>
<script src="/pages/elbouzarazi/assets/js/lunr/lunr-store.js"></script>
<script src="/pages/elbouzarazi/assets/js/lunr/lunr-en.js"></script>




  <script>
  window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
  ga('create','UA-165194559-1','auto');
  ga('set', 'anonymizeIp', false);
  ga('send','pageview')
</script>
<script src="https://www.google-analytics.com/analytics.js" async></script>









  </body>
</html>
