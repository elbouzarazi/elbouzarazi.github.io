<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Deep Analysis of SmokeLoader - Zakariae el bouzarazi</title>
<meta name="description" content="SmokeLoader is a well known bot that is been around since 2011. It’s mainly used to drop other malware families… ">


  <meta name="author" content="Zakariae El bouzarazi">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Zakariae el bouzarazi">
<meta property="og:title" content="Deep Analysis of SmokeLoader">
<meta property="og:url" content="http://localhost:4000/malware%20analysis/smokeloader/">


  <meta property="og:description" content="SmokeLoader is a well known bot that is been around since 2011. It’s mainly used to drop other malware families… ">



  <meta property="og:image" content="http://localhost:4000/assets/images/malware-analysis/smokeloader/logo.png">





  <meta property="article:published_time" content="2020-06-21T00:00:00+01:00">





  

  


<link rel="canonical" href="http://localhost:4000/malware%20analysis/smokeloader/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "zakariae Elbouzarazi",
      "url": "http://localhost:4000/"
    
  }
</script>


  <meta name="google-site-verification" content="J3MnMF94zaZhTUoNtUiRt9cKsr7hiMyTxEdAvQ3GfmY" />





<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Zakariae el bouzarazi Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/site_data/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/site_data/favicon-16x16.png">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/site_data/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          Zakariae el bouzarazi
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/#malware-analysis">Malware Analysis</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#binary-exploitation">Binary Exploitation</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#ctf-writeups">CTF Writeups</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#tutorials">Tutorials</a>
            </li><li class="masthead__menu-item">
              <a href="/categories">All Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/site_data/avatar.jpg" alt="Zakariae El bouzarazi" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Zakariae El bouzarazi</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Malware Analysis &amp; Reverse Engineering Adventures.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="zekuelbouzrazi@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://twitter.com/_n1ghtw0lf" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/zakariae-elbouzarazi-34126b293/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/elbouzarazi" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->

    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Deep Analysis of SmokeLoader">
    <meta itemprop="description" content="SmokeLoader is a well known bot that is been around since 2011. It’s mainly used to drop other malware families. SmokeLoader has been under development and is constantly changing with multiple novel features added throughout the years.">
    <meta itemprop="datePublished" content="2020-06-21T00:00:00+01:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Deep Analysis of SmokeLoader
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  13 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#stage-1">Stage 1</a>
    <ul>
      <li><a href="#shellcode">Shellcode</a></li>
      <li><a href="#process-hollowing">Process Hollowing</a></li>
    </ul>
  </li>
  <li><a href="#stage-2">Stage 2</a>
    <ul>
      <li><a href="#opaque-predicates">Opaque Predicates</a></li>
      <li><a href="#anti-debugging">Anti Debugging</a></li>
      <li><a href="#encrypted-functions">Encrypted Functions</a></li>
      <li><a href="#anti-hooking">Anti Hooking</a></li>
      <li><a href="#custom-imports">Custom Imports</a></li>
      <li><a href="#anti-vm">Anti VM</a></li>
      <li><a href="#process-injection">Process Injection</a></li>
    </ul>
  </li>
  <li><a href="#stage-3">Stage 3</a>
    <ul>
      <li><a href="#checking-running-processes">Checking Running Processes</a></li>
      <li><a href="#encrypted-strings">Encrypted Strings</a></li>
      <li><a href="#encrypted-c2-domains">Encrypted C2 Domains</a></li>
      <li><a href="#c2-communications">C2 Communications</a></li>
    </ul>
  </li>
  <li><a href="#iocs">IOCs</a></li>
  <li><a href="#references">References</a></li>
</ul>

            </nav>
          </aside>
        
        <p>SmokeLoader is a well known bot that is been around since 2011. It’s mainly used to drop other malware families. SmokeLoader has been under development and is constantly changing with multiple novel features added throughout the years.</p>

<p><code class="language-plaintext highlighter-rouge">Sample SHA256: fc20b03299b8ae91e72e104ee4f18e40125b2b061f1509d1c5b3f9fac3104934</code></p>

<p><a href="/assets/images/malware-analysis/smokeloader/0.png"><img src="/assets/images/malware-analysis/smokeloader/0.png" alt="0" /></a></p>

<h1 id="stage-1">Stage 1</h1>

<p>This stage starts off by allocating memory for <code class="language-plaintext highlighter-rouge">shellcode</code> using <code class="language-plaintext highlighter-rouge">LocalAlloc()</code> (not VirtualAlloc), then it fills this memory with the shellcode (86 KB).</p>

<p><a href="/assets/images/malware-analysis/smokeloader/1.png"><img src="/assets/images/malware-analysis/smokeloader/1.png" alt="1" /></a></p>

<p>Next, it changes the protection of the allocated memory region to <code class="language-plaintext highlighter-rouge">PAGE_EXECUTE_READWRITE</code> using <code class="language-plaintext highlighter-rouge">VirtualProtect()</code>, then it writes the shellcode and executes it.</p>

<p><a href="/assets/images/malware-analysis/smokeloader/2.png"><img src="/assets/images/malware-analysis/smokeloader/2.png" alt="2" /></a></p>

<h2 id="shellcode">Shellcode</h2>

<p>The shellcode starts by getting the addresses of <code class="language-plaintext highlighter-rouge">LoadLibraryA</code> and <code class="language-plaintext highlighter-rouge">GetProcAddress</code> to resolve APIs dynamically, but first let’s see how it does that.</p>

<p>First it passes some hash values to a sub-routine that returns the address of the requested function.</p>

<p><a href="/assets/images/malware-analysis/smokeloader/3.png"><img src="/assets/images/malware-analysis/smokeloader/3.png" alt="3" /></a></p>

<p>After some digging, I found out that the algorithm for calculating the hashes is pretty simple.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">calc_hash</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">hash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x60</span><span class="p">;</span>
        <span class="n">hash</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">hash</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">hash</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The shellcode uses <code class="language-plaintext highlighter-rouge">PEB traversal</code> technique for finding a function.</p>

<blockquote>
  <p>Process Environment Block (PEB) is a user-mode data structure that can be used by applications (and by extend by malware) to  get information such as the list of loaded modules, process startup  arguments, heap address among other useful capabilities.</p>
</blockquote>

<p>The shellcode traverses the PEB structure at <code class="language-plaintext highlighter-rouge">FS[:30]</code> and iterating through loaded modules to search for the requested module (kernel32 in this case). It hashes the name of each module using the algorithm above and compares it with the supplied hash.</p>

<p>Next, it iterates over the export table of the module to find the requested function, similar to the previous step.</p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/malware-analysis/smokeloader/4.png"><img src="/assets/images/malware-analysis/smokeloader/4.png" alt="4" /></a></td>
      <td><a href="/assets/images/malware-analysis/smokeloader/5.png"><img src="/assets/images/malware-analysis/smokeloader/5.png" alt="5" /></a></td>
    </tr>
  </tbody>
</table>

<p>The next step is to resolve APIs using <code class="language-plaintext highlighter-rouge">LoadLibraryA</code> and <code class="language-plaintext highlighter-rouge">GetProcAddress</code>, the shellcode uses stack strings to complicate the analysis.</p>

<p><a href="/assets/images/malware-analysis/smokeloader/6.png"><img src="/assets/images/malware-analysis/smokeloader/6.png" alt="6" /></a></p>

<p>Here is the list of imported functions:</p>

<details style="color: #EEFFFF; font-family: monospace !default; font-size: 0.85em; background: #263238; border: 1px solid #263238; border-radius: 3px; padding: 10px; line-height: 1.8">
    <summary style="outline: none; cursor: pointer">
        <span style="color: darkgray">
            Expand to see more
        </span><br />
&emsp; ntdll.dll<br />
&emsp; &emsp; &ensp; NtUnmapViewOfSection<br />
&emsp; &emsp; &ensp; NtWriteVirtualMemory<br />
&emsp; kernel32.dll<br />
&emsp; &emsp; &ensp; CloseHandle<br />
&emsp; &emsp; &ensp; CreateFileA<br />
&emsp; &emsp; &ensp; CreateProcessA<br />
&emsp; &emsp; &ensp; ExitProcess<br />
&emsp; &emsp; &ensp; GetCommandLineA<br />
</summary>
&emsp; &emsp; &ensp; GetFileAttributesA<br />
&emsp; &emsp; &ensp; GetModuleFileNameA<br />
&emsp; &emsp; &ensp; GetStartupInfoA<br />
&emsp; &emsp; &ensp; GetThreadContext<br />
&emsp; &emsp; &ensp; ReadProcessMemory<br />
&emsp; &emsp; &ensp; ResumeThread<br />
&emsp; &emsp; &ensp; SetThreadContext<br />
&emsp; &emsp; &ensp; VirtualAlloc<br />
&emsp; &emsp; &ensp; VirtualAllocEx<br />
&emsp; &emsp; &ensp; VirtualFree<br />
&emsp; &emsp; &ensp; VirtualProtectEx<br />
&emsp; &emsp; &ensp; WaitForSingleObject<br />
&emsp; &emsp; &ensp; WinExec<br />
&emsp; &emsp; &ensp; WriteFile<br />
&emsp; &emsp; &ensp; WriteProcessMemory<br />
&emsp; user32.dll<br />
&emsp; &emsp; &ensp; CreateWindowExA<br />
&emsp; &emsp; &ensp; DefWindowProcA<br />
&emsp; &emsp; &ensp; GetMessageA<br />
&emsp; &emsp; &ensp; GetMessageExtraInfo<br />
&emsp; &emsp; &ensp; MessageBoxA<br />
&emsp; &emsp; &ensp; PostMessageA<br />
&emsp; &emsp; &ensp; RegisterClassExA<br />
</details>
<h2 id="process-hollowing">Process Hollowing</h2>

<p>The shellcode creates a new processes of SmokeLoader in a suspended state.</p>

<p><a href="/assets/images/malware-analysis/smokeloader/7.png"><img src="/assets/images/malware-analysis/smokeloader/7.png" alt="7" /></a></p>

<p>Next, it hollows out the memory at <code class="language-plaintext highlighter-rouge">0x400000</code> using <code class="language-plaintext highlighter-rouge">ZwUnmapViewOfSection()</code> and then allocates it again using <code class="language-plaintext highlighter-rouge">VirtualAllocEx()</code> with <code class="language-plaintext highlighter-rouge">RWX</code> permissions.</p>

<p>Finally, it writes the next stage executable to the allocated memory region using two calls to <code class="language-plaintext highlighter-rouge">ZwWriteVirtualMemory()</code>, the first one to write the MZ header and the other for the rest of the executable.</p>

<p><a href="/assets/images/malware-analysis/smokeloader/8.png"><img src="/assets/images/malware-analysis/smokeloader/8.png" alt="8" /></a></p>

<h1 id="stage-2">Stage 2</h1>

<p>After dumping the second stage from memory, I got a warm welcome from SmokeLoader :(</p>

<p><a href="/assets/images/malware-analysis/smokeloader/9.png"><img src="/assets/images/malware-analysis/smokeloader/9.png" alt="9" /></a></p>

<p>This stage is full of anti-analysis tricks, so let’s dive in.</p>

<h2 id="opaque-predicates">Opaque Predicates</h2>

<p>The first anti-analysis trick is <a href="https://en.wikipedia.org/wiki/Opaque_predicate">Opaque Predicates</a>, it’s a commonly used technique in program obfuscation, intended to add complexity to the control flow. There are many patterns of this technique so I will stick with the one used here.</p>

<p>This obfuscation simply takes an absolute jump (JMP) and transforms it into two conditional jumps (JZ/JNZ). Depending on the value of the <code class="language-plaintext highlighter-rouge">Zero flag (ZF)</code>, the execution will follow the first or second branch.</p>

<p>However, disassemblers are tricked into thinking that there is a fall-through branch if the second jump is not taken (which is impossible as one of them must be taken) and tries to disassemble the unreachable instructions (often invalid) resulting in garbage code.</p>

<p><a href="/assets/images/malware-analysis/smokeloader/10.png"><img src="/assets/images/malware-analysis/smokeloader/10.png" alt="10" /></a></p>

<p>The deobfuscation is so simple, we just need to patch the first conditional jump to an absolute jump and nop out the second jump, we can use <code class="language-plaintext highlighter-rouge">IDAPython</code> to achieve this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">idc</span>

<span class="n">ea</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">ea</span> <span class="o">=</span>  <span class="nb">min</span><span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">find_binary</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">idc</span><span class="p">.</span><span class="n">SEARCH_NEXT</span> <span class="o">|</span> <span class="n">idc</span><span class="p">.</span><span class="n">SEARCH_DOWN</span><span class="p">,</span> <span class="s">"74 ? 75 ?"</span><span class="p">),</span>  <span class="c1"># JZ / JNZ
</span>              <span class="n">idc</span><span class="p">.</span><span class="n">find_binary</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">idc</span><span class="p">.</span><span class="n">SEARCH_NEXT</span> <span class="o">|</span> <span class="n">idc</span><span class="p">.</span><span class="n">SEARCH_DOWN</span><span class="p">,</span> <span class="s">"75 ? 74 ?"</span><span class="p">))</span>  <span class="c1"># JNZ / JZ
</span>    <span class="k">if</span> <span class="n">ea</span> <span class="o">==</span> <span class="n">idc</span><span class="p">.</span><span class="n">BADADDR</span><span class="p">:</span>
    	<span class="k">break</span>
    <span class="n">idc</span><span class="p">.</span><span class="n">patch_byte</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mh">0xEB</span><span class="p">)</span>	<span class="c1"># JMP
</span>    <span class="n">idc</span><span class="p">.</span><span class="n">patch_byte</span><span class="p">(</span><span class="n">ea</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">)</span>	<span class="c1"># NOP
</span>    <span class="n">idc</span><span class="p">.</span><span class="n">patch_byte</span><span class="p">(</span><span class="n">ea</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">)</span>	<span class="c1"># NOP
</span></code></pre></div></div>

<h2 id="anti-debugging">Anti Debugging</h2>

<p>This stage first checks <code class="language-plaintext highlighter-rouge">OSMajorVersion at PEB[0xA4]</code> if it’s greater than 6 (Windows Vista and higher), it’s also reading <code class="language-plaintext highlighter-rouge">BeingDebugged at PEB[0x2]</code> to check for attached debuggers.</p>

<p><a href="/assets/images/malware-analysis/smokeloader/11.png"><img src="/assets/images/malware-analysis/smokeloader/11.png" alt="11" /></a></p>

<p>What’s interesting here is that these checks are used to calculate the return address. If the <code class="language-plaintext highlighter-rouge">OSMajroVersion</code> is less than 6 or there’s an attached debugger, it will jump to an invalid memory location. That’s clever.</p>

<p>Another neat trick is that instead of using direct jumps, the code pushes the jump address stored at <code class="language-plaintext highlighter-rouge">eax</code>  into the stack then returns to it.</p>

<p><a href="/assets/images/malware-analysis/smokeloader/12.png"><img src="/assets/images/malware-analysis/smokeloader/12.png" alt="12" /></a></p>

<h2 id="encrypted-functions">Encrypted Functions</h2>

<p>Most of the functions are encrypted. After deobfuscating the opaque predicates, I found the encryption function which is pretty simple.</p>

<p>The function takes an offset and a size, it XORes the chunk at that offset with a single byte <code class="language-plaintext highlighter-rouge">(0xA6)</code>.</p>

<p><a href="/assets/images/malware-analysis/smokeloader/13.png"><img src="/assets/images/malware-analysis/smokeloader/13.png" alt="13" /></a></p>

<p>We can use <code class="language-plaintext highlighter-rouge">IDAPython</code> again to decrypt the encrypted chunks:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">idc</span>
<span class="kn">import</span> <span class="nn">idautils</span>

<span class="k">def</span> <span class="nf">xor_chunk</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
	<span class="n">ea</span> <span class="o">=</span> <span class="mh">0x400000</span> <span class="o">+</span> <span class="n">offset</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
		<span class="n">byte</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">get_bytes</span><span class="p">(</span><span class="n">ea</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">byte</span> <span class="o">^=</span> <span class="mh">0xA6</span>
		<span class="n">idc</span><span class="p">.</span><span class="n">patch_byte</span><span class="p">(</span><span class="n">ea</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">byte</span><span class="p">)</span>

<span class="n">xor_chunk_addr</span> <span class="o">=</span> <span class="mh">0x401294</span>	<span class="c1"># address of the xoring function
</span><span class="k">for</span> <span class="n">xref</span> <span class="ow">in</span> <span class="n">idautils</span><span class="p">.</span><span class="n">CodeRefsTo</span><span class="p">(</span><span class="n">xor_chunk_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
	<span class="n">mov_addr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">idautils</span><span class="p">.</span><span class="n">CodeRefsTo</span><span class="p">(</span><span class="n">xref</span><span class="p">,</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">5</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">mov_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">xref</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x400000</span>
	<span class="n">xor_chunk</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</code></pre></div></div>

<p>After the decryption:</p>

<p><a href="/assets/images/malware-analysis/smokeloader/14.png"><img src="/assets/images/malware-analysis/smokeloader/14.png" alt="14" /></a></p>

<p>One thing to note here, SmokeLoader tries to keep as many encrypted code as possible. So once it’s done with the decrypted functions, it encrypts it again.</p>

<p><a href="/assets/images/malware-analysis/smokeloader/15.png"><img src="/assets/images/malware-analysis/smokeloader/15.png" alt="15" /></a></p>

<h2 id="anti-hooking">Anti Hooking</h2>

<p>Many Sandboxes and Security Solutions hook user-land functions of <code class="language-plaintext highlighter-rouge">ntdll.dll</code> to trace system calls. SmokeLoader tries to evade this by using its own copy of ntdll. It copies <code class="language-plaintext highlighter-rouge">ntdll.dll</code> to <code class="language-plaintext highlighter-rouge">"%TEMP%\&lt;hardcoded_name&gt;.tmp"</code> then loads it using <code class="language-plaintext highlighter-rouge">LdrLoadDll()</code> and resolves its imports from it.</p>

<p><a href="/assets/images/malware-analysis/smokeloader/16.png"><img src="/assets/images/malware-analysis/smokeloader/16.png" alt="16" /></a></p>

<h2 id="custom-imports">Custom Imports</h2>

<p>SmokeLoader stores a hash table of its imports, it uses the same <code class="language-plaintext highlighter-rouge">PEB traversal</code> technique explained earlier to walk through the DLLs’ export table and compare the hash of each API name with the stored hashes.</p>

<p>The hashing function is an implementation of <code class="language-plaintext highlighter-rouge">djb2</code> hashing algorithms:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">calc_hash</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">api_name</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">hash</span><span class="o">=</span><span class="mh">0x1505</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;=</span><span class="n">strlen</span><span class="p">(</span><span class="n">api_name</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>	<span class="c1">// null byte included</span>
		<span class="n">hash</span> <span class="o">=</span> <span class="p">((</span><span class="n">hash</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">hash</span><span class="p">)</span> <span class="o">+</span> <span class="n">api_name</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">hash</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here is a list of imported functions and their corresponding hashes:</p>

<details style="color: #EEFFFF; font-family: monospace !default; font-size: 0.85em; background: #263238; border: 1px solid #263238; border-radius: 3px; padding: 10px; line-height: 1.8">
    <summary style="outline: none; cursor: pointer">
        <span style="color: darkgray">
            Expand to see more
        </span><br />
&emsp; ntdll.dll<br />
&emsp; &emsp; &ensp; LdrLoadDll                  (0x64033f83)<br />
&emsp; &emsp; &ensp; NtClose                     (0xfd507add)<br />
&emsp; &emsp; &ensp; NtTerminateProcess          (0xf779110f)<br />
&emsp; &emsp; &ensp; RtlInitUnicodeString        (0x60a350a9)<br />
&emsp; &emsp; &ensp; RtlMoveMemory               (0x845136e7)<br />
&emsp; &emsp; &ensp; RtlZeroMemory               (0x8a3d4cb0)<br />
&emsp; kernel32.dll<br />
&emsp; &emsp; &ensp; CopyFileW                   (0x306cceb7)<br />
&emsp; &emsp; &ensp; CreateEventW                (0xfd4027f2)<br />
</summary>
&emsp; &emsp; &ensp; CreateFileMappingW          (0x5b3f901c)<br />
&emsp; &emsp; &ensp; CreateThread                (0x60277e71)<br />
&emsp; &emsp; &ensp; DeleteFileW                 (0xb7e96d0f)<br />
&emsp; &emsp; &ensp; ExpandEnvironmentStringsW   (0x057074bb)<br />
&emsp; &emsp; &ensp; GetModuleFileNameA          (0x8acccaed)<br />
&emsp; &emsp; &ensp; GetModuleFileNameW          (0x8acccdc3)<br />
&emsp; &emsp; &ensp; GetModuleHandleA            (0x9cbd2a58)<br />
&emsp; &emsp; &ensp; GetSystemDirectoryA         (0xaebc5060)<br />
&emsp; &emsp; &ensp; GetTempFileNameW            (0x9a376a33)<br />
&emsp; &emsp; &ensp; GetTempPathW                (0x7e28b9df)<br />
&emsp; &emsp; &ensp; GetVolumeInformationA       (0xf25ce6a4)<br />
&emsp; &emsp; &ensp; LocalAlloc                  (0xeda647bb)<br />
&emsp; &emsp; &ensp; LocalFree                   (0x742c61b2)<br />
&emsp; &emsp; &ensp; MapViewOfFile               (0x4db4c713)<br />
&emsp; &emsp; &ensp; Sleep                       (0xd156a5be)<br />
&emsp; &emsp; &ensp; WaitForSingleObject         (0x8681d8fa)<br />
&emsp; &emsp; &ensp; lstrcatW                    (0x2ab51a99)<br />
&emsp; &emsp; &ensp; lstrcmpA                    (0x2abb9b4b)<br />
&emsp; user32.dll<br />
&emsp; &emsp; &ensp; EnumChildWindows            (0x9a8897c9)<br />
&emsp; &emsp; &ensp; EnumPropsA                  (0x8f0f57cf)<br />
&emsp; &emsp; &ensp; GetForegroundWindow         (0x5a6c9878)<br />
&emsp; &emsp; &ensp; GetKeyboardLayoutList       (0x04e9de30)<br />
&emsp; &emsp; &ensp; GetShellWindow              (0xd454e895)<br />
&emsp; &emsp; &ensp; GetWindowThreadProcessId    (0x576a5801)<br />
&emsp; &emsp; &ensp; SendMessageA                (0x41ecd315)<br />
&emsp; &emsp; &ensp; SendNotifyMessageA          (0xc6123bae)<br />
&emsp; &emsp; &ensp; SetPropA                    (0x90bc10d3)<br />
&emsp; &emsp; &ensp; wsprintfW                   (0x0bafd3f9)<br />
&emsp; advapi32.dll<br />
&emsp; &emsp; &ensp; GetTokenInformation         (0x696464ac)<br />
&emsp; &emsp; &ensp; OpenProcessToken            (0x74f5e377)<br />
&emsp; shell32.dll<br />
&emsp; &emsp; &ensp; ShellExecuteExW             (0xf8e40384)<br />
</details>

<p>And here is the list of the imported functions from the copied ntdll (for anti-hooking):</p>

<details style="color: #EEFFFF; font-family: monospace !default; font-size: 0.85em; background: #263238; border: 1px solid #263238; border-radius: 3px; padding: 10px; line-height: 1.8">
    <summary style="outline: none; cursor: pointer">
        <span style="color: darkgray">
            Expand to see more
        </span><br />
&emsp; 4DD3.tmp<br />
&emsp; &emsp; &ensp; NtAllocateVirtualMemory     (0x5a0c2ccc)<br />
&emsp; &emsp; &ensp; NtCreateSection             (0xd5f23ad0)<br />
&emsp; &emsp; &ensp; NtEnumerateKey              (0xb6306996)<br />
&emsp; &emsp; &ensp; NtFreeVirtualMemory         (0x2a6fa509)<br />
&emsp; &emsp; &ensp; NtMapViewOfSection          (0x870246aa)<br />
&emsp; &emsp; &ensp; NtOpenKey                   (0xc29efe42)<br />
&emsp; &emsp; &ensp; NtOpenProcess               (0x507bcb58)<br />
&emsp; &emsp; &ensp; NtQueryInformationProcess   (0xd6d488a2)<br />
&emsp; &emsp; &ensp; NtQueryKey                  (0xa9475346)<br />
</summary>
&emsp; &emsp; &ensp; NtQuerySystemInformation    (0xb83de8a8)<br />
&emsp; &emsp; &ensp; NtUnmapViewOfSection        (0x8352aa4d)<br />
&emsp; &emsp; &ensp; NtWriteVirtualMemory        (0x546899d2)<br />
&emsp; &emsp; &ensp; RtlDecompressBuffer         (0xdeb36606)<br />
&emsp; &emsp; &ensp; towlower                    (0xf7660ba8)<br />
&emsp; &emsp; &ensp; wcsstr                      (0xbb629f0b)<br />
</details>

<h2 id="anti-vm">Anti VM</h2>

<p>SmokeLoader enumerates all the subkeys of these keys:</p>

<ul>
  <li>System\CurrentControlSet\Enum\IDE</li>
  <li>System\CurrentControlSet\Enum\SCSI</li>
</ul>

<p>Then it transforms them into lowercase and searches for these strings in the enumerated keys names:</p>

<ul>
  <li>qemu</li>
  <li>virtio</li>
  <li>vmware</li>
  <li>vbox</li>
  <li>xen</li>
</ul>

<p>If one of them is found, the binary exits.</p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/malware-analysis/smokeloader/17.png"><img src="/assets/images/malware-analysis/smokeloader/17.png" alt="17" /></a></td>
      <td><a href="/assets/images/malware-analysis/smokeloader/18.png"><img src="/assets/images/malware-analysis/smokeloader/18.png" alt="18" /></a></td>
    </tr>
  </tbody>
</table>

<h2 id="process-injection">Process Injection</h2>

<p>SmokeLoader uses <a href="http://www.hexacorn.com/blog/2017/10/26/propagate-a-new-code-injection-trick/">PROPagate</a> injection method to inject the next stage into <code class="language-plaintext highlighter-rouge">explorer.exe</code>.</p>

<p>First it decompresses the next stage using <code class="language-plaintext highlighter-rouge">RtlDecompressBuffer()</code>.</p>

<p><a href="/assets/images/malware-analysis/smokeloader/19.png"><img src="/assets/images/malware-analysis/smokeloader/19.png" alt="19" /></a></p>

<p>Then there is a call to <code class="language-plaintext highlighter-rouge">NtOpenProcess()</code> to open <code class="language-plaintext highlighter-rouge">explorer.exe</code> for the injection.</p>

<p><a href="/assets/images/malware-analysis/smokeloader/20.png"><img src="/assets/images/malware-analysis/smokeloader/20.png" alt="20" /></a></p>

<p>The injection process starts by creating two shared sections between the current process and explorer process (one section for the modified property and the other for the next stage’s code), then SmokeLoader maps the created sections to the current process and explorer process memory space (so any changes in the sections will be reflected in explorer process).</p>

<p>Note that both sections have <code class="language-plaintext highlighter-rouge">"RWX"</code> protection which might raise some red flags by security solutions.</p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/malware-analysis/smokeloader/21.png"><img src="/assets/images/malware-analysis/smokeloader/21.png" alt="21" /></a></td>
      <td><a href="/assets/images/malware-analysis/smokeloader/22.png"><img src="/assets/images/malware-analysis/smokeloader/22.png" alt="22" /></a></td>
    </tr>
  </tbody>
</table>

<p>We can see that explorer got a handle to these two sections (this is similar to classic code injection but with much more stealth).</p>

<p><a href="/assets/images/malware-analysis/smokeloader/23.png"><img src="/assets/images/malware-analysis/smokeloader/23.png" alt="23" /></a></p>

<p>SmokeLoader then writes the next stage to one of the sections and the modified property (which will call the next stage’s code) to the other section.</p>

<p>Finally, it sets the modified property using <code class="language-plaintext highlighter-rouge">SetPropA()</code> and sends a message to explorer window using <code class="language-plaintext highlighter-rouge">SendNotifyMessageA()</code>, this will result in the injected code being executed in the context of <code class="language-plaintext highlighter-rouge">explorer.exe</code>.</p>

<p><a href="/assets/images/malware-analysis/smokeloader/24.png"><img src="/assets/images/malware-analysis/smokeloader/24.png" alt="24" /></a></p>

<h1 id="stage-3">Stage 3</h1>

<p>This is the final stage of SmokeLoader, it starts by doing some anti-analysis checks.</p>

<h2 id="checking-running-processes">Checking Running Processes</h2>

<p>This stage loops through the running process, it calculates each process name’s hash and compares it against some hardcoded hashes.</p>

<p>Here is the algorithm for calculating the hash of a process name:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">uint</span> <span class="nf">ROL</span><span class="p">(</span><span class="n">uint</span> <span class="n">x</span><span class="p">,</span> <span class="n">uint</span> <span class="n">bits</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">x</span><span class="o">&lt;&lt;</span><span class="n">bits</span> <span class="o">|</span> <span class="n">x</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">32</span><span class="o">-</span><span class="n">bits</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">calc_hash</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">proc_name</span><span class="p">)</span> <span class="p">{</span>	
	<span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">strlen</span><span class="p">(</span><span class="n">proc_name</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hash</span> <span class="o">=</span> <span class="p">(</span><span class="n">proc_name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xDF</span><span class="p">)</span> <span class="o">+</span> <span class="n">ROL</span><span class="p">(</span><span class="n">hash</span> <span class="o">^</span> <span class="p">(</span><span class="n">proc_name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xDF</span><span class="p">),</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">hash</span> <span class="o">^</span> <span class="mh">0xD781F33C</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>A quick guess and I could get the processes names:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0xD384255C  →  Autoruns.exe
0x76BDCBAB  →  procexp.exe
0xA159E6BE  →  procexp64.exe
0x7E9CCCA5  →  procmon.exe
0xA24B8E63  →  procmon64.exe
0x63B3D1A4  →  Tcpview.exe
0xA28974F3  →  Wireshark.exe
0xA9B5F897  →  ProcessHacker.exe
0x6893EBAB  →  ollydbg.exe
0xF5FD94B7  →  x32dbg.exe
0xCBFD99B0  →  x64dbg.exe
0x8993DEE5  →  idaq.exe
0x8993D8CF  →  idaw.exe
0x8C083960  →  idaq64.exe
0xB6223960  →  idaw64.exe
</code></pre></div></div>

<p>If one of these processes is found to be running, <code class="language-plaintext highlighter-rouge">explorer.exe</code> will exit.</p>

<h2 id="encrypted-strings">Encrypted Strings</h2>

<p>All strings of this stage are encrypted using <code class="language-plaintext highlighter-rouge">RC4</code> and they are decrypted on demand. The RC4 key = <code class="language-plaintext highlighter-rouge">0xFA5F66D7</code>.</p>

<p>The encrypted strings are stored continuously in a big blob in this form:</p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/malware-analysis/smokeloader/25.png"><img src="/assets/images/malware-analysis/smokeloader/25.png" alt="25" /></a></td>
      <td><a href="/assets/images/malware-analysis/smokeloader/26.png"><img src="/assets/images/malware-analysis/smokeloader/26.png" alt="26" /></a></td>
    </tr>
  </tbody>
</table>

<p>Here is a small script for decrypting these strings (I used Go because it has native support for RC4).</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>
<span class="k">import</span> <span class="p">(</span>
	<span class="s">"fmt"</span>
	<span class="s">"io/ioutil"</span>
	<span class="s">"encoding/hex"</span>
	<span class="s">"crypto/rc4"</span>
<span class="p">)</span>
<span class="k">var</span> <span class="n">RC4_KEY</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">hex</span><span class="o">.</span><span class="n">DecodeString</span><span class="p">(</span><span class="s">"FA5F66D7"</span><span class="p">)</span>

<span class="k">func</span> <span class="n">rc4_decrypt</span><span class="p">(</span><span class="n">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">cipher</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">rc4</span><span class="o">.</span><span class="n">NewCipher</span><span class="p">(</span><span class="n">RC4_KEY</span><span class="p">)</span>
	<span class="n">cipher</span><span class="o">.</span><span class="n">XORKeyStream</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">ioutil</span><span class="o">.</span><span class="n">ReadFile</span><span class="p">(</span><span class="s">"dump"</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">);</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">:=</span> <span class="kt">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>	
		<span class="n">rc4_decrypt</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="m">1</span><span class="o">:</span><span class="n">i</span><span class="o">+</span><span class="n">n</span><span class="o">+</span><span class="m">1</span><span class="p">])</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">n</span><span class="o">+</span><span class="m">1</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And here is the decrypted strings:</p>

<details style="color: #EEFFFF; font-family: monospace !default; font-size: 0.85em; background: #263238; border: 1px solid #263238; border-radius: 3px; padding: 10px; line-height: 2.2; overflow-x: scroll;">
    <summary style="outline: none; cursor: pointer">
        <span style="color: darkgray">
            Expand to see more
        </span><br />
<div style="height: 1px"></div>
&emsp; http://www.msftncsi.com/ncsi.txt<br />
&emsp; Software\Microsoft\Internet Explorer<br />
&emsp; advapi32.dll<br />
&emsp; Location:<br />
&emsp; plugin_size<br />
&emsp; \explorer.exe<br />
&emsp; user32<br />
</summary>
&emsp; advapi32<br />
&emsp; urlmon<br />
&emsp; ole32<br />
&emsp; winhttp<br />
&emsp; ws2_32<br />
&emsp; dnsapi<br />
&emsp; svcVersion<br />
&emsp; Version<br />
&emsp; &amp;lt?xml version="1.0"?&amp;gt&amp;ltscriptlet&amp;gt&amp;ltregistration classid="{00000000-0000-0000-0000-00000000%04X}"&amp;gt&amp;ltscript language="jscript"&amp;gt&amp;lt![CDATA[GetObject("winmgmts:Win32_Process").Create("%ls",null,null,null);]]&amp;gt&amp;lt/script&amp;gt&amp;lt/registration&amp;gt&amp;lt/scriptlet&amp;gt<br />
&emsp; S:(ML;;NW;;;LW)D:(A;;0x120083;;;WD)(A;;0x120083;;;AC)<br />
&emsp; %s\%hs<br />
&emsp; %s%s<br />
&emsp; regsvr32 /s %s<br />
&emsp; regsvr32 /s /n /u /i:"%s" scrobj<br />
&emsp; %APPDATA%<br />
&emsp; %TEMP%<br />
&emsp; .exe<br />
&emsp; .dll<br />
&emsp; :Zone.Identifier<br />
&emsp; POST<br />
&emsp; Content-Type: application/x-www-form-urlencoded<br />
&emsp; runas<br />
&emsp; Host: %s<br />
&emsp; PT10M<br />
&emsp; 1999-11-30T00:00:00<br />
&emsp; NvNgxUpdateCheckDaily_{&#37;08X-&#37;04X-&#37;04X-&#37;04X-&#37;08X&#37;04X}<br />
&emsp; Accept: */*<br />
&emsp; Referer: %S<br />
</details>
<h2 id="encrypted-c2-domains">Encrypted C2 Domains</h2>

<p>The C2 domains are encrypted using simple XOR operations.</p>

<p><a href="/assets/images/malware-analysis/smokeloader/27.png"><img src="/assets/images/malware-analysis/smokeloader/27.png" alt="27" /></a></p>

<p>They are stored in a in this form:</p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/malware-analysis/smokeloader/28.png"><img src="/assets/images/malware-analysis/smokeloader/28.png" alt="28" /></a></td>
      <td><a href="/assets/images/malware-analysis/smokeloader/29.png"><img src="/assets/images/malware-analysis/smokeloader/29.png" alt="29" /></a></td>
    </tr>
  </tbody>
</table>

<p>We can easily decrypt the domains:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">decrypt_c2</span><span class="p">(</span><span class="n">enc</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
	<span class="n">enc</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">enc</span><span class="p">),</span> <span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
	<span class="n">dec</span> <span class="o">=</span> <span class="s">""</span>
	<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">enc</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span> <span class="o">^</span> <span class="n">i</span>
		<span class="n">dec</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">c</span> <span class="o">^</span> <span class="mh">0xE4</span><span class="p">)</span>
	<span class="k">print</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>

<span class="c1"># decrypt_c2("E7FBFBFFB5A0A0E2E0FCFBEAFCFBA2FCEAFDF9E6ECEABFBEBDBABFBAA1FDFAA0", "EFC11A5F")
# http://mostest-service012505.ru/
</span></code></pre></div></div>

<h2 id="c2-communications">C2 Communications</h2>

<p>SmokeLoader sleeps for 10 seconds (1000*10) before connecting to the Internet.</p>

<p><a href="/assets/images/malware-analysis/smokeloader/30.png"><img src="/assets/images/malware-analysis/smokeloader/30.png" alt="30" /></a></p>

<p>First it queries <code class="language-plaintext highlighter-rouge">http://www.msftncsi.com/ncsi.txt</code> (This URL is usually queried by Windows to determine if the computer is connected to the Internet).</p>

<p>If there’s no response, it sleeps for <code class="language-plaintext highlighter-rouge">64 ms</code> and queries it again until it receives a response.</p>

<p>Then SmokeLoader sends a <code class="language-plaintext highlighter-rouge">POST</code> request to the C2 server. The payload is encrypted using <code class="language-plaintext highlighter-rouge">RC4</code> before sending it.</p>

<p>The <code class="language-plaintext highlighter-rouge">POST</code> request returns a <code class="language-plaintext highlighter-rouge">"404 Not Found"</code> response but it contains a payload in the response body.</p>

<p><a href="/assets/images/malware-analysis/smokeloader/31.png"><img src="/assets/images/malware-analysis/smokeloader/31.png" alt="31" /></a></p>

<p>Unfortunately most of the C2 domains are down so I couldn’t proceed with the analysis, but I think that’s enough with SmokeLoader :)</p>

<h1 id="iocs">IOCs</h1>

<h4 id="hashes"><u>Hashes</u></h4>

<p>SmokeLoader fc20b03299b8ae91e72e104ee4f18e40125b2b061f1509d1c5b3f9fac3104934</p>

<h4 id="files"><u>Files</u></h4>

<p>%TEMP%\4dd3.dll</p>

<h4 id="c2-domains"><u>C2 Domains</u></h4>

<p>http://alltest-service012505[.]ru/<br />
http://besttest-service012505[.]ru/<br />
http://biotest-service012505[.]ru/<br />
http://clubtest-service012505[.]ru/<br />
http://domtest-service012505[.]ru/<br />
http://infotest-service012505[.]ru/<br />
http://kupitest-service012505[.]ru/<br />
http://megatest-service012505[.]ru/<br />
http://mirtest-service012505[.]ru/<br />
http://mostest-service012505[.]ru/<br />
http://mytest-service01242505[.]ru/<br />
http://mytest-service012505[.]ru/<br />
http://newtest-service012505[.]ru/<br />
http://proftest-service012505[.]ru/<br />
http://protest-01242505[.]tk/<br />
http://protest-01252505[.]ml/<br />
http://protest-01262505[.]ga/<br />
http://protest-01272505[.]cf/<br />
http://protest-01282505[.]gq/<br />
http://protest-01292505[.]com/<br />
http://protest-01302505[.]net/<br />
http://protest-01312505[.]org/<br />
http://protest-01322505[.]biz/<br />
http://protest-01332505[.]info/<br />
http://protest-01342505[.]eu/<br />
http://protest-01352505[.]nl/<br />
http://protest-01362505[.]mobi/<br />
http://protest-01372505[.]name/<br />
http://protest-01382505[.]me/<br />
http://protest-01392505[.]garden/<br />
http://protest-01402505[.]art/<br />
http://protest-01412505[.]band/<br />
http://protest-01422505[.]bargains/<br />
http://protest-01432505[.]bet/<br />
http://protest-01442505[.]blue/<br />
http://protest-01452505[.]business/<br />
http://protest-01462505[.]casa/<br />
http://protest-01472505[.]city/<br />
http://protest-01482505[.]click/<br />
http://protest-01492505[.]company/<br />
http://protest-01502505[.]futbol/<br />
http://protest-01512505[.]gallery/<br />
http://protest-01522505[.]game/<br />
http://protest-01532505[.]games/<br />
http://protest-01542505[.]graphics/<br />
http://protest-01552505[.]group/<br />
http://protest-02252505[.]ml/<br />
http://protest-02262505[.]ga/<br />
http://protest-02272505[.]cf/<br />
http://protest-02282505[.]gq/<br />
http://protest-03252505[.]ml/<br />
http://protest-03262505[.]ga/<br />
http://protest-03272505[.]cf/<br />
http://protest-03282505[.]gq/<br />
http://protest-05242505[.]tk/<br />
http://protest-06242505[.]tk/<br />
http://protest-service01242505[.]ru/<br />
http://protest-service012505[.]ru/<br />
http://rustest-service012505[.]ru/<br />
http://rutest-service01242505[.]ru/<br />
http://rutest-service012505[.]ru/<br />
http://shoptest-service012505[.]ru/<br />
http://supertest-service012505[.]ru/<br />
http://test-service01242505[.]ru/<br />
http://test-service012505[.]com/<br />
http://test-service012505[.]eu/<br />
http://test-service012505[.]fun/<br />
http://test-service012505[.]host/<br />
http://test-service012505[.]info/<br />
http://test-service012505[.]net/<br />
http://test-service012505[.]net2505[.]ru/<br />
http://test-service012505[.]online/<br />
http://test-service012505[.]org2505[.]ru/<br />
http://test-service012505[.]pp2505[.]ru/<br />
http://test-service012505[.]press/<br />
http://test-service012505[.]pro/<br />
http://test-service012505[.]pw/<br />
http://test-service012505[.]ru[.]com/<br />
http://test-service012505[.]site/<br />
http://test-service012505[.]space/<br />
http://test-service012505[.]store/<br />
http://test-service012505[.]su/<br />
http://test-service012505[.]tech/<br />
http://test-service012505[.]website/<br />
http://test-service012505[.]xyz/<br />
http://test-service01blog2505[.]ru/<br />
http://test-service01club2505[.]ru/<br />
http://test-service01forum2505[.]ru/<br />
http://test-service01info2505[.]ru/<br />
http://test-service01land2505[.]ru/<br />
http://test-service01life2505[.]ru/<br />
http://test-service01plus2505[.]ru/<br />
http://test-service01pro2505[.]ru/<br />
http://test-service01rus2505[.]ru/<br />
http://test-service01shop2505[.]ru/<br />
http://test-service01stroy2505[.]ru/<br />
http://test-service01torg2505[.]ru/<br />
http://toptest-service012505[.]ru/<br />
http://vsetest-service012505[.]ru/<br /></p>

<h1 id="references">References</h1>

<p><a href="https://www.cert.pl/en/news/single/dissecting-smoke-loader/">https://www.cert.pl/en/news/single/dissecting-smoke-loader/</a></p>

<p><a href="https://research.checkpoint.com/2019/2019-resurgence-of-smokeloader/">https://research.checkpoint.com/2019/2019-resurgence-of-smokeloader/</a></p>

<p><a href="https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb">https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb</a></p>

<p><a href="https://www.aldeid.com/wiki/PEB-Process-Environment-Block">https://www.aldeid.com/wiki/PEB-Process-Environment-Block</a></p>

<p><a href="http://www.hexacorn.com/blog/2017/10/26/propagate-a-new-code-injection-trick">http://www.hexacorn.com/blog/2017/10/26/propagate-a-new-code-injection-trick</a></p>

<p><a href="https://modexp.wordpress.com/2018/08/23/process-injection-propagate/">https://modexp.wordpress.com/2018/08/23/process-injection-propagate/</a></p>

<p><a href="https://docs.microsoft.com/en-us/windows/win32/api/winhttp/nf-winhttp-winhttpconnect#examples">https://docs.microsoft.com/en-us/windows/win32/api/winhttp/nf-winhttp-winhttpconnect#examples</a></p>

<p><a href="https://www.crowdstrike.com/blog/maze-ransomware-deobfuscation/">https://www.crowdstrike.com/blog/maze-ransomware-deobfuscation/</a></p>


        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#malware-analysis" class="page__taxonomy-item" rel="tag">Malware Analysis</a>
    
    </span>
  </p>




        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2020-06-21T00:00:00+01:00">June 21, 2020</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/ctf%20writeups/memlabs-lab6/" class="pagination--pager" title="MemLabs - Lab6
">Previous</a>
    
    
      <a href="/malware%20analysis/anubis-banking-malware/" class="pagination--pager" title="Deep Analysis of Anubis Banking Malware
">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->

        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 zakariae Elbouzarazi. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>










  </body>
</html>
