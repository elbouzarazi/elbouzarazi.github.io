<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Deep Analysis of KSLØT Keylogger (Turla APT) - Zakariae el bouzarazi</title>
<meta name="description" content="First I used DIE to see what type of binary we have, It seems that it’s a 64 bit DLL. Next I loaded the dll into pestudio, we can see that is has a small number of imports and readable strings so I suspected that it loads the required functions dynamically (using LoadLibrary and GetProcAddress)… ">


  <meta name="author" content="Zakariae El bouzarazi">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Zakariae el bouzarazi">
<meta property="og:title" content="Deep Analysis of KSLØT Keylogger (Turla APT)">
<meta property="og:url" content="http://localhost:4000/malware%20analysis/ksl0t-keylogger/">


  <meta property="og:description" content="First I used DIE to see what type of binary we have, It seems that it’s a 64 bit DLL. Next I loaded the dll into pestudio, we can see that is has a small number of imports and readable strings so I suspected that it loads the required functions dynamically (using LoadLibrary and GetProcAddress)… ">



  <meta property="og:image" content="http://localhost:4000/assets/images/malware-analysis/ksl0t-keylogger/12.png">





  <meta property="article:published_time" content="2020-02-19T00:00:00+01:00">





  

  


<link rel="canonical" href="http://localhost:4000/malware%20analysis/ksl0t-keylogger/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "zakariae Elbouzarazi",
      "url": "http://localhost:4000/"
    
  }
</script>


  <meta name="google-site-verification" content="J3MnMF94zaZhTUoNtUiRt9cKsr7hiMyTxEdAvQ3GfmY" />





<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Zakariae el bouzarazi Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/site_data/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/site_data/favicon-16x16.png">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/site_data/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          Zakariae el bouzarazi
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/#malware-analysis">Malware Analysis</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#binary-exploitation">Binary Exploitation</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#ctf-writeups">CTF Writeups</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#tutorials">Tutorials</a>
            </li><li class="masthead__menu-item">
              <a href="/categories">All Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/site_data/avatar.jpg" alt="Zakariae El bouzarazi" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Zakariae El bouzarazi</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Malware Analysis &amp; Reverse Engineering Adventures.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="zekuelbouzrazi@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://twitter.com/_n1ghtw0lf" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/zakariae-elbouzarazi-34126b293/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/elbouzarazi" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->

    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Deep Analysis of KSLØT Keylogger (Turla APT)">
    <meta itemprop="description" content="Sample MD5: 59b57bdabee2ce1fb566de51dd92ec94">
    <meta itemprop="datePublished" content="2020-02-19T00:00:00+01:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Deep Analysis of KSLØT Keylogger (Turla APT)
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  5 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>Sample MD5: 59b57bdabee2ce1fb566de51dd92ec94</p>

<p>First I used <strong>DIE</strong> to see what type of binary we have, It seems that it’s a 64 bit DLL.</p>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/1.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/1.png" alt="1" /></a></p>

<p>Next I loaded the dll into <strong>pestudio</strong>, we can see that is has a small number of imports and readable strings so I suspected that it loads the required functions dynamically (using <strong>LoadLibrary</strong> and <strong>GetProcAddress</strong>).</p>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/2.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/2.png" alt="2" /></a></p>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/3.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/3.png" alt="3" /></a></p>

<p>Now let’s fire up IDA and see how it goes.</p>

<p>First we see a call to <strong>sub_1800017D0</strong>.</p>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/4.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/4.png" alt="4" /></a></p>

<p>This function calls a sub routine multiple times with parameters pointing to the <strong>.data</strong> section, so it might be decrypting some data.</p>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/5.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/5.png" alt="5" /></a></p>

<p>If we take a look at <strong>maybe_decrypt</strong> function we can see that it XORs the data with some byte array so we can safely say that it’s a decryption routine.</p>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/6.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/6.png" alt="6" /></a></p>

<p>Here we have two options, we can use a debugger to decrypt the data or we can use <strong>IDA Python</strong> to do that, for simplicity I will use a debugger here. we set a breakpoint after the call and examine the <strong>.data</strong> section in the dump.</p>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/7.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/7.png" alt="7" /></a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Decrypted Data:

..int.......................................................KSL0
.TVer=21.0.._msimm.dat..SPUNINST.....Start.[u]:.[-h GetForegroun
dWindow]:%d......[%02d.%02d.%04d %02d:%02d:%02d.%03d]...[h]:%d..
[-pid GetWindowThreadProcessId]:%d......[-k GetWindowThreadProce
ssId]:%d....[pid]:%d....[-OpenProcess]:%d...[-pn GetModuleFileNa
meEx]:%d....[pn]:%s.....[-t GetWindowText]:%d...[t]:%s..&lt;#RShift
&gt;&lt;#LShift&gt;&lt;#RCtrl&gt;&lt;#LCtrl&gt;&lt;!RShift&gt;&lt;!LShift&gt;&lt;!RCtrl&gt;&lt;!LCtrl&gt;-+[]
\;/`',.&lt;PageUp&gt;&lt;PageDown&gt;&lt;NumLock&gt;&lt;r/&gt;&lt;r*&gt;&lt;r-&gt;&lt;r+&gt;&lt;r1&gt;&lt;r2&gt;&lt;r3&gt;&lt;r
4&gt;&lt;r5&gt;&lt;r6&gt;&lt;r7&gt;&lt;r8&gt;&lt;r9&gt;&lt;r0&gt;&lt;r.&gt;&lt;F1&gt;&lt;F2&gt;&lt;F3&gt;&lt;F4&gt;&lt;F5&gt;&lt;F6&gt;&lt;F7&gt;&lt;F8&gt;&lt;F
9&gt;&lt;F10&gt;&lt;F11&gt;&lt;F12&gt;&lt;Down&gt;&lt;Up&gt;&lt;Right&gt;&lt;Left&gt;&lt;Del&gt;&lt;Print&gt;&lt;End&gt;&lt;Insert
&gt;&lt;CapsLock&gt;&lt;Enter&gt;&lt;Backspace&gt;&lt;Esc&gt;&lt;Tab&gt;.kernel32.dll............n
</code></pre></div></div>

<p>The decrypted data has some strings like <strong>&lt;F1&gt;</strong> ans <strong>&lt;LShift&gt;</strong>, we can assume that they are used to record the keystrokes.</p>

<p>Next we see a call to <strong>GetModuleHandleW</strong> and <strong>GetProcAddress</strong> then the results are passed as arguments along with the qword array <strong>unk_1800105A0</strong> to <strong>sub_1800039C0</strong>. The module is <strong>kernel32.dll</strong> and the proc is <strong>GetProcAddress</strong> handle.</p>

<p><strong>sub_1800039C0</strong> is a huge function and it looks scary at first.</p>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/8.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/8.png" alt="8" /></a></p>

<p>First this function stores the parameters in local variables then it stores some values into the rest of local variables, so far so good.</p>

<p>Next there is a call to <strong>sub_180001000</strong> multiple times with the previously filled local variables as parameters.</p>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/9.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/9.png" alt="9" /></a></p>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/10.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/10.png" alt="10" /></a></p>

<p>Here we can see the data XORed with <strong>0x55</strong> so this function is used to decrypt the values of the local variables.</p>

<p>After the decryption routine we see a call to <strong>GetProcAddress</strong>, using the debugger we can see that it returns a handle to <strong>LoadLibraryA</strong>.</p>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/11.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/11.png" alt="11" /></a></p>

<p>After that it loads the needed libraries then fills the qword array with the needed functions.</p>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/12.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/12.png" alt="12" /></a></p>

<p>To get the imported functions I used the debugger to get them one by one (definitely there is a better option but I’m lazy). Then I used <strong>IDA Python</strong> to rename the addresses with the corresponding function names.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Imported Functions:

"GetProcessImageFileNameW"
"GetForegroundWindow"
"GetWindowThreadProcessId"
"GetWindowTextW"
"GetKeyboardState"
"GetKeyboardLayout"
"ToUnicodeEx"
"MapVirtualKeyExW"
"CallNextHookEx"
"SetWindowsHookExW"
"UnhookWindowsHookEx"
"GetMessageW"
"TranslateMessage"
"DispatchMessageW"
"CommandLineToArgvW"
"swprintf"
"wcsncat"
"wcsstr"
"wcscat"
"malloc"
"memset"
"memcpy"
"strlen"
"wcslen"
"wcsrchr"
"free"
"GetSystemTime"
"GetLastError"
"OpenProcess"
"CreateThread"
"SystemTimeToFileTime"
"FileTimeToSystemTime"
"FileTimeToLocalFileTime"
"CreateMutexW"
"OpenMutexW"
"GetFileSize"
"lstrcatW"
"GetModuleFileNameW"
"FindFirstFileW"
"FindClose"
"CreateFileW"
"SetFilePointer"
"WriteFile"
"CloseHandle"
"GetProcAddress"
"LoadLibraryA"
"GetUserNameExW"
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">idc</span>

<span class="n">base</span> <span class="o">=</span> <span class="mh">0x1800105A0</span>

<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">"GetProcessImageFileNameW"</span><span class="p">,</span> <span class="s">"GetForegroundWindow"</span><span class="p">,</span> <span class="s">"GetWindowThreadProcessId"</span><span class="p">,</span> 
         <span class="s">"GetWindowTextW"</span><span class="p">,</span> <span class="s">"GetKeyboardState"</span><span class="p">,</span> <span class="s">"GetKeyboardLayout"</span><span class="p">,</span> <span class="s">"ToUnicodeEx"</span><span class="p">,</span>
         <span class="s">"MapVirtualKeyExW"</span><span class="p">,</span> <span class="s">"CallNextHookEx"</span><span class="p">,</span> <span class="s">"SetWindowsHookExW"</span><span class="p">,</span> <span class="s">"UnhookWindowsHookEx"</span><span class="p">,</span>
         <span class="s">"GetMessageW"</span><span class="p">,</span> <span class="s">"TranslateMessage"</span><span class="p">,</span> <span class="s">"DispatchMessageW"</span><span class="p">,</span> <span class="s">"CommandLineToArgvW"</span><span class="p">,</span>
         <span class="s">"swprintf"</span><span class="p">,</span> <span class="s">"wcsncat"</span><span class="p">,</span> <span class="s">"wcsstr"</span><span class="p">,</span> <span class="s">"wcscat"</span><span class="p">,</span> <span class="s">"malloc"</span><span class="p">,</span> <span class="s">"memset"</span><span class="p">,</span> <span class="s">"memcpy"</span><span class="p">,</span> <span class="s">"strlen"</span><span class="p">,</span>
         <span class="s">"wcslen"</span><span class="p">,</span> <span class="s">"wcsrchr"</span><span class="p">,</span> <span class="s">"free"</span><span class="p">,</span> <span class="s">"GetSystemTime"</span><span class="p">,</span> <span class="s">"GetLastError"</span><span class="p">,</span> <span class="s">"OpenProcess"</span><span class="p">,</span> 
         <span class="s">"CreateThread"</span><span class="p">,</span> <span class="s">"SystemTimeToFileTime"</span><span class="p">,</span> <span class="s">"FileTimeToSystemTime"</span><span class="p">,</span> <span class="s">"FileTimeToLocalFileTime"</span><span class="p">,</span>
         <span class="s">"CreateMutexW"</span><span class="p">,</span> <span class="s">"OpenMutexW"</span><span class="p">,</span> <span class="s">"GetFileSize"</span><span class="p">,</span> <span class="s">"lstrcatW"</span><span class="p">,</span> <span class="s">"GetModuleFileNameW"</span><span class="p">,</span> 
         <span class="s">"FindFirstFileW"</span><span class="p">,</span> <span class="s">"FindClose"</span><span class="p">,</span><span class="s">"CreateFileW"</span><span class="p">,</span> <span class="s">"SetFilePointer"</span><span class="p">,</span> <span class="s">"WriteFile"</span><span class="p">,</span> <span class="s">"CloseHandle"</span><span class="p">,</span>
         <span class="s">"GetProcAddress"</span><span class="p">,</span> <span class="s">"LoadLibraryA"</span><span class="p">,</span> <span class="s">"GetUserNameExW"</span><span class="p">]</span>

<span class="n">offsets</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> 
           <span class="mi">43</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span>
           <span class="mi">29</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">35</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">47</span><span class="p">):</span>
	<span class="n">idc</span><span class="p">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">offsets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="s">'__'</span> <span class="o">+</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</code></pre></div></div>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/14.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/14.png" alt="14" /></a></p>

<p>Viola!!! great success, now for reversing the real keylogger functionality.</p>

<p>Back to the main function, the malware gets the username and domain name of the machine then creates a <strong>Mutex</strong> with the name DOMAIN_NAME.USER_NAME (in my case it was IEUSER-PC.IEUSER).</p>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/15.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/15.png" alt="15" /></a></p>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/16.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/16.png" alt="16" /></a></p>

<p>The last call is to <strong>sub_180003960</strong> which create a new thread with a starting address at <strong>sub_180001B70</strong></p>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/17.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/17.png" alt="17" /></a></p>

<p>This function listens for windows messages (keystrokes in this case), but first it calls <strong>setup_the_hook</strong> function.</p>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/18.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/18.png" alt="18" /></a></p>

<p>This function sets up the keyboard hook with the callback <strong>keyboardProc</strong>.</p>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/19.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/19.png" alt="19" /></a></p>

<p>The callback function deals with all the keyboard keys with a huge switch statement. Each block of this switch loads the <strong>keyboard_consts</strong> character array (which was decrypted earlier while decrypting the .data section) then adds an offset to this consts array to get the right character for the corresponding key and concatenates it with the <strong>keystroke</strong> variable. This variable is passed as a parameter along with it’s length to <strong>sub_180001100</strong> which I suspect is the logging function.</p>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/20.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/20.png" alt="20" /></a></p>

<p>This function is quite long and complex but we can see a call to <strong>WriteFIle</strong> at the end of it, also note the loop with XORing which indicates that the logs are encrypted before being written.</p>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/21.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/21.png" alt="21" /></a></p>

<p>Moving up we can see the call to <strong>CreateFileW</strong>, to get the new file path we can let the malware run in x64dbg.</p>

<p>The malware creates a file with the name <strong>msimm.dat</strong> (which was in the decrypted .data section) in the same directory of the malware.</p>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/22.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/22.png" alt="22" /></a></p>

<p>If we take a look at the created file we see some garbage because the file was encrypted before being written.</p>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/23.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/23.png" alt="23" /></a></p>

<p>We can write a small script to decrypt this file using the encryption keys.</p>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/24.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/24.png" alt="24" /></a></p>

<p>The encryption process is just XOR with the encryption keys.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">encryption_keys</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> 
                   <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0xdd</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span>
                   <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span>
                   <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span>
                   <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span>
                   <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
                   <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span>
                   <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">]</span>

<span class="n">decrypted_data</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"msimm.dat"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
	<span class="n">data</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
		<span class="n">decrypted_data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">^</span><span class="n">encryption_keys</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
		<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">100</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"decrypted.dat"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
	<span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">decrypted_data</span><span class="p">))</span>
</code></pre></div></div>

<p>Looking at the decrypted file:</p>

<p><a href="/assets/images/malware-analysis/ksl0t-keylogger/26.png"><img src="/assets/images/malware-analysis/ksl0t-keylogger/26.png" alt="26" /></a></p>

<p>Great!!! We can see the logs for each process and that wraps up this analysis.</p>

<h2 id="iocs">IOCs:</h2>

<h3 id="hashes"><u>Hashes:</u></h3>

<p>The keylogger: 59b57bdabee2ce1fb566de51dd92ec94</p>

<h3 id="mutexes"><u>Mutexes:</u></h3>

<p>$DOMAIN_NAME.$USER_NAME</p>

<h3 id="files"><u>Files:</u></h3>

<p>msimm.dat</p>

        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#malware-analysis" class="page__taxonomy-item" rel="tag">Malware Analysis</a>
    
    </span>
  </p>




        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2020-02-19T00:00:00+01:00">February 19, 2020</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/binary%20exploitation/final-one/" class="pagination--pager" title="Phoenix - Final One
">Previous</a>
    
    
      <a href="/malware%20analysis/phobos-ransomware/" class="pagination--pager" title="Deep Analysis of Phobos Ransomware
">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->

        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 zakariae Elbouzarazi. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>










  </body>
</html>
