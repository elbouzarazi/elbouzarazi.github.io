<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Deep Analysis of GCleaner - Zakariae el bouzarazi</title>
<meta name="description" content="GCleaner is a Pay-Per-Install (PPI) loader first discovered in early 2019, it has been used to deploy other malicious families like… ">


  <meta name="author" content="Zakariae El bouzarazi">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Zakariae el bouzarazi">
<meta property="og:title" content="Deep Analysis of GCleaner">
<meta property="og:url" content="https://github.com/elbouzarazi/elbouzarazi.github.io/pages/elbouzarazi/malware%20analysis/gcleaner-loader/">


  <meta property="og:description" content="GCleaner is a Pay-Per-Install (PPI) loader first discovered in early 2019, it has been used to deploy other malicious families like… ">



  <meta property="og:image" content="https://github.com/elbouzarazi/elbouzarazi.github.io/pages/elbouzarazi/assets/images/malware-analysis/gcleaner/logo.png">





  <meta property="article:published_time" content="2023-07-15T00:00:00+01:00">





  

  


<link rel="canonical" href="https://github.com/elbouzarazi/elbouzarazi.github.io/pages/elbouzarazi/malware%20analysis/gcleaner-loader/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "zakariae Elbouzarazi",
      "url": "https://github.com/elbouzarazi/elbouzarazi.github.io/pages/elbouzarazi/"
    
  }
</script>


  <meta name="google-site-verification" content="J3MnMF94zaZhTUoNtUiRt9cKsr7hiMyTxEdAvQ3GfmY" />





<!-- end _includes/seo.html -->


<link href="/pages/elbouzarazi/feed.xml" type="application/atom+xml" rel="alternate" title="Zakariae el bouzarazi Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/pages/elbouzarazi/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/site_data/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/site_data/favicon-16x16.png">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/pages/elbouzarazi/"><img src="/pages/elbouzarazi/assets/images/site_data/logo.png" alt=""></a>
        
        <a class="site-title" href="/pages/elbouzarazi/">
          Zakariae el bouzarazi
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/pages/elbouzarazi/categories/#malware-analysis">Malware Analysis</a>
            </li><li class="masthead__menu-item">
              <a href="/pages/elbouzarazi/categories/#binary-exploitation">Binary Exploitation</a>
            </li><li class="masthead__menu-item">
              <a href="/pages/elbouzarazi/categories/#ctf-writeups">CTF Writeups</a>
            </li><li class="masthead__menu-item">
              <a href="/pages/elbouzarazi/categories/#tutorials">Tutorials</a>
            </li><li class="masthead__menu-item">
              <a href="/pages/elbouzarazi/categories">All Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/pages/elbouzarazi/assets/images/site_data/avatar.jpg" alt="Zakariae El bouzarazi" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Zakariae El bouzarazi</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Malware Analysis &amp; Reverse Engineering Adventures.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="zekuelbouzrazi@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://twitter.com/_n1ghtw0lf" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/zakariae-elbouzarazi-34126b293/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/elbouzarazi" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Deep Analysis of GCleaner">
    <meta itemprop="description" content="Howdy! I’m finally back with another malware deep dive report. This time we are digging into GCleaner.">
    <meta itemprop="datePublished" content="2023-07-15T00:00:00+01:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Deep Analysis of GCleaner
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  10 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#initial-triage">Initial Triage</a></li>
  <li><a href="#string-decryption">String Decryption</a></li>
  <li><a href="#anti-checks-or-is-it">Anti Checks (or is it..?)</a>
    <ul>
      <li><a href="#checking-username">Checking username</a></li>
      <li><a href="#checking-foreground-window">Checking foreground window</a></li>
      <li><a href="#checking-desktop-files">Checking desktop files</a></li>
      <li><a href="#checking-locale-and-keyboard-layout">Checking locale and keyboard layout</a></li>
    </ul>
  </li>
  <li><a href="#dropped-binary">Dropped Binary</a></li>
  <li><a href="#c2-communications">C2 Communications</a>
    <ul>
      <li><a href="#first-c2">First C2</a></li>
      <li><a href="#second-c2">Second C2</a></li>
      <li><a href="#third-c2">Third C2</a></li>
      <li><a href="#forth-c2">Forth C2</a></li>
    </ul>
  </li>
  <li><a href="#config-extraction">Config Extraction</a></li>
  <li><a href="#hunting">Hunting</a>
    <ul>
      <li><a href="#urlscan">Urlscan</a></li>
      <li><a href="#yara">Yara</a></li>
    </ul>
  </li>
  <li><a href="#references">References</a></li>
</ul>

            </nav>
          </aside>
        
        <p>Howdy! I’m finally back with another malware deep dive report. This time we are digging into GCleaner.</p>

<p>GCleaner is a Pay-Per-Install (PPI) loader <a href="https://medium.com/csis-techblog/gcleaner-garbage-provider-since-2019-2708e7c87a8a">first discovered</a> in early 2019, it has been used to deploy other malicious families like Smokeloader, Amadey, Redline and Raccoon.</p>

<p>We will be working on this sample:</p>

<p>(SHA256: <code class="language-plaintext highlighter-rouge">020d370b51711b0814901d7cc32d8251affcc3506b9b4c15db659f3dbb6a2e6b</code>)</p>

<h1 id="initial-triage">Initial Triage</h1>

<p>Let’s start by running the sample in <a href="https://tria.ge/230711-rx3c1saf31">Triage sandbox</a> to get an overview of what it does.</p>

<p>We can see from the process tree that it drops and runs another binary out of <code class="language-plaintext highlighter-rouge">"%APPDATA%"</code> folder with a seemingly random name then it kills itself using <code class="language-plaintext highlighter-rouge">"taskkill"</code> and deletes the sample binary from disk.</p>

<p><a href="/assets/images/malware-analysis/gcleaner/1.png"><img src="/assets/images/malware-analysis/gcleaner/1.png" alt="1" /></a></p>

<p>The network tab shows communications to different IP addresses which are considered as C2 servers in Triage’s malware config tab. Each C2 has a different URL path, we will dig deeper to find out what each of them is responsible for.</p>

<p><a href="/assets/images/malware-analysis/gcleaner/2.png"><img src="/assets/images/malware-analysis/gcleaner/2.png" alt="2" /></a></p>

<p>Right when we open the sample in IDA we don’t have much to look at, there are some interesting strings and API imports but not very helpful to start with.</p>

<p>We can see a repeated pattern across the code where some values are pushed into the stack then xored with <code class="language-plaintext highlighter-rouge">0x2E</code>, so we first need to decrypt these values.</p>

<p><a href="/assets/images/malware-analysis/gcleaner/3.png"><img src="/assets/images/malware-analysis/gcleaner/3.png" alt="3" /></a></p>

<h1 id="string-decryption">String Decryption</h1>

<p>Automating the decryption for stack strings in this sample can be a bit tricky, luckily I noticed a specific instruction that occurs after loading the encrypted strings into stack (<code class="language-plaintext highlighter-rouge">cmp      eax, [reg+4]</code>).</p>

<p><a href="/assets/images/malware-analysis/gcleaner/4.png"><img src="/assets/images/malware-analysis/gcleaner/4.png" alt="4" /></a></p>

<p>So we can find all occurrences of this instruction then walk back to find the <code class="language-plaintext highlighter-rouge">mov</code> instructions and get the encrypted values. Let’s apply this to an IDA python script.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Lowest address used in the program
</span><span class="n">addr</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">get_inf_attr</span><span class="p">(</span><span class="n">INF_MIN_EA</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="c1"># Search for "cmp eax, [reg+4]"
</span>    <span class="n">addr</span> <span class="o">=</span> <span class="n">ida_search</span><span class="p">.</span><span class="n">find_binary</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">idc</span><span class="p">.</span><span class="n">BADADDR</span><span class="p">,</span> <span class="s">"3B ?? 04 00 00 00"</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">ida_search</span><span class="p">.</span><span class="n">SEARCH_NEXT</span> <span class="o">|</span> <span class="n">ida_search</span><span class="p">.</span><span class="n">SEARCH_DOWN</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">addr</span> <span class="o">==</span> <span class="n">idc</span><span class="p">.</span><span class="n">BADADDR</span><span class="p">:</span>
        <span class="k">break</span>

    <span class="n">enc_bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s">''</span>
    <span class="c1"># Search for possible stack strings in the previous 12 instructions
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
        <span class="n">ea</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">prev_head</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">==</span> <span class="s">"mov"</span> <span class="ow">and</span>
            <span class="n">idc</span><span class="p">.</span><span class="n">get_operand_type</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">idc</span><span class="p">.</span><span class="n">o_displ</span> <span class="ow">and</span>
            <span class="n">idc</span><span class="p">.</span><span class="n">get_operand_type</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">idc</span><span class="p">.</span><span class="n">o_imm</span><span class="p">):</span>
            <span class="c1"># Get the value of the second operand
</span>            <span class="n">operand_value</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>The returned operand value is an integer but we need to store it as a byte array, so we first need to figure out the size of that operand to store it correctly.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="c1"># Get the size of the second operand
</span>            <span class="n">insn</span> <span class="o">=</span> <span class="n">ida_ua</span><span class="p">.</span><span class="n">insn_t</span><span class="p">()</span>
            <span class="n">ida_ua</span><span class="p">.</span><span class="n">decode_insn</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">ea</span><span class="p">)</span>
            <span class="n">operand_size</span> <span class="o">=</span> <span class="n">ida_ua</span><span class="p">.</span><span class="n">get_dtype_size</span><span class="p">(</span><span class="n">insn</span><span class="p">.</span><span class="n">Op2</span><span class="p">.</span><span class="n">dtype</span><span class="p">)</span>
            
            <span class="c1"># Specify the correct data type
</span>            <span class="k">if</span> <span class="n">operand_size</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">operand_bytes</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"&lt;I"</span><span class="p">,</span> <span class="n">operand_value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">operand_size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">operand_bytes</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"&lt;H"</span><span class="p">,</span> <span class="n">operand_value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">operand_bytes</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"&lt;B"</span><span class="p">,</span> <span class="n">operand_value</span><span class="p">)</span>
                
            <span class="n">enc_bytes</span> <span class="o">=</span> <span class="n">operand_bytes</span> <span class="o">+</span> <span class="n">enc_bytes</span>
</code></pre></div></div>

<p>One more thing I noticed is that some strings use a combination of stack values and other values stored in the <code class="language-plaintext highlighter-rouge">".rdata"</code> section (retrieved using the XMM instruction <code class="language-plaintext highlighter-rouge">"movaps"</code>).</p>

<p><a href="/assets/images/malware-analysis/gcleaner/5.png"><img src="/assets/images/malware-analysis/gcleaner/5.png" alt="5" /></a></p>

<p>So we can search for this <code class="language-plaintext highlighter-rouge">"movaps"</code> instruction after the <code class="language-plaintext highlighter-rouge">"cmp"</code> instruction, if found we can read the values stored at its operand address and append it to the encrypted bytes.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># Find possible xmmword movaps
</span>    <span class="n">xmmword_addr</span> <span class="o">=</span> <span class="n">ida_search</span><span class="p">.</span><span class="n">find_binary</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">+</span><span class="mi">50</span><span class="p">,</span> <span class="n">pattern2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">ida_search</span><span class="p">.</span><span class="n">SEARCH_NEXT</span> <span class="o">|</span> <span class="n">ida_search</span><span class="p">.</span><span class="n">SEARCH_DOWN</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">xmmword_addr</span> <span class="o">!=</span> <span class="n">idc</span><span class="p">.</span><span class="n">BADADDR</span><span class="p">:</span>
        <span class="c1"># Read the xmmword value
</span>        <span class="n">xmmword_value</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">get_bytes</span><span class="p">(</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">xmmword_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">enc_bytes</span> <span class="o">=</span> <span class="n">xmmword_value</span> <span class="o">+</span> <span class="n">enc_bytes</span>
</code></pre></div></div>

<p>Finally we can xor the encrypted values with <code class="language-plaintext highlighter-rouge">0x2E</code> (this key has been the same for all GCleaner samples I looked at).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># Decrypt and strip encrypted bytes
</span>    <span class="n">dec_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">c</span> <span class="o">^</span> <span class="mh">0x2E</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">enc_bytes</span><span class="p">)</span>
    <span class="n">dec_str</span> <span class="o">=</span> <span class="n">dec_bytes</span><span class="p">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">).</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
   
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dec_str</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="si">}</span><span class="s"> --&gt; </span><span class="si">{</span><span class="n">dec_str</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

        <span class="c1"># Set a comment with the decrypted string
</span>        <span class="k">if</span> <span class="n">dec_str</span> <span class="ow">and</span> <span class="n">comment_addr</span> <span class="o">!=</span> <span class="n">idc</span><span class="p">.</span><span class="n">BADADDR</span><span class="p">:</span>
            <span class="n">set_comment</span><span class="p">(</span><span class="n">comment_addr</span><span class="p">,</span> <span class="n">dec_str</span><span class="p">)</span>
</code></pre></div></div>

<p>Here is the list of decrypted strings:</p>

<details style="color: #EEFFFF; font-family: monospace !default; font-size: 0.85em; background: #263238; border: 1px solid #263238; border-radius: 3px; padding: 10px; line-height: 1.8">
    <summary style="outline: none; cursor: pointer">
        <span style="color: darkgray">
            Expand to see more
        </span><br />
&emsp; 45.12.253.56<br />
&emsp; 45.12.253.72<br />
&emsp; 45.12.253.98<br />
&emsp; 45.12.253.75/dll.php<br />
&emsp; mixinte<br />
&emsp; mixtwo<br />
</summary>
&emsp; B<br />
&emsp; USERPROFILE<br />
&emsp; CCleaner<br />
&emsp; VLC media player<br />
&emsp; Acrobat Reader DC<br />
&emsp; Russian<br />
&emsp; admin<br />
&emsp; Shah<br />
&emsp; testBench<br />
&emsp; taskmgr<br />
&emsp; Taskmgr<br />
&emsp; wireshark<br />
&emsp; Process Hacker<br />
&emsp; Wireshark<br />
&emsp; C:\Program Files<br />
&emsp; C:\ProgramData<br />
&emsp; C:\Temp<br />
&emsp; C:\Program Files<br />
&emsp; C:\ProgramData<br />
&emsp; C:\Temp<br />
&emsp; /advertisting/plus.php?s=<br />
&emsp; &amp;str=mixtwo<br />
&emsp; &amp;substr=<br />
&emsp; /default/stuk.php<br />
&emsp; /default/puk.php<br />
&emsp; NOSUB<br />
&emsp; chk<br />
&emsp; /chk<br />
&emsp; test<br />
</details>
<p>We can now see the C2 IPs, URL paths and some other interesting strings. Let’s keep going.</p>

<h1 id="anti-checks-or-is-it">Anti Checks (or is it..?)</h1>

<p>GCleaner is filled with host checks but weirdly enough it doesn’t do anything them, maybe they were like test features? copy-paste code? not really sure but let’s quickly go though them.</p>

<h2 id="checking-username">Checking username</h2>

<p>Get the current username using <code class="language-plaintext highlighter-rouge">"GetUserNameA()"</code> and compare it to hardcoded names (<code class="language-plaintext highlighter-rouge">"admin"</code>, <code class="language-plaintext highlighter-rouge">"Shah"</code>, <code class="language-plaintext highlighter-rouge">"testBench"</code>).</p>

<h2 id="checking-foreground-window">Checking foreground window</h2>

<p>Get the title of the foreground window using <code class="language-plaintext highlighter-rouge">"GetWindowTextA()"</code> and compare it to hardcoded strings.</p>

<p><a href="/assets/images/malware-analysis/gcleaner/6.png"><img src="/assets/images/malware-analysis/gcleaner/6.png" alt="6" /></a></p>

<h2 id="checking-desktop-files">Checking desktop files</h2>

<p>Search for Desktop files with specific strings in their name (<code class="language-plaintext highlighter-rouge">"CCleaner"</code>, <code class="language-plaintext highlighter-rouge">"VLC media player"</code>, <code class="language-plaintext highlighter-rouge">"Acrobat Reader DC"</code>).</p>

<h2 id="checking-locale-and-keyboard-layout">Checking locale and keyboard layout</h2>

<p>Check if the computer locale is Russian and compare the keyboard layout against specific values (CIS countries).</p>

<p><a href="/assets/images/malware-analysis/gcleaner/7.png"><img src="/assets/images/malware-analysis/gcleaner/7.png" alt="7" /></a></p>

<h1 id="dropped-binary">Dropped Binary</h1>

<p>Looking back at the process tree we need to figure out where does that child binary with random name comes from.
<code class="language-plaintext highlighter-rouge">"%APPDATA%\{846ee340-7039-11de-9d20-806e6f6e6963}\34LMAylZs6FixF.exe"</code></p>

<p>We can see below that the sample reads the <code class="language-plaintext highlighter-rouge">"%APPDATA%"</code> path using <code class="language-plaintext highlighter-rouge">"getenv()"</code> then creates a random directory using the GUID of the current hardware profile, if retrieving the hardware profile failed it will fall back to generating a random folder name. Other possible locations for creating the random directory are <code class="language-plaintext highlighter-rouge">"C:\Program Files"</code>, <code class="language-plaintext highlighter-rouge">"C:\Temp"</code>, <code class="language-plaintext highlighter-rouge">"C:\ProgramData"</code> (fallback locations).</p>

<p><a href="/assets/images/malware-analysis/gcleaner/8.png"><img src="/assets/images/malware-analysis/gcleaner/8.png" alt="8" /></a></p>

<p>Next it generates a random file name, appends <code class="language-plaintext highlighter-rouge">".exe"</code> extension to it then drops it to the newly created directory and runs it from there.</p>

<p>The binary file is hardcoded into the parent sample.</p>

<p><a href="/assets/images/malware-analysis/gcleaner/9.png"><img src="/assets/images/malware-analysis/gcleaner/9.png" alt="9" /></a></p>

<p>All that binary child does is…well…sleep for 10 seconds, that’s it :|</p>

<p><a href="/assets/images/malware-analysis/gcleaner/10.png"><img src="/assets/images/malware-analysis/gcleaner/10.png" alt="10" /></a></p>

<h1 id="c2-communications">C2 Communications</h1>

<p>The actors behind GCleaner have been known to use <a href="https://medium.com/csis-techblog/inside-view-of-brazzzersff-infrastructure-89b9188fd145">BraZZZers fast flux</a> service to hide their infrastructure, it works more like a proxy system between the victims and the real C2 server.</p>

<p>Before reaching out to the C2 servers, GCleaner adds hardcoded HTTP headers (could be used for a network sig) an a custom user-agent to each C2 request.</p>

<p><a href="/assets/images/malware-analysis/gcleaner/11.png"><img src="/assets/images/malware-analysis/gcleaner/11.png" alt="11" /></a></p>

<p>Now to figure out what each C2 request is responsible for.</p>

<h2 id="first-c2">First C2</h2>

<ul>
  <li>IP: <code class="language-plaintext highlighter-rouge">45[.]12.253.56</code></li>
  <li>UA: <code class="language-plaintext highlighter-rouge">OK</code></li>
  <li>PCAP:</li>
</ul>

<p><a href="/assets/images/malware-analysis/gcleaner/12.png"><img src="/assets/images/malware-analysis/gcleaner/12.png" alt="12" /></a></p>

<p>This C2 is likely responsible for bot registration. The sample will only continue execution if the server response is <code class="language-plaintext highlighter-rouge">"0"</code> or <code class="language-plaintext highlighter-rouge">"1"</code>, otherwise it goes to sleep and tries again.</p>

<p><a href="/assets/images/malware-analysis/gcleaner/13.png"><img src="/assets/images/malware-analysis/gcleaner/13.png" alt="13" /></a></p>

<p>The <code class="language-plaintext highlighter-rouge">"str"</code> and <code class="language-plaintext highlighter-rouge">"substr"</code> parameters in the C2 request above are possibly referring to the campaign ID, GCleaner has been known to use similar values in the past like <code class="language-plaintext highlighter-rouge">"usone"</code>, <code class="language-plaintext highlighter-rouge">"ustwo"</code>, <code class="language-plaintext highlighter-rouge">"euthree"</code>, <code class="language-plaintext highlighter-rouge">"cafive"</code>, <code class="language-plaintext highlighter-rouge">"mixshop"</code>, …</p>

<h2 id="second-c2">Second C2</h2>

<ul>
  <li>IP: <code class="language-plaintext highlighter-rouge">45[.]12.253.72</code></li>
  <li>UA: <code class="language-plaintext highlighter-rouge">OK</code></li>
  <li>PCAP:</li>
</ul>

<p><a href="/assets/images/malware-analysis/gcleaner/14.png"><img src="/assets/images/malware-analysis/gcleaner/14.png" alt="14" /></a></p>

<p>The first request to this C2 is responsible for getting an AES key.</p>

<p><a href="/assets/images/malware-analysis/gcleaner/15.png"><img src="/assets/images/malware-analysis/gcleaner/15.png" alt="15" /></a></p>

<p>The key length must be between 10 and 100 bytes, otherwise it breaks the execution.</p>

<p><a href="/assets/images/malware-analysis/gcleaner/16.png"><img src="/assets/images/malware-analysis/gcleaner/16.png" alt="16" /></a></p>

<p>The second request is responsible for getting an AES encrypted PE file (notice the filename in the response headers!), That PE file is decrypted using the key from the previous request.</p>

<p><a href="/assets/images/malware-analysis/gcleaner/17.png"><img src="/assets/images/malware-analysis/gcleaner/17.png" alt="17" /></a></p>

<p>The decryption routine is pretty trivial, the sample first calculates the SHA256 hash of the server key then derives the session key used for decryption (AES_128).</p>

<p><a href="/assets/images/malware-analysis/gcleaner/18.png"><img src="/assets/images/malware-analysis/gcleaner/18.png" alt="18" /></a></p>

<p>After that it loads the decrypted PE file into memory (without touching disk) to get the address of an export function called <code class="language-plaintext highlighter-rouge">"GetLicInfo"</code> which is used in the next stage.</p>

<p><a href="/assets/images/malware-analysis/gcleaner/19.png"><img src="/assets/images/malware-analysis/gcleaner/19.png" alt="19" /></a></p>

<h3 id="downloaded-dll">Downloaded DLL</h3>

<p>Before going further we first need to take a look at the downloaded PE file. To be able to analyze it we can either use the debugger to dump the decrypted file or get the encrypted response from the PCAP and decrypt it manually.</p>

<p>We can easily implement the decryption code in Python as follow:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>

<span class="n">enc</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"puk.php.bin"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">).</span><span class="n">read</span><span class="p">()</span>

<span class="n">key</span> <span class="o">=</span> <span class="s">"kvQoRqtcCyMtHmQyQXOUu"</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"utf-16le"</span><span class="p">)</span> <span class="c1"># Important to encode!!
</span><span class="n">sha256_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="n">aes_key</span> <span class="o">=</span> <span class="n">sha256_hash</span><span class="p">.</span><span class="n">digest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]</span>

<span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">aes_key</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">IV</span><span class="o">=</span><span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span>
<span class="n">dec</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>

<span class="nb">open</span><span class="p">(</span><span class="s">"out.bin"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">).</span><span class="n">write</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
</code></pre></div></div>

<p>Now let’s see what this export function <code class="language-plaintext highlighter-rouge">"GetLicInfo"</code> does.</p>

<p>Basically it sends an http request to the supplied C2 server then checks the response length, if the length is greater than 2048 bytes it creates a a new directory with a random name under <code class="language-plaintext highlighter-rouge">"%APPDATA%"</code> or <code class="language-plaintext highlighter-rouge">"%TEMP%"</code> folder then generates a random filename and appends <code class="language-plaintext highlighter-rouge">".exe"</code> extension to it.</p>

<p><a href="/assets/images/malware-analysis/gcleaner/20.png"><img src="/assets/images/malware-analysis/gcleaner/20.png" alt="20" /></a></p>

<p>Finally it writes the server response to a disk file with the generated random filename and executes that file.</p>

<p><a href="/assets/images/malware-analysis/gcleaner/21.png"><img src="/assets/images/malware-analysis/gcleaner/21.png" alt="21" /></a></p>

<h2 id="third-c2">Third C2</h2>

<ul>
  <li>IP: <code class="language-plaintext highlighter-rouge">45[.]12.253.75</code></li>
  <li>UA: <code class="language-plaintext highlighter-rouge">B</code></li>
  <li>PCAP:</li>
</ul>

<p><a href="/assets/images/malware-analysis/gcleaner/22.png"><img src="/assets/images/malware-analysis/gcleaner/22.png" alt="22" /></a></p>

<p>This C2 is responsible for downloading further payloads, notice the user-agent used here is the one from the decrypted strings list unlike the previous 2 C2s.</p>

<p>The address is supplied to the external function <code class="language-plaintext highlighter-rouge">"GetLicInfo"</code> which downloads and executes the payload as we stated above. GCleaner tries to get a payload from the server for 10 iterations with a sleep period of 2 seconds between every try.</p>

<p><a href="/assets/images/malware-analysis/gcleaner/23.png"><img src="/assets/images/malware-analysis/gcleaner/23.png" alt="23" /></a></p>

<p>If no further payload is received from the server the samples kills its process and deletes the parent file from disk.</p>

<p><a href="/assets/images/malware-analysis/gcleaner/24.png"><img src="/assets/images/malware-analysis/gcleaner/24.png" alt="24" /></a></p>

<h2 id="forth-c2">Forth C2</h2>

<ul>
  <li>IP: <code class="language-plaintext highlighter-rouge">45[.]12.253.98</code></li>
</ul>

<p>This C2 wasn’t used in the sample we are looking at.</p>

<h1 id="config-extraction">Config Extraction</h1>

<p>We can use the IDA python script we used for string decryption to build a standalone config extractor as most of the interesting stuff are in the decrypted strings list.</p>

<p>Here’s the output of the code after extracting the useful information:</p>

<p><a href="/assets/images/malware-analysis/gcleaner/25.png"><img src="/assets/images/malware-analysis/gcleaner/25.png" alt="25" /></a></p>

<p>The code can be found <a href="https://github.com/n1ght-w0lf/MalwareAnalysis/tree/master/GCleaner">here</a>.</p>

<p>(this script is not optimized for production, it’s just for research purposes)</p>

<h1 id="hunting">Hunting</h1>

<h2 id="urlscan">Urlscan</h2>

<p>The URL path of the first C2 request can be a good candidate to hunt for more C2s on urlscan.</p>

<p>I looked at more samples and found these two URL patterns:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">s=NOSUB&amp;str=...&amp;substr=...</code></li>
  <li><code class="language-plaintext highlighter-rouge">sub=NOSUB&amp;stream=...&amp;substream=...</code></li>
</ul>

<p>So we can use the <code class="language-plaintext highlighter-rouge">"page.url"</code> field to <a href="https://urlscan.io/search/#page.url%3A%22sub%3DNOSUB%26stream%3D%22%20%7C%7C%20page.url%3A%22s%3DNOSUB%26str%3D%22">search</a> for the first part of these patterns.</p>

<p><a href="/assets/images/malware-analysis/gcleaner/26.png"><img src="/assets/images/malware-analysis/gcleaner/26.png" alt="26" /></a></p>

<h2 id="yara">Yara</h2>

<p>We saw that many strings were encrypted but we can use some of the hardcoded ones to create a simple yara rule for hunting more samples.</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">rule</span> <span class="nt">GCleaner</span> <span class="p">{</span>
    <span class="py">meta</span><span class="p">:</span>
        <span class="n">description</span> <span class="err">=</span> <span class="s1">"Detects GCleaner payload"</span>
        <span class="n">author</span> <span class="err">=</span> <span class="s1">"Abdallah Elshinbary (@_n1ghtw0lf)"</span>
        <span class="n">hash1</span> <span class="err">=</span> <span class="s1">"020d370b51711b0814901d7cc32d8251affcc3506b9b4c15db659f3dbb6a2e6b"</span>
        <span class="n">hash2</span> <span class="err">=</span> <span class="s1">"73ed1926e850a9a076a8078932e76e1ac5f109581996dd007f00681ae4024baa"</span>

    <span class="n">strings</span><span class="p">:</span>
        <span class="p">//</span> <span class="n">Kill</span> <span class="n">self</span>
        <span class="err">$</span><span class="n">s1</span>  <span class="err">=</span> <span class="s1">"\" &amp; exit"</span> <span class="n">ascii</span> <span class="n">fullword</span>
        <span class="err">$</span><span class="n">s2</span>  <span class="err">=</span> <span class="s1">"\" /f &amp; erase "</span> <span class="n">ascii</span> <span class="n">fullword</span>
        <span class="err">$</span><span class="n">s3</span>  <span class="err">=</span> <span class="s1">"/c taskkill /im \""</span> <span class="n">ascii</span> <span class="n">fullword</span>
        <span class="p">//</span> <span class="n">Anti</span> <span class="n">checks</span>
        <span class="err">$</span><span class="n">s4</span>  <span class="err">=</span> <span class="s1">" Far "</span> <span class="n">ascii</span> <span class="n">fullword</span>
        <span class="err">$</span><span class="n">s5</span>  <span class="err">=</span> <span class="s1">"roxifier"</span> <span class="n">ascii</span> <span class="n">fullword</span>
        <span class="err">$</span><span class="n">s6</span>  <span class="err">=</span> <span class="s1">"HTTP Analyzer"</span> <span class="n">ascii</span> <span class="n">fullword</span>
        <span class="err">$</span><span class="n">s7</span>  <span class="err">=</span> <span class="s1">"Wireshark"</span> <span class="n">ascii</span> <span class="n">fullword</span>
        <span class="err">$</span><span class="n">s8</span>  <span class="err">=</span> <span class="s1">"NetworkMiner"</span> <span class="n">ascii</span> <span class="n">fullword</span>
        <span class="p">//</span> <span class="n">HTTP</span> <span class="n">headers</span>
        <span class="err">$</span><span class="n">s9</span>  <span class="err">=</span> <span class="s1">"Accept-Language: ru-RU,ru;q=0.9,en;q=0.8"</span> <span class="n">ascii</span> <span class="n">fullword</span>
        <span class="err">$</span><span class="n">s10</span> <span class="err">=</span> <span class="s1">"Accept-Charset: iso-8859-1, utf-8, utf-16, *;q=0.1"</span> <span class="n">ascii</span> <span class="n">fullword</span>
        <span class="err">$</span><span class="n">s11</span> <span class="err">=</span> <span class="s1">"Accept-Encoding: deflate, gzip, x-gzip, identity, *;q=0"</span> <span class="n">ascii</span> <span class="n">fullword</span>
        <span class="err">$</span><span class="n">s12</span> <span class="err">=</span> <span class="s1">"Accept: text/html, application/xml;q=0.9, application/xhtml+xml, image/png, image/jpeg, image/gif, image/x-xbitmap, */*;q=0.1"</span> <span class="n">ascii</span> <span class="n">fullword</span>
    
    <span class="n">condition</span><span class="p">:</span>
        <span class="n">uint16</span><span class="p">(</span><span class="m">0</span><span class="p">)</span> <span class="err">==</span> <span class="m">0</span><span class="n">x5a4d</span> <span class="n">and</span>
        <span class="m">10</span> <span class="n">of</span> <span class="n">them</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="references">References</h1>

<ul>
  <li>
    <p><a href="https://medium.com/csis-techblog/gcleaner-garbage-provider-since-2019-2708e7c87a8a">https://medium.com/csis-techblog/gcleaner-garbage-provider-since-2019-2708e7c87a8a</a></p>
  </li>
  <li>
    <p><a href="https://medium.com/csis-techblog/inside-view-of-brazzzersff-infrastructure-89b9188fd145">https://medium.com/csis-techblog/inside-view-of-brazzzersff-infrastructure-89b9188fd145</a></p>
  </li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/pages/elbouzarazi/categories/#malware-analysis" class="page__taxonomy-item" rel="tag">Malware Analysis</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-07-15T00:00:00+01:00">July 15, 2023</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/pages/elbouzarazi/tutorials/dotnet-string-decryptor/" class="pagination--pager" title="Dotnet String Decryptor
">Previous</a>
    
    
      <a href="/pages/elbouzarazi/first%20blog/first-blog/" class="pagination--pager" title="first blog
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/pages/elbouzarazi/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 zakariae Elbouzarazi. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/pages/elbouzarazi/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/pages/elbouzarazi/assets/js/lunr/lunr.min.js"></script>
<script src="/pages/elbouzarazi/assets/js/lunr/lunr-store.js"></script>
<script src="/pages/elbouzarazi/assets/js/lunr/lunr-en.js"></script>




  <script>
  window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
  ga('create','UA-165194559-1','auto');
  ga('set', 'anonymizeIp', false);
  ga('send','pageview')
</script>
<script src="https://www.google-analytics.com/analytics.js" async></script>









  </body>
</html>
